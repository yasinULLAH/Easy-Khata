<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پاکستانی انوینٹری مینجمنٹ سسٹم - Pakistani Inventory System</title>
    <style>
        :root {
            --primary: #01411c;
            --secondary: #fff;
            --accent: #006600;
            --paper: #f9f7e8;
            --border: #d1c9a6;
            --text: #333;
            --danger: #b30000;
            --warning: #ff9900;
            --success: #006600;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        
        header {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 1rem;
            text-align: center;
            border-bottom: 5px double var(--secondary);
        }
        
        header h1 {
            margin-bottom: 5px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        header p {
            font-style: italic;
            font-size: 0.9rem;
        }
        
        nav {
            background-color: var(--secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            list-style: none;
        }
        
        .nav-tabs li {
            margin: 0;
        }
        
        .nav-tabs button {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            border-right: 1px solid var(--border);
            background: #f5f5f5;
        }
        
        .nav-tabs button.active {
            background-color: var(--paper);
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: var(--paper);
            border: 1px solid var(--border);
            border-top: none;
            min-height: 70vh;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .paper-form {
            background-color: var(--paper);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .paper-form::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);
            background-size: 4px 4px;
            opacity: 0.3;
            pointer-events: none;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            background-color: var(--secondary);
            border-radius: 3px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 8px 15px;
            font-size: 1rem;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 3px;
            transition: all 0.3s;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--secondary);
        }
        
        .btn-primary:hover {
            background-color: #023e1a;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: var(--secondary);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: var(--secondary);
        }
        
        .btn-success {
            background-color: var(--success);
            color: var(--secondary);
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: var(--secondary);
        }
        
        th, td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary);
            color: var(--secondary);
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .alert {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 3px;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid var(--warning);
            color: #856404;
        }
        
        .alert-success {
            background-color: #d4edda;
            border: 1px solid var(--success);
            color: #155724;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .search-container input, .search-container select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        
        .search-container input {
            flex: 1;
            min-width: 200px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
        }
        
        .badge-danger {
            background-color: var(--danger);
        }
        
        .badge-success {
            background-color: var(--success);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: var(--paper);
            margin: 0% auto;
            padding: 20px;
            border: 1px solid var(--border);
            width: 80%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white;
            }
            
            .container {
                width: 100%;
                max-width: 100%;
                padding: 0;
            }
            
            .paper-form, .tab-content {
                border: none;
                box-shadow: none;
                padding: 0;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            @page {
                size: A4;
                margin: 1cm;
            }
        }
        
        .urdu {
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', 'Urdu Typesetting', serif;
            direction: rtl;
        }
        
        .language-toggle {
            position: absolute;
            top: 5px;
            right: 10px;
            padding: 5px 10px;
            font-size: 0.8rem;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .stock-movement {
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--secondary);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background-color: var(--secondary);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-card h3 {
            margin-bottom: 10px;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }
        
        footer {
            text-align: center;
            padding: 10px;
            background-color: var(--primary);
            color: var(--secondary);
            font-size: 0.8rem;
            margin-top: 20px;
        }
        
        /* Receipt Styles */
        .receipt {
            font-family: 'Courier New', monospace;
            border: 1px dashed var(--border);
            padding: 20px;
            background-color: white;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .receipt-header {
            text-align: center;
            border-bottom: 2px dotted var(--border);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .receipt-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .receipt-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            border-bottom: 1px dotted var(--border);
            padding-bottom: 5px;
        }
        
        .receipt-table {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .receipt-table th {
            background-color: #f0f0f0;
            color: var(--text);
        }
        
        .receipt-footer {
            text-align: center;
            border-top: 2px dotted var(--border);
            padding-top: 10px;
            font-style: italic;
        }
        
        .hidden {
            display: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            list-style: none;
            margin: 20px 0;
        }
        
        .pagination li {
            margin: 0 5px;
        }
        
        .pagination button {
            padding: 5px 10px;
            border: 1px solid var(--border);
            background-color: var(--secondary);
            cursor: pointer;
        }
        
        .pagination button.active {
            background-color: var(--primary);
            color: var(--secondary);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .loading:after {
            content: "...";
            animation: dots 1s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }
    </style>
</head>
<body>
    <header>
        <h1>پاکستانی انوینٹری مینجمنٹ سسٹم</h1>
        <p>Pakistani Inventory Management System</p>
        <button class="language-toggle" id="languageToggle">English / اردو</button>
    </header>
    
    <nav class="no-print">
        <ul class="nav-tabs">
            <li><button class="tab-link active" data-tab="dashboard">Dashboard</button></li>
            <li><button class="tab-link" data-tab="inventory">Inventory</button></li>
            <li><button class="tab-link" data-tab="transactions">Transactions</button></li>
            <li><button class="tab-link" data-tab="reports">Reports</button></li>
            <li><button class="tab-link" data-tab="settings">Settings</button></li>
        </ul>
    </nav>
    
    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card" id="totalProducts">
                    <h3>Total Products</h3>
                    <p class="loading">Loading</p>
                </div>
                <div class="dashboard-card" id="lowStockItems">
                    <h3>Low Stock Items</h3>
                    <p class="loading">Loading</p>
                </div>
                <div class="dashboard-card" id="totalValue">
                    <h3>Total Inventory Value</h3>
                    <p class="loading">Loading</p>
                </div>
                <div class="dashboard-card" id="recentSales">
                    <h3>Recent Sales</h3>
                    <p class="loading">Loading</p>
                </div>
            </div>
            
            <div class="paper-form">
                <h3>Low Stock Alerts</h3>
                <div id="lowStockAlerts">
                    <p class="loading">Loading low stock items</p>
                </div>
            </div>
            
            <div class="paper-form">
                <h3>Recent Activity</h3>
                <div id="recentActivity">
                    <p class="loading">Loading recent activity</p>
                </div>
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>Inventory Management</h2>
            
            <div class="paper-form no-print">
                <h3>Add New Product</h3>
                <form id="addProductForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productName">Product Name:</label>
                            <input type="text" id="productName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="category">Category:</label>
                            <select id="category" class="form-control" required>
                                <option value="">Select Category</option>
                                <option value="Grocery">Grocery</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Clothing">Clothing</option>
                                <option value="Stationery">Stationery</option>
                                <option value="Household">Household</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="barcode">Barcode:</label>
                            <input type="text" id="barcode" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice">Purchase Price (Rs):</label>
                            <input type="number" id="purchasePrice" class="form-control" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="salePrice">Sale Price (Rs):</label>
                            <input type="number" id="salePrice" class="form-control" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Initial Quantity:</label>
                            <input type="number" id="quantity" class="form-control" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="lowStockThreshold">Low Stock Alert:</label>
                            <input type="number" id="lowStockThreshold" class="form-control" min="0" value="5">
                        </div>
                        <div class="form-group">
                            <label for="supplier">Supplier:</label>
                            <input type="text" id="supplier" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" class="form-control" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                    <button type="reset" class="btn btn-secondary">Clear</button>
                </form>
            </div>
            
            <div class="paper-form">
                <h3>Product Inventory</h3>
                
                <div class="search-container no-print">
                    <input type="text" id="searchInventory" class="form-control" placeholder="Search products...">
                    <select id="categoryFilter" class="form-control">
                        <option value="">All Categories</option>
                        <option value="Grocery">Grocery</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Stationery">Stationery</option>
                        <option value="Household">Household</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="sortInventory" class="form-control">
                        <option value="name">Sort by Name</option>
                        <option value="category">Sort by Category</option>
                        <option value="quantity-asc">Sort by Quantity (Low to High)</option>
                        <option value="quantity-desc">Sort by Quantity (High to Low)</option>
                        <option value="price-asc">Sort by Price (Low to High)</option>
                        <option value="price-desc">Sort by Price (High to Low)</option>
                    </select>
                    <button id="printInventory" class="btn btn-primary no-print">Print</button>
                    <button id="exportInventory" class="btn btn-primary no-print">Export CSV</button>
                </div>
                
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Purchase Price</th>
                                <th>Sale Price</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr>
                                <td colspan="7" class="loading">Loading inventory</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="inventoryPagination" class="pagination no-print"></div>
            </div>
        </div>
        
        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <h2>Stock Transactions</h2>
            
            <div class="paper-form no-print">
                <h3>New Transaction</h3>
                <form id="addTransactionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="transactionProduct">Product:</label>
                            <select id="transactionProduct" class="form-control" required>
                                <option value="">Select Product</option>
                                <!-- Products will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionType">Transaction Type:</label>
                            <select id="transactionType" class="form-control" required>
                                <option value="in">Stock In</option>
                                <option value="out">Stock Out</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionQuantity">Quantity:</label>
                            <input type="number" id="transactionQuantity" class="form-control" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">Date:</label>
                            <input type="date" id="transactionDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="transactionNotes">Notes:</label>
                        <textarea id="transactionNotes" class="form-control" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                    <button type="reset" class="btn btn-secondary">Clear</button>
                </form>
            </div>
            
            <div class="paper-form">
                <h3>Transaction History</h3>
                
                <div class="search-container no-print">
                    <input type="text" id="searchTransactions" class="form-control" placeholder="Search transactions...">
                    <select id="transactionTypeFilter" class="form-control">
                        <option value="">All Types</option>
                        <option value="in">Stock In</option>
                        <option value="out">Stock Out</option>
                    </select>
                    <button id="printTransactions" class="btn btn-primary">Print</button>
                    <button id="exportTransactions" class="btn btn-primary">Export CSV</button>
                </div>
                
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Notes</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="6" class="loading">Loading transactions</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="transactionsPagination" class="pagination no-print"></div>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Reports</h2>
            
            <div class="paper-form">
                <h3>Generate Report</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reportType">Report Type:</label>
                        <select id="reportType" class="form-control">
                            <option value="inventory">Current Inventory</option>
                            <option value="lowStock">Low Stock Items</option>
                            <option value="transactions">Transaction History</option>
                            <option value="sales">Sales Report</option>
                            <option value="purchases">Purchases Report</option>
                            <option value="profit">Profit Analysis</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateRangeStart">Start Date:</label>
                        <input type="date" id="dateRangeStart" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="dateRangeEnd">End Date:</label>
                        <input type="date" id="dateRangeEnd" class="form-control">
                    </div>
                </div>
                
                <button id="generateReport" class="btn btn-primary">Generate Report</button>
                <button id="printReport" class="btn btn-primary">Print Report</button>
                <button id="exportReportCSV" class="btn btn-primary">Export CSV</button>
            </div>
            
            <div class="paper-form" id="reportOutput">
                <h3 id="reportTitle">Report</h3>
                <div id="reportContent">
                    <p>Select report type and date range to generate a report.</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>Settings</h2>
            
            <div class="paper-form">
                <h3>Business Information</h3>
                <form id="businessInfoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="businessName">Business Name:</label>
                            <input type="text" id="businessName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="businessOwner">Owner Name:</label>
                            <input type="text" id="businessOwner" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="businessPhone">Phone Number:</label>
                            <input type="text" id="businessPhone" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="businessAddress">Address:</label>
                            <textarea id="businessAddress" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Information</button>
                </form>
            </div>
            
            <div class="paper-form">
                <h3>Categories Management</h3>
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label for="newCategory">Add New Category:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="newCategory" class="form-control">
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </div>
                </form>
                
                <div id="categoriesList">
                    <p class="loading">Loading categories</p>
                </div>
            </div>
            
            <div class="paper-form">
                <h3>Data Management</h3>
                <div class="form-group">
                    <button id="backupData" class="btn btn-primary">Backup Data</button>
                    <button id="restoreData" class="btn btn-primary">Restore Data</button>
                    <input type="file" id="restoreFile" style="display: none;">
                </div>
                <div class="form-group">
                    <button id="clearData" class="btn btn-danger">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Edit Modal -->
    <div class="modal" id="editProductModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Edit Product</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editProductName">Product Name:</label>
                        <input type="text" id="editProductName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category:</label>
                        <select id="editCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBarcode">Barcode:</label>
                        <input type="text" id="editBarcode" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editPurchasePrice">Purchase Price (Rs):</label>
                        <input type="number" id="editPurchasePrice" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editSalePrice">Sale Price (Rs):</label>
                        <input type="number" id="editSalePrice" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editLowStockThreshold">Low Stock Alert:</label>
                        <input type="number" id="editLowStockThreshold" class="form-control" min="0" value="5">
                    </div>
                    <div class="form-group">
                        <label for="editSupplier">Supplier:</label>
                        <input type="text" id="editSupplier" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editNotes">Notes:</label>
                    <textarea id="editNotes" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Product</button>
            </form>
        </div>
    </div>
    
    <!-- Transaction Edit Modal -->
    <div class="modal" id="editTransactionModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Edit Transaction</h2>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editTransactionProduct">Product:</label>
                        <select id="editTransactionProduct" class="form-control" required disabled>
                            <!-- Products will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTransactionType">Transaction Type:</label>
                        <select id="editTransactionType" class="form-control" required disabled>
                            <option value="in">Stock In</option>
                            <option value="out">Stock Out</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTransactionQuantity">Quantity:</label>
                        <input type="number" id="editTransactionQuantity" class="form-control" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="editTransactionDate">Date:</label>
                        <input type="date" id="editTransactionDate" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editTransactionNotes">Notes:</label>
                    <textarea id="editTransactionNotes" class="form-control" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Transaction</button>
            </form>
        </div>
    </div>
    
    <!-- Receipt Print Template -->
    <div class="receipt hidden" id="receiptTemplate">
        <div class="receipt-header">
            <div class="receipt-title" id="receiptBusinessName">Business Name</div>
            <div id="receiptBusinessAddress">Business Address</div>
            <div id="receiptBusinessPhone">Phone: 123-456-7890</div>
        </div>
        <div class="receipt-info">
            <div>Date: <span id="receiptDate"></span></div>
            <div>Receipt #: <span id="receiptNumber"></span></div>
        </div>
        <div id="receiptContent"></div>
        <div class="receipt-footer">
            Thank you for your business! / آپ کے کاروبار کا شکریہ!
        </div>
    </div>
    
    <div id="csvDownloadLink" style="display: none;"></div>
    
    <footer class="no-print">
        &copy; 2025 Pakistani Inventory Management System - Designed for small businesses
    </footer>
    
    <script>
        // Database Initialization
        let db;
        const DB_NAME = 'pakistaniInventoryDB';
        const DB_VERSION = 1;
        
        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = event => {
                    console.error('Error opening database:', event.target.error);
                    reject('Could not open database');
                };
                
                request.onsuccess = event => {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    
                    // Create Products store
                    if (!db.objectStoreNames.contains('products')) {
                        const productsStore = db.createObjectStore('products', { keyPath: 'id', autoIncrement: true });
                        productsStore.createIndex('name', 'name', { unique: false });
                        productsStore.createIndex('category', 'category', { unique: false });
                        productsStore.createIndex('barcode', 'barcode', { unique: false });
                    }
                    
                    // Create Transactions store
                    if (!db.objectStoreNames.contains('transactions')) {
                        const transactionsStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionsStore.createIndex('productId', 'productId', { unique: false });
                        transactionsStore.createIndex('date', 'date', { unique: false });
                        transactionsStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    // Create Categories store
                    if (!db.objectStoreNames.contains('categories')) {
                        const categoriesStore = db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                        categoriesStore.createIndex('name', 'name', { unique: true });
                        
                        // Add default categories
                        const categories = [
                            { name: 'Grocery' },
                            { name: 'Electronics' },
                            { name: 'Clothing' },
                            { name: 'Stationery' },
                            { name: 'Household' },
                            { name: 'Other' }
                        ];
                        
                        categories.forEach(category => {
                            categoriesStore.add(category);
                        });
                    }
                    
                    // Create Settings store
                    if (!db.objectStoreNames.contains('settings')) {
                        const settingsStore = db.createObjectStore('settings', { keyPath: 'id' });
                        
                        // Add default settings
                        settingsStore.add({
                            id: 'businessInfo',
                            name: 'My Pakistani Store',
                            owner: 'Store Owner',
                            phone: '0300-1234567',
                            address: 'Shop #123, Main Bazaar, Lahore, Pakistan'
                        });
                    }
                };
            });
        }
                function displayTransactions(transactions, productMap) {
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = '';

            // Ensure transactions is an array before proceeding
            if (!Array.isArray(transactions)) {
                 console.error("displayTransactions received non-array:", transactions);
                 const row = document.createElement('tr');
                 const cell = document.createElement('td');
                 cell.colSpan = 6;
                 cell.textContent = 'Error loading transactions data.';
                 cell.style.color = 'red';
                 row.appendChild(cell);
                 tableBody.appendChild(row);
                 return;
            }

            if (transactions.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.textContent = 'No transactions found';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            transactions.forEach(transaction => {
                const row = document.createElement('tr');

                // Date
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(transaction.date);
                row.appendChild(dateCell);

                // Product
                const productCell = document.createElement('td');
                // Use optional chaining ?. incase productMap[id] is undefined
                productCell.textContent = productMap?.[transaction.productId] || 'Unknown Product';
                row.appendChild(productCell);

                // Type
                const typeCell = document.createElement('td');
                typeCell.textContent = transaction.type === 'in' ? 'Stock In' : 'Stock Out';
                typeCell.style.color = transaction.type === 'in' ? 'var(--success)' : 'var(--danger)';
                row.appendChild(typeCell);

                // Quantity
                const quantityCell = document.createElement('td');
                quantityCell.textContent = transaction.quantity;
                row.appendChild(quantityCell);

                // Notes
                const notesCell = document.createElement('td');
                notesCell.textContent = transaction.notes || '-';
                row.appendChild(notesCell);

                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'action-buttons no-print';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary btn-sm';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editTransaction(transaction.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteTransaction(transaction.id);
                actionsCell.appendChild(deleteBtn);

                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });
        }
		 function updateDashboard() {
            Promise.all([
                dbOperations.getProducts(),
                dbOperations.getTransactions()
            ]).then(([productsData, transactionsData]) => {

                // **Crucial Check**: Ensure both productsData and transactionsData are arrays
                const products = Array.isArray(productsData) ? productsData : [];
                const transactions = Array.isArray(transactionsData) ? transactionsData : [];

                if (!Array.isArray(productsData)) {
                    console.warn("updateDashboard: productsData was not an array", productsData);
                }
                 if (!Array.isArray(transactionsData)) {
                    console.warn("updateDashboard: transactionsData was not an array", transactionsData);
                }

                // --- Dashboard Card Updates ---
                const totalProductsCard = document.getElementById('totalProducts');
                totalProductsCard.innerHTML = `<h3>Total Products</h3><p>${products.length}</p>`;

                const lowStockProducts = products.filter(p => p.quantity > 0 && p.quantity <= p.lowStockThreshold);
                const lowStockItemsCard = document.getElementById('lowStockItems');
                lowStockItemsCard.innerHTML = `<h3>Low Stock Items</h3><p>${lowStockProducts.length}</p>`;

                const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.salePrice), 0);
                const totalValueCard = document.getElementById('totalValue');
                totalValueCard.innerHTML = `<h3>Total Inventory Value</h3><p>${formatCurrency(totalValue)}</p>`;

                const recentSales = transactions.filter(t => t.type === 'out').slice(0, 5); // Show last 5 sales
                const recentSalesCard = document.getElementById('recentSales');
                recentSalesCard.innerHTML = '<h3>Recent Sales</h3>';
                if (recentSales.length > 0) {
                    const list = document.createElement('ul');
                    list.style.listStyle = 'none';
                    list.style.paddingLeft = '0';
                    // Build product map for quick lookup inside the loop
                    const productMap = products.reduce((map, p) => { map[p.id] = p; return map; }, {});
                    recentSales.forEach(sale => {
                        // Use optional chaining ?. here as well
                        const product = productMap?.[sale.productId];
                        const li = document.createElement('li');
                        li.textContent = `${product ? product.name : 'Unknown'} (${sale.quantity}) - ${formatDate(sale.date)}`;
                        li.style.fontSize = '0.9em';
                        list.appendChild(li);
                    });
                    recentSalesCard.appendChild(list);
                } else {
                    recentSalesCard.innerHTML += '<p>No recent sales</p>';
                }

                // --- Paper Form Updates ---
                const lowStockAlertsDiv = document.getElementById('lowStockAlerts');
                lowStockAlertsDiv.innerHTML = ''; // Clear previous content
                if (lowStockProducts.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th>Product</th><th>Quantity</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    lowStockProducts.forEach(p => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = p.name;
                        row.insertCell().textContent = p.quantity;
                    });
                    table.appendChild(tbody);
                    lowStockAlertsDiv.appendChild(table);
                } else {
                    lowStockAlertsDiv.innerHTML = '<p>No items currently low on stock.</p>';
                }

                const recentActivityDiv = document.getElementById('recentActivity');
                recentActivityDiv.innerHTML = ''; // Clear previous content
                const recentTransactions = transactions.slice(0, 10); // Show last 10 transactions
                if (recentTransactions.length > 0) {
                    const list = document.createElement('ul');
                    list.style.listStyle = 'none';
                    list.style.paddingLeft = '0';
                    // Rebuild product map if not already done
                    const productMap = products.reduce((map, p) => { map[p.id] = p; return map; }, {});
                    recentTransactions.forEach(t => {
                        const product = productMap?.[t.productId];
                        const li = document.createElement('li');
                        const typeText = t.type === 'in' ? 'Stocked In' : 'Sold';
                        const color = t.type === 'in' ? 'var(--success)' : 'var(--danger)';
                        li.innerHTML = `<span style="color: ${color};">${typeText}</span>: ${t.quantity} x ${product ? product.name : 'Unknown'} on ${formatDate(t.date)}`;
                        li.style.fontSize = '0.9em';
                        li.style.borderBottom = '1px dashed #eee';
                        li.style.padding = '3px 0';
                        list.appendChild(li);
                    });
                    recentActivityDiv.appendChild(list);
                } else {
                    recentActivityDiv.innerHTML = '<p>No recent activity.</p>';
                }

            }).catch(error => {
                console.error('Error updating dashboard:', error);
                // Display errors on the dashboard cards for feedback
                document.getElementById('totalProducts').innerHTML = '<h3>Total Products</h3><p>Error</p>';
                document.getElementById('lowStockItems').innerHTML = '<h3>Low Stock Items</h3><p>Error</p>';
                document.getElementById('totalValue').innerHTML = '<h3>Total Inventory Value</h3><p>Error</p>';
                document.getElementById('recentSales').innerHTML = '<h3>Recent Sales</h3><p>Error</p>';
                document.getElementById('lowStockAlerts').innerHTML = '<p class="alert alert-warning">Error loading low stock items.</p>';
                document.getElementById('recentActivity').innerHTML = '<p class="alert alert-warning">Error loading recent activity.</p>';
            });
        }
        // Database CRUD Operations
        const dbOperations = {
            // Products
            addProduct(product) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    
                    // Add creation date
                    product.createdAt = new Date().toISOString();
                    product.updatedAt = new Date().toISOString();
                    
                    const request = store.add(product);
                    
                    request.onsuccess = event => {
                        const productId = event.target.result;
                        
                        // If initial quantity > 0, create a stock-in transaction
                        if (product.quantity > 0) {
                            const stockInTransaction = {
                                productId,
                                type: 'in',
                                quantity: product.quantity,
                                date: new Date().toISOString(),
                                notes: 'Initial stock'
                            };
                            
                            this.addTransaction(stockInTransaction)
                                .then(() => resolve(productId))
                                .catch(error => reject(error));
                        } else {
                            resolve(productId);
                        }
                    };
                    
                    request.onerror = event => {
                        reject('Error adding product: ' + event.target.error);
                    };
                });
            },
            
            getProducts() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.getAll();
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting products: ' + event.target.error);
                    };
                });
            },
            
            getProduct(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['products'], 'readonly');
                    const store = transaction.objectStore('products');
                    const request = store.get(id);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting product: ' + event.target.error);
                    };
                });
            },
            
            updateProduct(product) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['products'], 'readwrite');
                    const store = transaction.objectStore('products');
                    
                    // Update timestamp
                    product.updatedAt = new Date().toISOString();
                    
                    const request = store.put(product);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error updating product: ' + event.target.error);
                    };
                });
            },
            
            deleteProduct(id) {
                return new Promise((resolve, reject) => {
                    // First check if there are any transactions for this product
                    this.getTransactionsByProductId(id)
                        .then(transactions => {
                            if (transactions.length > 0) {
                                reject('Cannot delete product with existing transactions');
                            } else {
                                const transaction = db.transaction(['products'], 'readwrite');
                                const store = transaction.objectStore('products');
                                const request = store.delete(id);
                                
                                request.onsuccess = event => {
                                    resolve();
                                };
                                
                                request.onerror = event => {
                                    reject('Error deleting product: ' + event.target.error);
                                };
                            }
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            },
            
            // Transactions
            addTransaction(transaction) {
                return new Promise((resolve, reject) => {
                    // First get the product
                    this.getProduct(transaction.productId)
                        .then(product => {
                            if (!product) {
                                reject('Product not found');
                                return;
                            }
                            
                            const newQuantity = transaction.type === 'in' 
                                ? product.quantity + transaction.quantity 
                                : product.quantity - transaction.quantity;
                                
                            if (transaction.type === 'out' && newQuantity < 0) {
                                reject('Not enough stock');
                                return;
                            }
                            
                            // Add timestamp
                            transaction.createdAt = new Date().toISOString();
                            
                            // Update product quantity
                            product.quantity = newQuantity;
                            
                            const productUpdatePromise = this.updateProduct(product);
                            
                            // Add the transaction
                            const transactionDb = db.transaction(['transactions'], 'readwrite');
                            const store = transactionDb.objectStore('transactions');
                            const request = store.add(transaction);
                            
                            request.onsuccess = event => {
                                productUpdatePromise
                                    .then(() => resolve(event.target.result))
                                    .catch(error => reject(error));
                            };
                            
                            request.onerror = event => {
                                reject('Error adding transaction: ' + event.target.error);
                            };
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            },
            
            getTransactions() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['transactions'], 'readonly');
                    const store = transaction.objectStore('transactions');
                    const request = store.getAll();
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting transactions: ' + event.target.error);
                    };
                });
            },
            
            getTransaction(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['transactions'], 'readonly');
                    const store = transaction.objectStore('transactions');
                    const request = store.get(id);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting transaction: ' + event.target.error);
                    };
                });
            },
            
            getTransactionsByProductId(productId) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['transactions'], 'readonly');
                    const store = transaction.objectStore('transactions');
                    const index = store.index('productId');
                    const request = index.getAll(productId);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting transactions by product: ' + event.target.error);
                    };
                });
            },
            
            updateTransaction(transaction) {
                return new Promise((resolve, reject) => {
                    // Get the original transaction
                    this.getTransaction(transaction.id)
                        .then(origTransaction => {
                            if (!origTransaction) {
                                reject('Transaction not found');
                                return;
                            }
                            
                            // Get the product
                            this.getProduct(origTransaction.productId)
                                .then(product => {
                                    if (!product) {
                                        reject('Product not found');
                                        return;
                                    }
                                    
                                    // Calculate the quantity difference
                                    let quantityDiff = transaction.quantity - origTransaction.quantity;
                                    
                                    // Apply the quantity difference to the product
                                    let newQuantity;
                                    if (origTransaction.type === 'in') {
                                        newQuantity = product.quantity + quantityDiff;
                                    } else { // type === 'out'
                                        newQuantity = product.quantity - quantityDiff;
                                    }
                                    
                                    if (newQuantity < 0) {
                                        reject('Not enough stock');
                                        return;
                                    }
                                    
                                    // Update product quantity
                                    product.quantity = newQuantity;
                                    
                                    const productUpdatePromise = this.updateProduct(product);
                                    
                                    // Update the transaction
                                    const transactionDb = db.transaction(['transactions'], 'readwrite');
                                    const store = transactionDb.objectStore('transactions');
                                    
                                    // Keep the same type and productId, update other fields
                                    origTransaction.quantity = transaction.quantity;
                                    origTransaction.date = transaction.date;
                                    origTransaction.notes = transaction.notes;
                                    
                                    const request = store.put(origTransaction);
                                    
                                    request.onsuccess = event => {
                                        productUpdatePromise
                                            .then(() => resolve(event.target.result))
                                            .catch(error => reject(error));
                                    };
                                    
                                    request.onerror = event => {
                                        reject('Error updating transaction: ' + event.target.error);
                                    };
                                })
                                .catch(error => {
                                    reject(error);
                                });
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            },
            
            deleteTransaction(id) {
                return new Promise((resolve, reject) => {
                    // Get the transaction to be deleted
                    this.getTransaction(id)
                        .then(transaction => {
                            if (!transaction) {
                                reject('Transaction not found');
                                return;
                            }
                            
                            // Get the product
                            this.getProduct(transaction.productId)
                                .then(product => {
                                    if (!product) {
                                        reject('Product not found');
                                        return;
                                    }
                                    
                                    // Update product quantity
                                    let newQuantity;
                                    if (transaction.type === 'in') {
                                        newQuantity = product.quantity - transaction.quantity;
                                    } else { // type === 'out'
                                        newQuantity = product.quantity + transaction.quantity;
                                    }
                                    
                                    if (newQuantity < 0) {
                                        reject('Cannot delete transaction. It would result in negative stock.');
                                        return;
                                    }
                                    
                                    // Update product quantity
                                    product.quantity = newQuantity;
                                    
                                    const productUpdatePromise = this.updateProduct(product);
                                    
                                    // Delete the transaction
                                    const transactionDb = db.transaction(['transactions'], 'readwrite');
                                    const store = transactionDb.objectStore('transactions');
                                    const request = store.delete(id);
                                    
                                    request.onsuccess = event => {
                                        productUpdatePromise
                                            .then(() => resolve())
                                            .catch(error => reject(error));
                                    };
                                    
                                    request.onerror = event => {
                                        reject('Error deleting transaction: ' + event.target.error);
                                    };
                                })
                                .catch(error => {
                                    reject(error);
                                });
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            },
            
            // Categories
            getCategories() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['categories'], 'readonly');
                    const store = transaction.objectStore('categories');
                    const request = store.getAll();
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting categories: ' + event.target.error);
                    };
                });
            },
            
            addCategory(category) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.add(category);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error adding category: ' + event.target.error);
                    };
                });
            },
            
            deleteCategory(id) {
                return new Promise((resolve, reject) => {
                    // Check if any products use this category
                    this.getProducts()
                        .then(products => {
                            const usedCategory = products.some(p => p.category === id);
                            if (usedCategory) {
                                reject('Cannot delete category that is in use');
                            } else {
                                const transaction = db.transaction(['categories'], 'readwrite');
                                const store = transaction.objectStore('categories');
                                const request = store.delete(id);
                                
                                request.onsuccess = event => {
                                    resolve();
                                };
                                
                                request.onerror = event => {
                                    reject('Error deleting category: ' + event.target.error);
                                };
                            }
                        })
                        .catch(error => {
                            reject(error);
                        });
                });
            },
            
            // Settings
            getSettings(id) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get(id);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error getting settings: ' + event.target.error);
                    };
                });
            },
            
            updateSettings(settings) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    const request = store.put(settings);
                    
                    request.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    
                    request.onerror = event => {
                        reject('Error updating settings: ' + event.target.error);
                    };
                });
            }
        };
        
        // UI Functions
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Find an appropriate place to show the alert
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(alertDiv, activeTab.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-PK', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-PK', {
                style: 'currency',
                currency: 'PKR',
                minimumFractionDigits: 2
            }).format(amount);
        }
        
        function loadCategories() {
            const categorySelects = document.querySelectorAll('#category, #editCategory');
            
            dbOperations.getCategories()
                .then(categories => {
                    // Clear existing options, keeping only the first one (placeholder)
                    categorySelects.forEach(select => {
                        while (select.options.length > 1) {
                            select.remove(1);
                        }
                        
                        // Add categories
                        categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.name;
                            option.textContent = category.name;
                            select.appendChild(option);
                        });
                    });
                    
                    // Also update the categories list in settings
                    const categoriesList = document.getElementById('categoriesList');
                    categoriesList.innerHTML = '';
                    
                    if (categories.length === 0) {
                        categoriesList.innerHTML = '<p>No categories found</p>';
                    } else {
                        const ul = document.createElement('ul');
                        ul.className = 'categories-list';
                        
                        categories.forEach(category => {
                            const li = document.createElement('li');
                            li.style.display = 'flex';
                            li.style.justifyContent = 'space-between';
                            li.style.alignItems = 'center';
                            li.style.marginBottom = '5px';
                            li.style.padding = '5px';
                            li.style.borderBottom = '1px solid #eee';
                            
                            const span = document.createElement('span');
                            span.textContent = category.name;
                            li.appendChild(span);
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn btn-danger btn-sm';
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.onclick = () => deleteCategory(category.id);
                            li.appendChild(deleteBtn);
                            
                            ul.appendChild(li);
                        });
                        
                        categoriesList.appendChild(ul);
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    showAlert('Error loading categories: ' + error, 'warning');
                });
        }
        
        function loadProducts() {
            dbOperations.getProducts()
                .then(products => {
                    // Update product dropdown in transaction form
                    const productSelect = document.getElementById('transactionProduct');
                    const editProductSelect = document.getElementById('editTransactionProduct');
                    
                    // Clear existing options
                    while (productSelect.options.length > 1) {
                        productSelect.remove(1);
                    }
                    
                    while (editProductSelect.options.length > 0) {
                        editProductSelect.remove(0);
                    }
                    
                    // Add products
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = product.name;
                        productSelect.appendChild(option.cloneNode(true));
                        editProductSelect.appendChild(option);
                    });
                    
                    // Update product table
                    displayInventory(products);
                    
                    // Update dashboard counts
                    updateDashboard();
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    showAlert('Error loading products: ' + error, 'warning');
                });
        }
        
        function loadTransactions() {
            Promise.all([dbOperations.getTransactions(), dbOperations.getProducts()])
                .then(([transactions, products]) => {
                    // Create a map of product IDs to product names for quick lookup
                    const productMap = {};
                    products.forEach(product => {
                        productMap[product.id] = product.name;
                    });
                    
                    // Sort transactions by date, newest first
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    displayTransactions(transactions, productMap);
                })
                .catch(error => {
                    console.error('Error loading transactions:', error);
                    showAlert('Error loading transactions: ' + error, 'warning');
                });
        }
        
function displayInventory(products, filter = '', category = '', sort = 'name') {
            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = ''; // Clear previous content first

            // **Crucial Check**: Ensure the input 'products' is an array
            if (!Array.isArray(products)) {
                console.error("displayInventory received non-array:", products);
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7; // Span all columns
                cell.textContent = 'Error: Could not load inventory data.';
                cell.style.color = 'red';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return; // Stop the function if data is invalid
            }

            // --- Filtering ---
            let filteredProducts = products;
            if (filter) {
                const searchTerm = filter.toLowerCase();
                filteredProducts = filteredProducts.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.barcode?.toLowerCase().includes(searchTerm) ||
                    product.supplier?.toLowerCase().includes(searchTerm) ||
                    product.notes?.toLowerCase().includes(searchTerm)
                );
            }
            if (category) {
                filteredProducts = filteredProducts.filter(product =>
                    product.category === category
                );
            }

            // --- Sorting ---
            filteredProducts.sort((a, b) => {
                switch (sort) {
                    case 'name': return a.name.localeCompare(b.name);
                    case 'category': return a.category.localeCompare(b.category);
                    case 'quantity-asc': return a.quantity - b.quantity;
                    case 'quantity-desc': return b.quantity - a.quantity;
                    case 'price-asc': return a.salePrice - b.salePrice;
                    case 'price-desc': return b.salePrice - a.salePrice;
                    default: return 0;
                }
            });

            // --- Displaying ---
            if (filteredProducts.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.textContent = 'No products found matching criteria';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            // This loop should now be safe because we checked 'products' is an array
            // and filtering/sorting standard array methods also return arrays.
            filteredProducts.forEach(product => {
                const row = document.createElement('tr');

                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = product.name;
                row.appendChild(nameCell);

                // Category
                const categoryCell = document.createElement('td');
                categoryCell.textContent = product.category;
                row.appendChild(categoryCell);

                // Purchase Price
                const purchasePriceCell = document.createElement('td');
                purchasePriceCell.textContent = formatCurrency(product.purchasePrice);
                row.appendChild(purchasePriceCell);

                // Sale Price
                const salePriceCell = document.createElement('td');
                salePriceCell.textContent = formatCurrency(product.salePrice);
                row.appendChild(salePriceCell);

                // Quantity
                const quantityCell = document.createElement('td');
                quantityCell.textContent = product.quantity;
                row.appendChild(quantityCell);

                // Status
                const statusCell = document.createElement('td');
                if (product.quantity <= 0) {
                    statusCell.innerHTML = '<span class="badge badge-danger">Out of Stock</span>';
                } else if (product.quantity <= product.lowStockThreshold) {
                    statusCell.innerHTML = '<span class="badge badge-warning">Low Stock</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge badge-success">In Stock</span>';
                }
                row.appendChild(statusCell);

                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'action-buttons no-print';

                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-secondary btn-sm';
                viewBtn.textContent = 'View';
                viewBtn.onclick = () => viewProduct(product.id);
                actionsCell.appendChild(viewBtn);

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-primary btn-sm';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editProduct(product.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteProduct(product.id);
                actionsCell.appendChild(deleteBtn);

                row.appendChild(actionsCell);

                tableBody.appendChild(row);
            });
        }
 
         function viewProduct(id) {
             dbOperations.getProduct(id).then(product => {
                 // For simplicity, reusing the edit modal structure for viewing
                 // In a real app, you might create a separate view modal or section
                 editProduct(id, true); // Pass a flag to indicate view-only
             }).catch(error => {
                 console.error('Error viewing product:', error);
                 showAlert('Error viewing product: ' + error, 'warning');
             });
         }
 
         function editProduct(id, viewOnly = false) {
             dbOperations.getProduct(id).then(product => {
                 document.getElementById('editProductId').value = product.id;
                 document.getElementById('editProductName').value = product.name;
                 document.getElementById('editCategory').value = product.category;
                 document.getElementById('editBarcode').value = product.barcode || '';
                 document.getElementById('editPurchasePrice').value = product.purchasePrice;
                 document.getElementById('editSalePrice').value = product.salePrice;
                 document.getElementById('editLowStockThreshold').value = product.lowStockThreshold;
                 document.getElementById('editSupplier').value = product.supplier || '';
                 document.getElementById('editNotes').value = product.notes || '';
 
                 const modal = document.getElementById('editProductModal');
                 const submitButton = modal.querySelector('button[type="submit"]');
                 const formElements = modal.querySelectorAll('input, select, textarea');
 
                 if (viewOnly) {
                     modal.querySelector('h2').textContent = 'View Product';
                     submitButton.style.display = 'none';
                     formElements.forEach(el => el.disabled = true);
                 } else {
                     modal.querySelector('h2').textContent = 'Edit Product';
                     submitButton.style.display = 'inline-block';
                     formElements.forEach(el => el.disabled = false);
                 }
 
                 modal.style.display = 'block';
             }).catch(error => {
                 console.error('Error loading product for edit:', error);
                 showAlert('Error loading product: ' + error, 'warning');
             });
         }
 
         function deleteProduct(id) {
             if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                 dbOperations.deleteProduct(id)
                     .then(() => {
                         showAlert('Product deleted successfully.');
                         loadProducts(); // Reload product list and dependent data
                     })
                     .catch(error => {
                         console.error('Error deleting product:', error);
                         showAlert('Error deleting product: ' + error, 'warning');
                     });
             }
         }
 
         function editTransaction(id) {
             dbOperations.getTransaction(id).then(transaction => {
                 dbOperations.getProduct(transaction.productId).then(product => {
                     document.getElementById('editTransactionId').value = transaction.id;
                     const productSelect = document.getElementById('editTransactionProduct');
                     productSelect.innerHTML = ''; // Clear existing
                     const option = document.createElement('option');
                     option.value = product.id;
                     option.textContent = product.name;
                     option.selected = true;
                     productSelect.appendChild(option);
                     productSelect.disabled = true; // Keep disabled as product cannot change
                     document.getElementById('editTransactionType').value = transaction.type;
                     document.getElementById('editTransactionType').disabled = true; // Keep disabled as type cannot change
                     document.getElementById('editTransactionQuantity').value = transaction.quantity;
                     // Format date for input type=date (YYYY-MM-DD)
                     const dateObj = new Date(transaction.date);
                     const formattedDate = dateObj.toISOString().split('T')[0];
                     document.getElementById('editTransactionDate').value = formattedDate;
                     document.getElementById('editTransactionNotes').value = transaction.notes || '';
 
                     const modal = document.getElementById('editTransactionModal');
                     modal.style.display = 'block';
                 }).catch(error => { throw error; });
             }).catch(error => {
                 console.error('Error loading transaction for edit:', error);
                 showAlert('Error loading transaction: ' + error, 'warning');
             });
         }
 
         function deleteTransaction(id) {
             if (confirm('Are you sure you want to delete this transaction? This will revert the stock changes.')) {
                 dbOperations.deleteTransaction(id)
                     .then(() => {
                         showAlert('Transaction deleted successfully.');
                         loadTransactions();
                         loadProducts(); // Reload products as quantity changed
                     })
                     .catch(error => {
                         console.error('Error deleting transaction:', error);
                         showAlert('Error deleting transaction: ' + error, 'warning');
                     });
             }
         }
 
         function deleteCategory(id) {
             dbOperations.getProducts().then(products => {
                 dbOperations.getCategories().then(categories => {
                     const categoryToDelete = categories.find(c => c.id === id);
                     if (!categoryToDelete) {
                         showAlert('Category not found.', 'warning');
                         return;
                     }
 
                     const isCategoryUsed = products.some(p => p.category === categoryToDelete.name);
 
                     if (isCategoryUsed) {
                         showAlert(`Cannot delete category "${categoryToDelete.name}" as it is currently assigned to one or more products.`, 'warning');
                     } else if (confirm(`Are you sure you want to delete the category "${categoryToDelete.name}"?`)) {
                         dbOperations.deleteCategory(id)
                             .then(() => {
                                 showAlert('Category deleted successfully.');
                                 loadCategories(); // Refresh category lists
                             })
                             .catch(error => {
                                 console.error('Error deleting category:', error);
                                 showAlert('Error deleting category: ' + error, 'warning');
                             });
                     }
                 }).catch(error => showAlert('Error fetching categories: ' + error, 'warning'));
             }).catch(error => showAlert('Error fetching products: ' + error, 'warning'));
         }
 
         function updateDashboard() {
             Promise.all([
                 dbOperations.getProducts(),
                 dbOperations.getTransactions()
             ]).then(([products, transactions]) => {
                 const totalProductsCard = document.getElementById('totalProducts');
                 totalProductsCard.innerHTML = `<h3>Total Products</h3><p>${products.length}</p>`;
 
                 const lowStockProducts = products.filter(p => p.quantity > 0 && p.quantity <= p.lowStockThreshold);
                 const lowStockItemsCard = document.getElementById('lowStockItems');
                 lowStockItemsCard.innerHTML = `<h3>Low Stock Items</h3><p>${lowStockProducts.length}</p>`;
 
                 const totalValue = products.reduce((sum, p) => sum + (p.quantity * p.salePrice), 0);
                 const totalValueCard = document.getElementById('totalValue');
                 totalValueCard.innerHTML = `<h3>Total Inventory Value</h3><p>${formatCurrency(totalValue)}</p>`;
 
                 const recentSales = transactions.filter(t => t.type === 'out').slice(0, 5); // Show last 5 sales
                 const recentSalesCard = document.getElementById('recentSales');
                 recentSalesCard.innerHTML = '<h3>Recent Sales</h3>';
                 if (recentSales.length > 0) {
                     const list = document.createElement('ul');
                     list.style.listStyle = 'none';
                     list.style.paddingLeft = '0';
                     recentSales.forEach(sale => {
                         const product = products.find(p => p.id === sale.productId);
                         const li = document.createElement('li');
                         li.textContent = `${product ? product.name : 'Unknown'} (${sale.quantity}) - ${formatDate(sale.date)}`;
                         li.style.fontSize = '0.9em';
                         list.appendChild(li);
                     });
                     recentSalesCard.appendChild(list);
                 } else {
                     recentSalesCard.innerHTML += '<p>No recent sales</p>';
                 }
 
                 // Update Low Stock Alerts table
                 const lowStockAlertsDiv = document.getElementById('lowStockAlerts');
                 lowStockAlertsDiv.innerHTML = '';
                 if (lowStockProducts.length > 0) {
                     const table = document.createElement('table');
                     table.innerHTML = `<thead><tr><th>Product</th><th>Quantity</th></tr></thead>`;
                     const tbody = document.createElement('tbody');
                     lowStockProducts.forEach(p => {
                         const row = tbody.insertRow();
                         row.insertCell().textContent = p.name;
                         row.insertCell().textContent = p.quantity;
                     });
                     table.appendChild(tbody);
                     lowStockAlertsDiv.appendChild(table);
                 } else {
                     lowStockAlertsDiv.innerHTML = '<p>No items currently low on stock.</p>';
                 }
 
                 // Update Recent Activity
                 const recentActivityDiv = document.getElementById('recentActivity');
                 recentActivityDiv.innerHTML = '';
                 const recentTransactions = transactions.slice(0, 10); // Show last 10 transactions
                 if (recentTransactions.length > 0) {
                     const list = document.createElement('ul');
                     list.style.listStyle = 'none';
                     list.style.paddingLeft = '0';
                     recentTransactions.forEach(t => {
                         const product = products.find(p => p.id === t.productId);
                         const li = document.createElement('li');
                         const typeText = t.type === 'in' ? 'Stocked In' : 'Sold';
                         const color = t.type === 'in' ? 'var(--success)' : 'var(--danger)';
                         li.innerHTML = `<span style="color: ${color};">${typeText}</span>: ${t.quantity} x ${product ? product.name : 'Unknown'} on ${formatDate(t.date)}`;
                         li.style.fontSize = '0.9em';
                         li.style.borderBottom = '1px dashed #eee';
                         li.style.padding = '3px 0';
                         list.appendChild(li);
                     });
                     recentActivityDiv.appendChild(list);
                 } else {
                     recentActivityDiv.innerHTML = '<p>No recent activity.</p>';
                 }
 
             }).catch(error => {
                 console.error('Error updating dashboard:', error);
                 // Optionally show errors on the dashboard cards
                 document.querySelectorAll('.dashboard-card p.loading').forEach(p => p.textContent = 'Error');
             });
         }
 
         function generateReport() {
             const reportType = document.getElementById('reportType').value;
             const startDate = document.getElementById('dateRangeStart').value;
             const endDate = document.getElementById('dateRangeEnd').value;
             const reportTitle = document.getElementById('reportTitle');
             const reportContent = document.getElementById('reportContent');
             reportContent.innerHTML = '<p class="loading">Generating report</p>';
 
             Promise.all([
                 dbOperations.getProducts(),
                 dbOperations.getTransactions()
             ]).then(([products, allTransactions]) => {
                 let reportData = [];
                 let title = '';
 
                 // Filter transactions by date range if provided
                 const transactions = allTransactions.filter(t => {
                     const tDate = new Date(t.date);
                     const start = startDate ? new Date(startDate) : null;
                     const end = endDate ? new Date(endDate) : null;
                     if (start && tDate < start) return false;
                     if (end) {
                         // Adjust end date to include the whole day
                         end.setHours(23, 59, 59, 999);
                         if (tDate > end) return false;
                     }
                     return true;
                 });
 
                 const productMap = products.reduce((map, p) => { map[p.id] = p; return map; }, {});
 
                 switch (reportType) {
                     case 'inventory':
                         title = 'Current Inventory Report';
                         reportData = products.map(p => ({
                             Name: p.name,
                             Category: p.category,
                             'Purchase Price': formatCurrency(p.purchasePrice),
                             'Sale Price': formatCurrency(p.salePrice),
                             Quantity: p.quantity,
                             'Total Value (Sale)': formatCurrency(p.quantity * p.salePrice)
                         }));
                         break;
                     case 'lowStock':
                         title = 'Low Stock Report';
                         reportData = products
                             .filter(p => p.quantity <= p.lowStockThreshold)
                             .map(p => ({
                                 Name: p.name,
                                 Category: p.category,
                                 Quantity: p.quantity,
                                 'Threshold': p.lowStockThreshold
                             }));
                         break;
                     case 'transactions':
                         title = 'Transaction History Report';
                         reportData = transactions
                             .sort((a, b) => new Date(b.date) - new Date(a.date))
                             .map(t => ({
                                 Date: formatDate(t.date),
                                 Product: productMap[t.productId]?.name || 'Unknown',
                                 Type: t.type === 'in' ? 'Stock In' : 'Stock Out',
                                 Quantity: t.quantity,
                                 Notes: t.notes || '-'
                             }));
                         break;
                     case 'sales':
                         title = 'Sales Report';
                         reportData = transactions
                             .filter(t => t.type === 'out')
                             .sort((a, b) => new Date(b.date) - new Date(a.date))
                             .map(t => {
                                 const product = productMap[t.productId];
                                 return {
                                     Date: formatDate(t.date),
                                     Product: product?.name || 'Unknown',
                                     Quantity: t.quantity,
                                     'Sale Price': product ? formatCurrency(product.salePrice) : 'N/A',
                                     'Total Sale': product ? formatCurrency(t.quantity * product.salePrice) : 'N/A'
                                 };
                             });
                         break;
                     case 'purchases':
                         title = 'Purchases Report';
                         reportData = transactions
                             .filter(t => t.type === 'in')
                             .sort((a, b) => new Date(b.date) - new Date(a.date))
                             .map(t => {
                                 const product = productMap[t.productId];
                                 return {
                                     Date: formatDate(t.date),
                                     Product: product?.name || 'Unknown',
                                     Quantity: t.quantity,
                                     'Purchase Price': product ? formatCurrency(product.purchasePrice) : 'N/A',
                                     'Total Cost': product ? formatCurrency(t.quantity * product.purchasePrice) : 'N/A',
                                     Supplier: product?.supplier || '-',
                                     Notes: t.notes || '-'
                                 };
                             });
                         break;
                     case 'profit':
                         title = 'Profit Analysis Report';
                         let totalSales = 0;
                         let totalCostOfGoodsSold = 0;
                         const salesTransactions = transactions.filter(t => t.type === 'out');
 
                         reportData = salesTransactions
                             .sort((a, b) => new Date(b.date) - new Date(a.date))
                             .map(t => {
                                 const product = productMap[t.productId];
                                 if (!product) return null; // Skip if product not found
 
                                 const saleAmount = t.quantity * product.salePrice;
                                 const costAmount = t.quantity * product.purchasePrice;
                                 const profitAmount = saleAmount - costAmount;
 
                                 totalSales += saleAmount;
                                 totalCostOfGoodsSold += costAmount;
 
                                 return {
                                     Date: formatDate(t.date),
                                     Product: product.name,
                                     Quantity: t.quantity,
                                     'Total Sale': formatCurrency(saleAmount),
                                     'Total Cost': formatCurrency(costAmount),
                                     'Profit': formatCurrency(profitAmount)
                                 };
                             }).filter(item => item !== null); // Remove null entries
 
                         // Add Summary Row
                         const totalProfit = totalSales - totalCostOfGoodsSold;
                         reportData.push({}); // Spacer
                         reportData.push({
                             Date: 'SUMMARY', Product: '', Quantity: '',
                             'Total Sale': formatCurrency(totalSales),
                             'Total Cost': formatCurrency(totalCostOfGoodsSold),
                             'Profit': formatCurrency(totalProfit)
                         });
                         break;
                 }
 
                 reportTitle.textContent = title + (startDate || endDate ? ` (${startDate || 'Start'} - ${endDate || 'Today'})` : '');
 
                 if (reportData.length === 0 || (reportType === 'profit' && reportData.length <= 2)) { // Check for data or only summary row in profit
                     reportContent.innerHTML = '<p>No data available for the selected report type and date range.</p>';
                 } else {
                     reportContent.innerHTML = '';
                     const table = document.createElement('table');
                     const thead = table.createTHead();
                     const tbody = table.createTBody();
                     const headers = Object.keys(reportData[0]);
 
                     // Create header row
                     const headerRow = thead.insertRow();
                     headers.forEach(header => {
                         const th = document.createElement('th');
                         th.textContent = header;
                         headerRow.appendChild(th);
                     });
 
                     // Create data rows
                     reportData.forEach(item => {
                         const row = tbody.insertRow();
                         headers.forEach(header => {
                             const cell = row.insertCell();
                             cell.textContent = item[header] !== undefined ? item[header] : '';
                             // Style summary row in profit report
                             if (reportType === 'profit' && item.Date === 'SUMMARY') {
                                 cell.style.fontWeight = 'bold';
                                 cell.style.borderTop = '2px solid var(--primary)';
                             }
                         });
                     });
 
                     reportContent.appendChild(table);
 
                     // Store data for export
                     document.getElementById('exportReportCSV')._reportData = reportData;
                     document.getElementById('exportReportCSV')._reportTitle = title.replace(/ /g, '_');
                 }
             }).catch(error => {
                 console.error('Error generating report:', error);
                 reportContent.innerHTML = `<p class="alert alert-warning">Error generating report: ${error}</p>`;
             });
         }
 
         function printReport() {
             window.print();
         }
 
         function exportToCSV(data, filename) {
             if (!data || data.length === 0) {
                 showAlert('No data to export.', 'warning');
                 return;
             }
 
             const headers = Object.keys(data[0]);
             const csvRows = [];
 
             // Add header row
             csvRows.push(headers.join(','));
 
             // Add data rows
             data.forEach(row => {
                 const values = headers.map(header => {
                     const escaped = ('' + (row[header] === undefined ? '' : row[header])).replace(/"/g, '""'); // Escape double quotes
                     return `"${escaped}"`; // Wrap in double quotes
                 });
                 csvRows.push(values.join(','));
             });
 
             const csvString = csvRows.join('\n');
             const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
 
             const link = document.getElementById('csvDownloadLink');
             link.href = URL.createObjectURL(blob);
             link.download = filename + '.csv';
             link.click();
 
             showAlert('CSV file generated for download.');
         }
 
         function loadBusinessInfo() {
             dbOperations.getSettings('businessInfo').then(info => {
                 if (info) {
                     document.getElementById('businessName').value = info.name || '';
                     document.getElementById('businessOwner').value = info.owner || '';
                     document.getElementById('businessPhone').value = info.phone || '';
                     document.getElementById('businessAddress').value = info.address || '';
                 }
             }).catch(error => {
                 console.error('Error loading business info:', error);
                 showAlert('Error loading business info: ' + error, 'warning');
             });
         }
 
         function saveBusinessInfo(event) {
             event.preventDefault();
             const info = {
                 id: 'businessInfo',
                 name: document.getElementById('businessName').value.trim(),
                 owner: document.getElementById('businessOwner').value.trim(),
                 phone: document.getElementById('businessPhone').value.trim(),
                 address: document.getElementById('businessAddress').value.trim()
             };
             dbOperations.updateSettings(info).then(() => {
                 showAlert('Business information saved successfully.');
             }).catch(error => {
                 console.error('Error saving business info:', error);
                 showAlert('Error saving business info: ' + error, 'warning');
             });
         }
 
         function addCategory(event) {
             event.preventDefault();
             const newCategoryInput = document.getElementById('newCategory');
             const categoryName = newCategoryInput.value.trim();
 
             if (!categoryName) {
                 showAlert('Please enter a category name.', 'warning');
                 return;
             }
 
             dbOperations.addCategory({ name: categoryName }).then(() => {
                 showAlert(`Category "${categoryName}" added successfully.`);
                 newCategoryInput.value = ''; // Clear input
                 loadCategories(); // Refresh category lists
             }).catch(error => {
                 console.error('Error adding category:', error);
                 // Check if it's a duplicate error (ConstraintError)
                 if (error.toString().includes('ConstraintError')) {
                     showAlert(`Category "${categoryName}" already exists.`, 'warning');
                 } else {
                     showAlert('Error adding category: ' + error, 'warning');
                 }
             });
         }
 
         function backupData() {
             Promise.all([
                 dbOperations.getProducts(),
                 dbOperations.getTransactions(),
                 dbOperations.getCategories(),
                 dbOperations.getSettings('businessInfo')
             ]).then(([products, transactions, categories, settings]) => {
                 const backup = {
                     products: products,
                     transactions: transactions,
                     categories: categories,
                     settings: settings
                 };
                 const dataStr = JSON.stringify(backup, null, 2);
                 const blob = new Blob([dataStr], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
 
                 const link = document.getElementById('csvDownloadLink'); // Reuse the download link element
                 link.href = url;
                 link.download = `pakistani_inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
                 link.click();
 
                 URL.revokeObjectURL(url); // Clean up
                 showAlert('Data backup file generated for download.');
             }).catch(error => {
                 console.error('Error backing up data:', error);
                 showAlert('Error creating data backup: ' + error, 'warning');
             });
         }
 
         function triggerRestore() {
             document.getElementById('restoreFile').click();
         }
 
         function restoreData(event) {
             const file = event.target.files[0];
             if (!file) {
                 return;
             }
 
             if (!confirm('Restoring data will overwrite ALL current data. Are you sure you want to proceed?')) {
                 event.target.value = null; // Reset file input
                 return;
             }
 
             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const backup = JSON.parse(e.target.result);
 
                     // Check if the backup file has the expected structure
                     if (!backup || typeof backup !== 'object' || !backup.products || !backup.transactions || !backup.categories || !backup.settings) {
                         throw new Error('Invalid backup file format.');
                     }
 
                     // Clear existing data and restore
                     const transaction = db.transaction(['products', 'transactions', 'categories', 'settings'], 'readwrite');
                     const stores = {
                         products: transaction.objectStore('products'),
                         transactions: transaction.objectStore('transactions'),
                         categories: transaction.objectStore('categories'),
                         settings: transaction.objectStore('settings')
                     };
 
                     const clearPromises = Object.values(stores).map(store => new Promise((resolve, reject) => {
                         const req = store.clear();
                         req.onsuccess = resolve;
                         req.onerror = reject;
                     }));
 
                     Promise.all(clearPromises).then(() => {
                         const addPromises = [];
 
                         // Add restored data
                         backup.products.forEach(p => addPromises.push(new Promise((res, rej) => { stores.products.add(p).onsuccess = res; stores.products.add(p).onerror = rej; })));
                         backup.transactions.forEach(t => addPromises.push(new Promise((res, rej) => { stores.transactions.add(t).onsuccess = res; stores.transactions.add(t).onerror = rej; })));
                         backup.categories.forEach(c => addPromises.push(new Promise((res, rej) => { stores.categories.add(c).onsuccess = res; stores.categories.add(c).onerror = rej; })));
                         addPromises.push(new Promise((res, rej) => { stores.settings.add(backup.settings).onsuccess = res; stores.settings.add(backup.settings).onerror = rej; }));
 
                         Promise.all(addPromises).then(() => {
                             showAlert('Data restored successfully. Please refresh the page.');
                             // Optionally force reload: location.reload();
                         }).catch(err => {
                             throw new Error('Error adding restored data: ' + err.target?.error);
                         });
                     }).catch(err => {
                         throw new Error('Error clearing existing data: ' + err.target?.error);
                     });
 
                 } catch (error) {
                     console.error('Error restoring data:', error);
                     showAlert('Error restoring data: ' + error.message, 'warning');
                 } finally {
                     event.target.value = null; // Reset file input
                 }
             };
             reader.onerror = function() {
                 showAlert('Error reading backup file.', 'warning');
                 event.target.value = null; // Reset file input
             };
             reader.readAsText(file);
         }
 
         function clearAllData() {
             if (confirm('WARNING: This will permanently delete ALL products, transactions, categories, and settings. This action cannot be undone. Are you absolutely sure?')) {
                 const transaction = db.transaction(['products', 'transactions', 'categories', 'settings'], 'readwrite');
                 const stores = [
                     transaction.objectStore('products'),
                     transaction.objectStore('transactions'),
                     transaction.objectStore('categories'),
                     transaction.objectStore('settings')
                 ];
 
                 const clearPromises = stores.map(store => new Promise((resolve, reject) => {
                     const request = store.clear();
                     request.onsuccess = resolve;
                     request.onerror = reject;
                 }));
 
                 Promise.all(clearPromises).then(() => {
                     showAlert('All data cleared successfully. Re-initializing default settings. Please refresh the page.');
                     // Optionally re-run setup or reload: location.reload();
                     // Re-add default categories and settings (or prompt user)
                     // This part might need adjustment based on how defaults are handled
                     indexedDB.deleteDatabase(DB_NAME); // Delete and let it recreate on next load
                     setTimeout(() => location.reload(), 2000); // Reload after a delay
 
                 }).catch(error => {
                     console.error('Error clearing data:', error);
                     showAlert('Error clearing data: ' + error.target?.error, 'warning');
                 });
             }
         }
 
         function toggleLanguage() {
             // Basic example: Toggle visibility or apply language-specific classes
             // This requires elements to be marked appropriately (e.g., with lang="en" or lang="ur")
             // Or use a more sophisticated i18n library
             const isUrdu = document.body.classList.toggle('urdu-mode'); // Example class
             showAlert(isUrdu ? 'Language set to Urdu (basic toggle)' : 'Language set to English (basic toggle)');
             // You would need CSS rules for .urdu-mode to change fonts, direction etc.
         }
 
         // Initial Load and Event Listeners
         document.addEventListener('DOMContentLoaded', () => {
             initDB().then(() => {
                 // Load initial data
                 loadCategories();
                 loadProducts();
                 loadTransactions();
                 loadBusinessInfo();
                 updateDashboard(); // Initial dashboard load
 
                 // Setup Tabs
                 const tabLinks = document.querySelectorAll('.nav-tabs .tab-link');
                 const tabContents = document.querySelectorAll('.tab-content');
 
                 tabLinks.forEach(link => {
                     link.addEventListener('click', () => {
                         const tabId = link.getAttribute('data-tab');
 
                         tabLinks.forEach(l => l.classList.remove('active'));
                         tabContents.forEach(c => c.classList.remove('active'));
 
                         link.classList.add('active');
                        document.getElementById(tabId).classList.add('active');
 
                         // Refresh data if needed when switching tabs (e.g., dashboard)
                         if (tabId === 'dashboard') {
                             updateDashboard();
                         }
                     });
                 });
 
                 // Add Product Form
                 document.getElementById('addProductForm').addEventListener('submit', (event) => {
                     event.preventDefault();
                     const product = {
                         name: document.getElementById('productName').value.trim(),
                         category: document.getElementById('category').value,
                         barcode: document.getElementById('barcode').value.trim(),
                         purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                         salePrice: parseFloat(document.getElementById('salePrice').value),
                         quantity: parseInt(document.getElementById('quantity').value),
                         lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value),
                         supplier: document.getElementById('supplier').value.trim(),
                         notes: document.getElementById('notes').value.trim()
                     };
 
                     if (!product.name || !product.category || isNaN(product.purchasePrice) || isNaN(product.salePrice) || isNaN(product.quantity)) {
                         showAlert('Please fill in all required fields (Name, Category, Prices, Quantity).', 'warning');
                         return;
                     }
 
                     dbOperations.addProduct(product).then(() => {
                         showAlert('Product added successfully.');
                         document.getElementById('addProductForm').reset();
                         loadProducts(); // Refresh product list and dropdowns
                     }).catch(error => {
                         console.error('Error adding product:', error);
                         showAlert('Error adding product: ' + error, 'warning');
                     });
                 });
 
                 // Inventory Search/Filter/Sort
                 document.getElementById('searchInventory').addEventListener('input', () => {
                     dbOperations.getProducts().then(products => displayInventory(
                         products,
                         document.getElementById('searchInventory').value,
                         document.getElementById('categoryFilter').value,
                         document.getElementById('sortInventory').value
                     ));
                 });
                 document.getElementById('categoryFilter').addEventListener('change', () => {
                     dbOperations.getProducts().then(products => displayInventory(
                         products,
                         document.getElementById('searchInventory').value,
                         document.getElementById('categoryFilter').value,
                         document.getElementById('sortInventory').value
                     ));
                 });
                 document.getElementById('sortInventory').addEventListener('change', () => {
                     dbOperations.getProducts().then(products => displayInventory(
                         products,
                         document.getElementById('searchInventory').value,
                         document.getElementById('categoryFilter').value,
                         document.getElementById('sortInventory').value
                     ));
                 });
                 document.getElementById('printInventory').addEventListener('click', () => window.print());
                 document.getElementById('exportInventory').addEventListener('click', () => {
                     dbOperations.getProducts().then(products => {
                         const exportData = products.map(p => ({ // Select and format columns for export
                             ID: p.id,
                             Name: p.name,
                             Category: p.category,
                             Barcode: p.barcode || '',
                             PurchasePrice: p.purchasePrice,
                             SalePrice: p.salePrice,
                             Quantity: p.quantity,
                             LowStockThreshold: p.lowStockThreshold,
                             Supplier: p.supplier || '',
                             Notes: p.notes || '',
                             CreatedAt: formatDate(p.createdAt),
                             UpdatedAt: formatDate(p.updatedAt)
                         }));
                         exportToCSV(exportData, 'inventory_export');
                     }).catch(error => showAlert('Error preparing inventory export: ' + error, 'warning'));
                 });
 
                 // Add Transaction Form
                 document.getElementById('addTransactionForm').addEventListener('submit', (event) => {
                     event.preventDefault();
                     const transaction = {
                         productId: parseInt(document.getElementById('transactionProduct').value),
                         type: document.getElementById('transactionType').value,
                         quantity: parseInt(document.getElementById('transactionQuantity').value),
                         date: document.getElementById('transactionDate').value ? new Date(document.getElementById('transactionDate').value).toISOString() : new Date().toISOString(),
                         notes: document.getElementById('transactionNotes').value.trim()
                     };
 
                     if (!transaction.productId || isNaN(transaction.quantity) || transaction.quantity <= 0) {
                         showAlert('Please select a product and enter a valid quantity.', 'warning');
                         return;
                     }
 
                     dbOperations.addTransaction(transaction).then(() => {
                         showAlert('Transaction added successfully.');
                         document.getElementById('addTransactionForm').reset();
                         // Set default date to today after reset
                         document.getElementById('transactionDate').valueAsDate = new Date();
                         loadTransactions();
                         loadProducts(); // Reload products as quantity changed
                     }).catch(error => {
                         console.error('Error adding transaction:', error);
                         showAlert('Error adding transaction: ' + error, 'warning');
                     });
                 });
                 document.getElementById('transactionDate').valueAsDate = new Date(); // Set default date
 
                 document.getElementById('printTransactions').addEventListener('click', () => window.print());
                 document.getElementById('exportTransactions').addEventListener('click', () => {
                     Promise.all([dbOperations.getTransactions(), dbOperations.getProducts()]).then(([transactions, products]) => {
                         const productMap = products.reduce((map, p) => { map[p.id] = p.name; return map; }, {});
                         const exportData = transactions
                             .sort((a, b) => new Date(b.date) - new Date(a.date))
                             .map(t => ({
                                 ID: t.id,
                                 Date: formatDate(t.date),
                                 ProductID: t.productId,
                                 ProductName: productMap[t.productId] || 'Unknown',
                                 Type: t.type === 'in' ? 'Stock In' : 'Stock Out',
                                 Quantity: t.quantity,
                                 Notes: t.notes || '',
                                 CreatedAt: formatDate(t.createdAt)
                             }));
                         exportToCSV(exportData, 'transactions_export');
                     }).catch(error => showAlert('Error preparing transactions export: ' + error, 'warning'));
                 });
 
                 // Reports
                 document.getElementById('generateReport').addEventListener('click', generateReport);
                 document.getElementById('printReport').addEventListener('click', printReport);
                 document.getElementById('exportReportCSV').addEventListener('click', function() {
                     // Use stored data from generateReport
                     exportToCSV(this._reportData, this._reportTitle || 'report_export');
                 });
 
                 // Settings
                 document.getElementById('businessInfoForm').addEventListener('submit', saveBusinessInfo);
                 document.getElementById('addCategoryForm').addEventListener('submit', addCategory);
                 document.getElementById('backupData').addEventListener('click', backupData);
                 document.getElementById('restoreData').addEventListener('click', triggerRestore);
                 document.getElementById('restoreFile').addEventListener('change', restoreData);
                 document.getElementById('clearData').addEventListener('click', clearAllData);
 
                 // Modals
                 const modals = document.querySelectorAll('.modal');
                 const closeButtons = document.querySelectorAll('.close-modal');
 
                 closeButtons.forEach(button => {
                     button.addEventListener('click', () => {
                         button.closest('.modal').style.display = 'none';
                     });
                 });
 
                 window.addEventListener('click', (event) => {
                     modals.forEach(modal => {
                         if (event.target === modal) {
                             modal.style.display = 'none';
                         }
                     });
                 });
 
                 // Edit Product Form
                 document.getElementById('editProductForm').addEventListener('submit', (event) => {
                     event.preventDefault();
                     const product = {
                         id: parseInt(document.getElementById('editProductId').value),
                         name: document.getElementById('editProductName').value.trim(),
                         category: document.getElementById('editCategory').value,
                         barcode: document.getElementById('editBarcode').value.trim(),
                         purchasePrice: parseFloat(document.getElementById('editPurchasePrice').value),
                         salePrice: parseFloat(document.getElementById('editSalePrice').value),
                         lowStockThreshold: parseInt(document.getElementById('editLowStockThreshold').value),
                         supplier: document.getElementById('editSupplier').value.trim(),
                         notes: document.getElementById('editNotes').value.trim()
                     };
 
                     // Fetch original quantity to maintain it during edit
                     dbOperations.getProduct(product.id).then(originalProduct => {
                         product.quantity = originalProduct.quantity; // Keep the original quantity
                         dbOperations.updateProduct(product).then(() => {
                             showAlert('Product updated successfully.');
                             document.getElementById('editProductModal').style.display = 'none';
                             loadProducts(); // Refresh inventory table
                         }).catch(error => {
                             console.error('Error updating product:', error);
                             showAlert('Error updating product: ' + error, 'warning');
                         });
                     }).catch(error => {
                         console.error('Error fetching original product:', error);
                         showAlert('Error updating product: Could not fetch original data.', 'warning');
                     });
                 });
 
                 // Edit Transaction Form
                 document.getElementById('editTransactionForm').addEventListener('submit', (event) => {
                     event.preventDefault();
                     const transaction = {
                         id: parseInt(document.getElementById('editTransactionId').value),
                         quantity: parseInt(document.getElementById('editTransactionQuantity').value),
                         date: new Date(document.getElementById('editTransactionDate').value).toISOString(),
                         notes: document.getElementById('editTransactionNotes').value.trim()
                     };
 
                     if (isNaN(transaction.quantity) || transaction.quantity <= 0) {
                         showAlert('Please enter a valid quantity.', 'warning');
                         return;
                     }
 
                     dbOperations.updateTransaction(transaction).then(() => {
                         showAlert('Transaction updated successfully.');
                         document.getElementById('editTransactionModal').style.display = 'none';
                         loadTransactions();
                         loadProducts(); // Refresh inventory as quantity might have changed
                     }).catch(error => {
                         console.error('Error updating transaction:', error);
                         showAlert('Error updating transaction: ' + error, 'warning');
                     });
                 });
 
                // Language Toggle
                document.getElementById('languageToggle').addEventListener('click', toggleLanguage);
 
             }).catch(error => {
                 console.error('Failed to initialize database:', error);
                 document.body.innerHTML = `<div class="container" style="padding-top: 50px; text-align: center;">
                     <h1>Database Error</h1>
                     <p>Could not initialize the application database. Please ensure IndexedDB is enabled and not blocked by your browser settings.</p>
                     <p><em>Error details: ${error}</em></p>
                 </div>`;
             });
         });
 
     </script>
 </body>
 </html>