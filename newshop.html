
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Shop Management System</title>
    <style>
        /* --- Base Styles & Fonts --- */
        :root {
            --primary-color: #006400; /* Dark Green */
            --secondary-color: #f4f4f4; /* Light Gray */
            --text-color: #333;
            --border-color: #ccc;
            --ledger-line-color: #e0e0e0;
            --ledger-bg-color: #fdfdfd;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --success-color: #28a745;
            --font-handwritten: 'cursive', 'Segoe Script', 'Brush Script MT', sans-serif; /* Fallback fonts */
            --font-sans: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 15px auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }

        h1 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        h2 {
           font-size: 1.5em;
        }

        h3 {
            font-size: 1.2em;
        }

        /* --- Navigation Tabs --- */
        .main-nav {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }
        .nav-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            background-color: #f1f1f1;
            font-size: 1em;
            font-weight: 500;
            color: var(--primary-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .nav-tab:hover {
            background-color: #e7e7e7;
        }
        .nav-tab.active {
            background-color: #fff;
            border-color: var(--primary-color) var(--primary-color) #fff;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* --- Ledger Paper Styling --- */
        .ledger-input,
        .ledger-textarea,
        .ledger-select {
            background-color: var(--ledger-bg-color);
            border: none;
            border-bottom: 1px solid var(--ledger-line-color);
            padding: 10px 5px 5px 5px;
            margin-bottom: 10px;
            width: 100%;
            /*
            font-family: var(--font-handwritten);
            */
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            font-size: 1.1em;
            line-height: 1.8; /* Simulate lines */
            background-image: linear-gradient(to bottom, transparent 95%, var(--ledger-line-color) 95%);
            background-size: 100% 1.8em; /* Match line-height */
            background-repeat: repeat-y;
            background-position: 0 5px; /* Adjust vertical position */
            resize: vertical; /* Allow textarea resize */
        }
        .ledger-textarea { min-height: 80px; }
        .ledger-input:focus, .ledger-textarea:focus, .ledger-select:focus {
            outline: none;
            border-bottom: 2px solid var(--primary-color);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin: 5px;
            text-decoration: none;
            color: #fff;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background-color: #004d00; }
        .btn-secondary { background-color: #6c757d; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        .btn-success { background-color: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background-color: #218838; }
        .btn-warning { background-color: var(--warning-color); color: #212529; }
        .btn-warning:hover:not(:disabled) { background-color: #e0a800; }
        .btn-info { background-color: var(--info-color); color: #fff;}
        .btn-info:hover:not(:disabled) { background-color: #138496;}
        .btn-icon { padding: 8px 10px; font-size: 0.9em; }

        /* --- Forms & Modals --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-family: var(--font-sans); }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fff; margin: 5% auto; padding: 25px; border-radius: 8px;
            max-width: 600px; width: 90%; position: relative; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .modal-content.modal-lg { max-width: 900px; }
        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 1.8em;
            font-weight: bold; color: #aaa; cursor: pointer; line-height: 1;
        }
        .modal-close:hover, .modal-close:focus { color: #333; }

        /* --- Tables --- */
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .data-table thead { background-color: var(--primary-color); color: #fff; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table tbody tr:nth-child(even) { background-color: var(--ledger-bg-color); }
        .data-table tbody tr:hover { background-color: #e9e9e9; }
        .data-table td .btn { padding: 5px 8px; font-size: 0.85em; margin: 2px; }
        .balance-positive { color: var(--danger-color); font-weight: bold; } /* We owe them */
        .balance-negative { color: var(--success-color); font-weight: bold; } /* They owe us */
        .stock-ok { color: var(--success-color); }
        .stock-low { color: var(--warning-color); font-weight: bold; }
        .stock-out { color: var(--danger-color); font-weight: bold; }


        /* --- Layout & Sections --- */
        .section {
            margin-bottom: 25px; padding: 15px; background: #fff;
            border-radius: 5px; border: 1px solid var(--border-color);
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; flex-wrap: wrap;
        }
        .section-header h2, .section-header h3 { margin-bottom: 0; }
        .dashboard-summary {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .summary-card {
            background-color: var(--ledger-bg-color); padding: 15px; border-radius: 5px;
            border: 1px solid var(--border-color); text-align: center;
        }
        .summary-card h4 { margin-bottom: 8px; font-size: 1em; color: var(--primary-color); }
        .summary-card p { font-size: 1.3em; font-weight: bold; }
        #customer-details-view, #supplier-details-view { display: none; }

        /* --- Filters & Search --- */
        .filter-controls {
            display: flex; gap: 10px; margin-bottom: 15px;
            flex-wrap: wrap; align-items: center;
        }
        .filter-controls label { margin-bottom: 0; margin-right: 5px; font-family: var(--font-sans); font-weight: normal; }
        .filter-controls input[type="date"], .filter-controls input[type="text"], .filter-controls select {
             padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;
             font-family: var(--font-sans); font-size: 0.95em;
             background-image: none; background-color: #fff; line-height: normal;
        }

        /* --- Sale/Purchase Form specific styles --- */
        .item-entry-form { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap; }
        .item-entry-form .form-group { flex: 1; min-width: 150px; }
        .invoice-totals {
            margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--primary-color);
            text-align: right; font-size: 1.2em; font-weight: bold;
        }


        /* --- Urdu Toggle --- */
        .language-toggle {
            position: absolute; top: 15px; right: 15px; display: flex; align-items: center;
        }
        .language-toggle label { margin: 0 5px 0 0; font-size: 0.9em; font-weight: normal; }

        /* --- Reporting Section --- */
        #report-output {
            margin-top: 20px;
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 5px;
        }
        #report-output h3 { text-align: center; }

        /* --- Print Styles --- */
        @media print {
            body { padding: 0; background-color: #fff; font-size: 10pt; }
            .container { max-width: 100%; margin: 0; padding: 0; box-shadow: none; border-radius: 0; }
            .no-print { display: none !important; }
            .section { border: none; padding: 0; margin-bottom: 15px; page-break-inside: avoid; }
            h1, h2, h3 { color: #000; }
            .data-table { box-shadow: none; font-size: 9pt; }
            .data-table th, .data-table td { padding: 5px 8px; border: 1px solid #ccc; }
            .data-table thead { background-color: #eee; color: #000; }
            .page.active, #printable-report-content { display: block !important; }
            .page:not(.active), #reports-page, #dashboard-page, #sales-page, #purchases-page, #customers-page, #suppliers-page, #inventory-page, #settings-page, #accounting-page { display: none !important; }
            #printable-report-content h2 { text-align: center; font-size: 1.5em; }
            #printable-report-content h3 { text-align: center; font-size: 1.2em; }

            /* Specific styles for print invoice/bill */
            .printable-bill-invoice {
                width: 100%;
                padding: 15px;
                font-family: var(--font-sans);
            }
            .printable-bill-invoice h2, .printable-bill-invoice h3 {
                text-align: center;
                margin-bottom: 10px;
            }
            .printable-bill-invoice .shop-info {
                text-align: center;
                margin-bottom: 20px;
            }
            .printable-bill-invoice .header-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 15px;
                border-bottom: 1px solid #000;
                padding-bottom: 10px;
            }
            .printable-bill-invoice .item-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            .printable-bill-invoice .item-table th, .printable-bill-invoice .item-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            .printable-bill-invoice .item-table th {
                background-color: #f0f0f0;
            }
            .printable-bill-invoice .totals {
                text-align: right;
                font-weight: bold;
                font-size: 1.1em;
            }
            .printable-bill-invoice .footer-notes {
                margin-top: 30px;
                font-size: 0.9em;
                text-align: center;
                border-top: 1px dashed #ccc;
                padding-top: 10px;
            }
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; margin: 10px auto; }
            h1 { font-size: 1.6em; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
            .btn { width: 100%; margin: 5px 0; }
            .btn-icon { width: auto; }
            .section-header { flex-direction: column; align-items: flex-start; }
            .section-header div { margin-top: 10px; width: 100%; display: flex; flex-direction: column; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            .data-table .hide-mobile { display: none; }
            .modal-content { margin: 15% auto; width: 95%; padding: 20px; }
            .language-toggle { position: static; margin: 10px 0; justify-content: flex-end; }
            .main-nav { justify-content: center; }
            .nav-tab { font-size: 0.9em; padding: 8px 10px;}
        }

         @media (max-width: 480px) {
            h1 { font-size: 1.4em; }
            .dashboard-summary { grid-template-columns: 1fr; }
            .data-table { font-size: 0.8em; }
            .data-table th, .data-table td { padding: 6px 4px; }
         }
        .urdu-font-force { font-family: 'Noto Nastaliq Urdu', serif !important; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="language-toggle no-print">
            <label for="language-switch" data-en="Language" data-ur="زبان">Language:</label>
            <select id="language-switch">
                <option value="en">English</option>
                <option value="ur">Urdu (اردو)</option>
            </select>
        </div>

        <h1 data-en="Complete Shop Management System" data-ur="مکمل شاپ مینجمنٹ سسٹم">Complete Shop Management System</h1>

        <!-- Main Navigation -->
        <nav class="main-nav no-print">
            <div class="nav-tab active" data-page="dashboard-page" data-en="Dashboard" data-ur="ڈیش بورڈ">Dashboard</div>
            <div class="nav-tab" data-page="sales-page" data-en="Sales" data-ur="فروخت">Sales</div>
            <div class="nav-tab" data-page="purchases-page" data-en="Purchases" data-ur="خریداری">Purchases</div>
            <div class="nav-tab" data-page="customers-page" data-en="Customers" data-ur="صارفین">Customers</div>
            <div class="nav-tab" data-page="suppliers-page" data-en="Suppliers" data-ur="سپلائرز">Suppliers</div>
            <div class="nav-tab" data-page="inventory-page" data-en="Inventory" data-ur="انوینٹری">Inventory</div>
            <div class="nav-tab" data-page="accounting-page" data-en="Accounting" data-ur="اکاؤنٹنگ">Accounting</div>
            <div class="nav-tab" data-page="reports-page" data-en="Reports" data-ur="رپورٹس">Reports</div>
            <div class="nav-tab" data-page="settings-page" data-en="Settings" data-ur="سیٹنگز">Settings</div>
        </nav>

        <!-- Page: Dashboard -->
        <div id="dashboard-page" class="page active">
            <div class="section">
                <div class="dashboard-summary">
                    <div class="summary-card">
                        <h4 data-en="Total Customers" data-ur="کل صارفین">Total Customers</h4>
                        <p id="total-customers">0</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Receivables (Lena Hai)" data-ur="واجبات (لینا ہے)">Receivables (Lena Hai)</h4>
                        <p id="total-receivables" class="balance-negative">Rs 0.00</p>
                    </div>
                     <div class="summary-card">
                        <h4 data-en="Payables (Dena Hai)" data-ur="واجب الادا (دینا ہے)">Payables (Dena Hai)</h4>
                        <p id="total-payables" class="balance-positive">Rs 0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Low Stock Items" data-ur="کم اسٹاک آئٹمز">Low Stock Items</h4>
                        <p id="low-stock-items" class="stock-low">0</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Total Inventory Value" data-ur="کل انوینٹری مالیت">Total Inventory Value</h4>
                        <p id="inventory-value">Rs 0.00</p>
                    </div>
                     <div class="summary-card">
                        <h4 data-en="Total Income (Period)" data-ur="کل آمدنی (مدت)">Total Income (Period)</h4>
                        <p id="total-income-period" class="balance-negative">Rs 0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Total Expenses (Period)" data-ur="کل اخراجات (مدت)">Total Expenses (Period)</h4>
                        <p id="total-expenses-period" class="balance-positive">Rs 0.00</p>
                    </div>
                </div>
                <div class="filter-controls">
                    <label for="dashboard-start-date" data-en="Period From:" data-ur="مدت سے:">Period From:</label>
                    <input type="date" id="dashboard-start-date">
                    <label for="dashboard-end-date" data-en="Period To:" data-ur="مدت تک:">Period To:</label>
                    <input type="date" id="dashboard-end-date">
                    <button id="dashboard-filter-btn" class="btn btn-primary btn-icon" data-en="Filter" data-ur="فلٹر کریں">Filter</button>
                    <button id="dashboard-clear-filter-btn" class="btn btn-secondary btn-icon" data-en="Clear" data-ur="صاف کریں">Clear</button>
                </div>
            </div>
        </div>

        <!-- Page: Sales -->
        <div id="sales-page" class="page">
            <div class="section">
                <div class="section-header">
                    <h2 data-en="Sales History" data-ur="فروخت کی سرگزشت">Sales History</h2>
                    <div>
                        <button id="add-sale-btn" class="btn btn-primary no-print" data-en="New Sale" data-ur="نئی فروخت">New Sale</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="sales-table">
                        <thead>
                            <tr>
                                <th data-en="Date" data-ur="تاریخ">Date</th>
                                <th data-en="Customer" data-ur="صارف">Customer</th>
                                <th data-en="Amount" data-ur="رقم">Amount</th>
                                <th data-en="Status" data-ur="حیثیت">Status</th>
                                <th data-en="Actions" data-ur="کاروائیاں" class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page: Purchases -->
        <div id="purchases-page" class="page">
             <div class="section">
                <div class="section-header">
                    <h2 data-en="Purchase History" data-ur="خریداری کی سرگزشت">Purchase History</h2>
                    <div>
                        <button id="add-purchase-btn" class="btn btn-primary no-print" data-en="New Purchase" data-ur="نئی خریداری">New Purchase</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="purchases-table">
                        <thead>
                            <tr>
                                <th data-en="Date" data-ur="تاریخ">Date</th>
                                <th data-en="Supplier" data-ur="سپلائر">Supplier</th>
                                <th data-en="Amount" data-ur="رقم">Amount</th>
                                <th data-en="Status" data-ur="حیثیت">Status</th>
                                <th data-en="Actions" data-ur="کاروائیاں" class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page: Customers -->
        <div id="customers-page" class="page">
            <div id="customer-list-view">
                <div class="section">
                    <div class="section-header">
                        <h2 data-en="Customers" data-ur="صارفین">Customers</h2>
                        <div>
                            <button id="add-customer-btn" class="btn btn-primary no-print" data-en="Add New Customer" data-ur="نیا صارف شامل کریں">Add New Customer</button>
                        </div>
                    </div>
                     <div class="filter-controls no-print">
                         <input type="text" id="customer-search" placeholder="Search Customers..." data-en-placeholder="Search Customers..." data-ur-placeholder="صارفین تلاش کریں...">
                     </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="customer-table">
                            <thead>
                                <tr>
                                    <th data-en="Name" data-ur="نام">Name</th>
                                    <th data-en="Phone" data-ur="فون" class="hide-mobile">Phone</th>
                                    <th data-en="Balance" data-ur="بیلنس">Balance</th>
                                    <th data-en="Actions" data-ur="کاروائیاں" class="no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customer-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="customer-details-view">
                 <div class="section">
                     <div class="section-header">
                        <h2 id="details-customer-name">Customer Details</h2> <div>
                            <button id="back-to-list-btn-customer" class="btn btn-secondary no-print" data-en="Back to List" data-ur="فہرست پر واپس">Back to List</button>
                        </div>
                     </div>
                     <div id="customer-info"></div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h3 data-en="Transactions" data-ur="لین دین">Transactions</h3>
                         <div class="filter-controls">
                            <label for="customer-ledger-start-date" data-en="From:" data-ur="سے:">From:</label>
                            <input type="date" id="customer-ledger-start-date">
                            <label for="customer-ledger-end-date" data-en="To:" data-ur="تک:">To:</label>
                            <input type="date" id="customer-ledger-end-date">
                            <button id="customer-ledger-filter-btn" class="btn btn-primary btn-icon" data-en="Filter" data-ur="فلٹر کریں">Filter</button>
                            <button id="customer-ledger-clear-filter-btn" class="btn btn-secondary btn-icon" data-en="Clear" data-ur="صاف کریں">Clear</button>
                        </div>
                         <div>
                            <button id="add-manual-transaction-btn-customer" class="btn btn-primary no-print" data-en="Add Manual Transaction" data-ur="دستی لین دین شامل کریں">Add Transaction</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;"> <table class="data-table" id="transaction-table-customer"></table></div>
                    <div class="customer-balance-summary" style="text-align: right; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                        <span data-en="Current Balance:" data-ur="موجودہ بیلنس:">Current Balance:</span> <span id="details-current-balance-customer">Rs 0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Suppliers -->
        <div id="suppliers-page" class="page">
            <div id="supplier-list-view">
                <div class="section">
                    <div class="section-header">
                        <h2 data-en="Suppliers" data-ur="سپلائرز">Suppliers</h2>
                        <div>
                            <button id="add-supplier-btn" class="btn btn-primary no-print" data-en="Add New Supplier" data-ur="نیا سپلائر شامل کریں">Add New Supplier</button>
                        </div>
                    </div>
                     <div class="filter-controls no-print">
                         <input type="text" id="supplier-search" placeholder="Search Suppliers..." data-en-placeholder="Search Suppliers..." data-ur-placeholder="سپلائرز تلاش کریں...">
                     </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="supplier-table">
                            <thead>
                                <tr>
                                    <th data-en="Name" data-ur="نام">Name</th>
                                    <th data-en="Phone" data-ur="فون" class="hide-mobile">Phone</th>
                                    <th data-en="Balance" data-ur="بیلنس">Balance</th>
                                    <th data-en="Actions" data-ur="کاروائیاں" class="no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supplier-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="supplier-details-view">
                 <div class="section">
                     <div class="section-header">
                        <h2 id="details-supplier-name">Supplier Details</h2> <div>
                            <button id="back-to-list-btn-supplier" class="btn btn-secondary no-print" data-en="Back to List" data-ur="فہرست پر واپس">Back to List</button>
                        </div>
                     </div>
                     <div id="supplier-info"></div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h3 data-en="Transactions" data-ur="لین دین">Transactions</h3>
                         <div class="filter-controls">
                            <label for="supplier-ledger-start-date" data-en="From:" data-ur="سے:">From:</label>
                            <input type="date" id="supplier-ledger-start-date">
                            <label for="supplier-ledger-end-date" data-en="To:" data-ur="تک:">To:</label>
                            <input type="date" id="supplier-ledger-end-date">
                            <button id="supplier-ledger-filter-btn" class="btn btn-primary btn-icon" data-en="Filter" data-ur="فلٹر کریں">Filter</button>
                            <button id="supplier-ledger-clear-filter-btn" class="btn btn-secondary btn-icon" data-en="Clear" data-ur="صاف کریں">Clear</button>
                        </div>
                         <div>
                            <button id="add-manual-transaction-btn-supplier" class="btn btn-primary no-print" data-en="Add Manual Transaction" data-ur="دستی لین دین شامل کریں">Add Transaction</button>
                        </div>
                    </div>
                     <div style="overflow-x: auto;"> <table class="data-table" id="transaction-table-supplier"></table></div>
                     <div class="supplier-balance-summary" style="text-align: right; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                        <span data-en="Current Balance:" data-ur="موجودہ بیلنس:">Current Balance:</span> <span id="details-current-balance-supplier">Rs 0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Inventory -->
        <div id="inventory-page" class="page">
            <div class="section">
                <div class="section-header">
                    <h2 data-en="Product Inventory" data-ur="مصنوعات کی انوینٹری">Product Inventory</h2>
                    <div>
                        <button id="add-product-btn" class="btn btn-primary no-print" data-en="Add New Product" data-ur="نئی پروڈکٹ شامل کریں">Add New Product</button>
                        <button id="adjust-stock-btn" class="btn btn-info no-print" data-en="Adjust Stock" data-ur="اسٹاک ایڈجسٹ کریں">Adjust Stock</button>
                    </div>
                </div>
                 <div class="filter-controls no-print">
                     <input type="text" id="product-search" placeholder="Search Products..." data-en-placeholder="Search Products..." data-ur-placeholder="پروڈکٹس تلاش کریں...">
                 </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="product-table">
                        <thead>
                            <tr>
                                <th data-en="Product Name" data-ur="پروڈکٹ کا نام">Product Name</th>
                                <th data-en="Category" data-ur="زمرہ">Category</th>
                                <th data-en="SKU" data-ur="ایس کے یو">SKU</th>
                                <th data-en="Sale Price" data-ur="فروخت کی قیمت">Sale Price</th>
                                <th data-en="Purchase Price" data-ur="خریداری کی قیمت" class="hide-mobile">Purchase Price</th>
                                <th data-en="Stock" data-ur="اسٹاک">Stock</th>
                                <th data-en="Status" data-ur="حیثیت">Status</th>
                                <th data-en="Actions" data-ur="کاروائیاں" class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page: Accounting (Income/Expenses) -->
        <div id="accounting-page" class="page">
            <div class="section">
                <div class="section-header">
                    <h2 data-en="Income & Expenses" data-ur="آمدنی اور اخراجات">Income & Expenses</h2>
                    <div>
                        <button id="add-income-btn" class="btn btn-success no-print" data-en="Add Income" data-ur="آمدنی شامل کریں">Add Income</button>
                        <button id="add-expense-btn" class="btn btn-danger no-print" data-en="Add Expense" data-ur="خرچہ شامل کریں">Add Expense</button>
                    </div>
                </div>
                <div class="filter-controls">
                    <label for="accounting-start-date" data-en="From:" data-ur="سے:">From:</label>
                    <input type="date" id="accounting-start-date">
                    <label for="accounting-end-date" data-en="To:" data-ur="تک:">To:</label>
                    <input type="date" id="accounting-end-date">
                    <button id="accounting-filter-btn" class="btn btn-primary btn-icon" data-en="Filter" data-ur="فلٹر کریں">Filter</button>
                    <button id="accounting-clear-filter-btn" class="btn btn-secondary btn-icon" data-en="Clear" data-ur="صاف کریں">Clear</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="accounting-table">
                        <thead>
                            <tr>
                                <th data-en="Date" data-ur="تاریخ">Date</th>
                                <th data-en="Type" data-ur="قسم">Type</th>
                                <th data-en="Category" data-ur="زمرہ">Category</th>
                                <th data-en="Description" data-ur="تفصیل">Description</th>
                                <th data-en="Amount" data-ur="رقم">Amount</th>
                                <th data-en="Actions" data-ur="کاروائیاں">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accounting-table-body"></tbody>
                    </table>
                </div>
                <div style="text-align: right; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                    <p><span data-en="Total Income:" data-ur="کل آمدنی:">Total Income:</span> <span id="accounting-total-income">Rs 0.00</span></p>
                    <p><span data-en="Total Expenses:" data-ur="کل اخراجات:">Total Expenses:</span> <span id="accounting-total-expenses">Rs 0.00</span></p>
                    <p><span data-en="Net Profit:" data-ur="خالص منافع:">Net Profit:</span> <span id="accounting-net-profit">Rs 0.00</span></p>
                </div>
            </div>
        </div>

        <!-- Page: Reports -->
        <div id="reports-page" class="page">
            <div class="section no-print">
                <h2 data-en="Reports" data-ur="رپورٹس">Reports</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="report-type-select" data-en="Report Type" data-ur="رپورٹ کی قسم">Report Type</label>
                        <select id="report-type-select">
                            <option value="sales" data-en="Sales Report" data-ur="سیلز رپورٹ">Sales Report</option>
                            <option value="purchases" data-en="Purchase Report" data-ur="پرچیز رپورٹ">Purchase Report</option>
                            <option value="profit_loss_statement" data-en="Profit & Loss Statement" data-ur="نفع و نقصان کا بیان">Profit & Loss Statement</option>
                            <option value="inventory" data-en="Inventory Report" data-ur="انوینٹری رپورٹ">Inventory Report</option>
                            <option value="customer_ledger" data-en="Customer Ledger" data-ur="کسٹمر لیجر">Customer Ledger</option>
                            <option value="supplier_ledger" data-en="Supplier Ledger" data-ur="سپلائر لیجر">Supplier Ledger</option>
                            <option value="income_report" data-en="Income Report (Categorized)" data-ur="آمدنی کی رپورٹ (زمرہ بندی شدہ)">Income Report (Categorized)</option>
                            <option value="expense_report" data-en="Expense Report (Categorized)" data-ur="خرچ کی رپورٹ (زمرہ بندی شدہ)">Expense Report (Categorized)</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="report-start-date" data-en="Start Date" data-ur="شروعاتی تاریخ">Start Date</label>
                        <input type="date" id="report-start-date">
                    </div>
                     <div class="form-group">
                        <label for="report-end-date" data-en="End Date" data-ur="اختتامی تاریخ">End Date</label>
                        <input type="date" id="report-end-date">
                    </div>
                    <div class="form-group" id="report-entity-selector-div" style="display:none;">
                        <label for="report-entity-select" data-en="Select Entity" data-ur="اینٹیٹی منتخب کریں">Select Entity</label>
                        <select id="report-entity-select"></select>
                    </div>
                </div>
                <div>
                     <button id="generate-report-btn" class="btn btn-primary" data-en="Generate Report" data-ur="رپورٹ بنائیں">Generate Report</button>
                     <button id="print-report-btn" class="btn btn-secondary" data-en="Print / PDF" data-ur="پرنٹ / پی ڈی ایف" disabled>Print / PDF</button>
                     <button id="export-csv-btn" class="btn btn-success" data-en="Export to Excel (CSV)" data-ur="ایکسل میں ایکسپورٹ" disabled>Export to Excel (CSV)</button>
                </div>
            </div>
            <div id="report-output">
                <p data-en="Select a report type and date range, then click 'Generate Report'." data-ur="رپورٹ کی قسم اور تاریخ کی حد منتخب کریں، پھر 'رپورٹ بنائیں' پر کلک کریں۔">Select a report type and date range, then click 'Generate Report'.</p>
            </div>
        </div>

        <!-- Page: Settings -->
        <div id="settings-page" class="page">
            <div class="section">
                <h2 data-en="General Settings" data-ur="عمومی سیٹنگز">General Settings</h2>
                <form id="general-settings-form">
                    <div class="form-group">
                        <label for="shop-name" data-en="Shop Name" data-ur="دکان کا نام">Shop Name</label>
                        <input type="text" id="shop-name" class="ledger-input">
                    </div>
                    <div class="form-group">
                        <label for="shop-phone" data-en="Shop Phone" data-ur="دکان کا فون">Shop Phone</label>
                        <input type="tel" id="shop-phone" class="ledger-input">
                    </div>
                    <div class="form-group">
                        <label for="shop-address" data-en="Shop Address" data-ur="دکان کا پتہ">Shop Address</label>
                        <textarea id="shop-address" class="ledger-textarea"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" data-en="Save Settings" data-ur="سیٹنگز محفوظ کریں">Save Settings</button>
                </form>
            </div>
            <div class="section">
                <h2 data-en="Categories Management" data-ur="اقسام کا انتظام">Categories Management</h2>
                <h3 data-en="Income Categories" data-ur="آمدنی کی اقسام">Income Categories</h3>
                <div class="filter-controls">
                    <input type="text" id="new-income-category-name" placeholder="New Income Category Name" data-en-placeholder="New Income Category Name" data-ur-placeholder="آمدنی کی نئی قسم کا نام">
                    <button id="add-income-category-btn" class="btn btn-primary" data-en="Add Income Category" data-ur="آمدنی کی قسم شامل کریں">Add Income Category</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="income-categories-table"><thead><tr><th>Category Name</th><th>Actions</th></tr></thead><tbody id="income-categories-table-body"></tbody></table>
                </div>

                <h3 data-en="Expense Categories" data-ur="اخراجات کی اقسام">Expense Categories</h3>
                <div class="filter-controls">
                    <input type="text" id="new-expense-category-name" placeholder="New Expense Category Name" data-en-placeholder="New Expense Category Name" data-ur-placeholder="اخراجات کی نئی قسم کا نام">
                    <button id="add-expense-category-btn" class="btn btn-primary" data-en="Add Expense Category" data-ur="اخراجات کی قسم شامل کریں">Add Expense Category</button>
                </div>
                 <div style="overflow-x: auto;">
                    <table class="data-table" id="expense-categories-table"><thead><tr><th>Category Name</th><th>Actions</th></tr></thead><tbody id="expense-categories-table-body"></tbody></table>
                </div>
            </div>
             <div id="backup-restore-section" class="section no-print">
                <h3 data-en="Backup & Restore" data-ur="بیک اپ اور بحال کریں">Backup & Restore</h3>
                <button id="backup-btn" class="btn btn-secondary" data-en="Backup Data (JSON)" data-ur="ڈیٹا بیک اپ (JSON)">Backup Data (JSON)</button>
                <label for="restore-file" class="btn btn-warning" data-en="Restore Data (JSON)" data-ur="ڈیٹا بحال کریں (JSON)">Restore Data (JSON)</label>
                <input type="file" id="restore-file" accept=".json" style="display: none;">
            </div>
             <div class="section no-print">
                 <h3 data-en="Data Import/Export" data-ur="ڈیٹا درآمد/برآمد">Data Import/Export</h3>
                 <button id="export-customers-btn" class="btn btn-info" data-en="Export Customers" data-ur="صارفین برآمد کریں">Export Customers</button>
                 <button id="export-products-btn" class="btn btn-info" data-en="Export Products" data-ur="مصنوعات برآمد کریں">Export Products</button>
                 <button id="export-transactions-btn" class="btn btn-info" data-en="Export All Transactions" data-ur="تمام لین دین برآمد کریں">Export All Transactions</button>
             </div>
        </div>


        <!-- Printable Report Area -->
        <div id="printable-report-content" style="display: none;">
            <h2 id="printable-report-title"></h2>
            <h3 id="printable-report-period"></h3>
            <div id="printable-report-table"></div>
            <div id="printable-report-summary" style="margin-top: 20px; text-align: right; font-weight: bold; font-size: 1.1em;"></div>
        </div>

        <!-- Printable Bill/Invoice Area -->
        <div id="printable-bill-invoice" class="printable-bill-invoice" style="display: none;">
            <div class="shop-info">
                <h2 id="print-shop-name">Your Shop Name</h2>
                <p id="print-shop-phone">Phone: N/A</p>
                <p id="print-shop-address">Address: N/A</p>
            </div>
            <h3 id="print-bill-type">Sale Invoice</h3>
            <div class="header-info">
                <div id="print-entity-info"></div>
                <div id="print-transaction-info"></div>
            </div>
            <table class="item-table">
                <thead><tr><th>#</th><th data-en="Product" data-ur="پروڈکٹ">Product</th><th data-en="Qty" data-ur="مقدار">Qty</th><th data-en="Unit Price" data-ur="فی یونٹ قیمت">Unit Price</th><th data-en="Item Total" data-ur="آئٹم کل">Item Total</th></tr></thead>
                <tbody id="print-item-details"></tbody>
            </table>
            <div class="totals">
                <p><span data-en="Grand Total:" data-ur="کل رقم:">Grand Total:</span> <span id="print-grand-total">Rs 0.00</span></p>
                <p id="print-amount-paid-line"><span data-en="Amount Paid:" data-ur="ادا شدہ رقم:">Amount Paid:</span> <span id="print-amount-paid">Rs 0.00</span></p>
                <p id="print-balance-due-line"><span data-en="Balance Due:" data-ur="بقایا رقم:">Balance Due:</span> <span id="print-balance-due">Rs 0.00</span></p>
            </div>
            <div class="footer-notes">
                <p data-en="Thank you for your business!" data-ur="آپ کے کاروبار کا شکریہ!">Thank you for your business!</p>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- Customer Form Modal -->
    <div id="customer-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('customer-form-modal')">&times;</span>
            <h3 id="customer-modal-title">Add New Customer</h3>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="form-group">
                    <label for="customer-name" data-en="Name" data-ur="نام">Name</label>
                    <input type="text" id="customer-name" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="customer-phone" data-en="Phone (Optional)" data-ur="فون (اختیاری)">Phone</label>
                    <input type="tel" id="customer-phone" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="customer-address" data-en="Address (Optional)" data-ur="پتہ (اختیاری)">Address</label>
                    <textarea id="customer-address" class="ledger-textarea"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Customer" data-ur="صارف محفوظ کریں">Save Customer</button>
            </form>
        </div>
    </div>

    <!-- Supplier Form Modal -->
    <div id="supplier-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('supplier-form-modal')">&times;</span>
            <h3 id="supplier-modal-title">Add New Supplier</h3>
            <form id="supplier-form">
                <input type="hidden" id="supplier-id">
                <div class="form-group">
                    <label for="supplier-name" data-en="Name" data-ur="نام">Name</label>
                    <input type="text" id="supplier-name" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="supplier-phone" data-en="Phone (Optional)" data-ur="فون (اختیاری)">Phone</label>
                    <input type="tel" id="supplier-phone" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="supplier-address" data-en="Address (Optional)" data-ur="پتہ (اختیاری)">Address</label>
                    <textarea id="supplier-address" class="ledger-textarea"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Supplier" data-ur="سپلائر محفوظ کریں">Save Supplier</button>
            </form>
        </div>
    </div>

    <!-- Product Form Modal -->
    <div id="product-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('product-form-modal')">&times;</span>
            <h3 id="product-modal-title">Add New Product</h3>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name" data-en="Product Name" data-ur="پروڈکٹ کا نام">Product Name</label>
                    <input type="text" id="product-name" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="product-category" data-en="Category (Optional)" data-ur="زمرہ (اختیاری)">Category</label>
                    <input type="text" id="product-category" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="product-sku" data-en="SKU / Barcode (Optional)" data-ur="ایس کے یو / بار کوڈ (اختیاری)">SKU / Barcode</label>
                    <input type="text" id="product-sku" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="product-sale-price" data-en="Sale Price (Rs)" data-ur="فروخت کی قیمت (روپے)">Sale Price</label>
                    <input type="number" id="product-sale-price" class="ledger-input" step="0.01" min="0" required>
                </div>
                 <div class="form-group">
                    <label for="product-purchase-price" data-en="Purchase Price (Rs)" data-ur="خریداری کی قیمت (روپے)">Purchase Price</label>
                    <input type="number" id="product-purchase-price" class="ledger-input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-quantity" data-en="Initial Stock Quantity" data-ur="ابتدائی اسٹاک مقدار">Initial Stock Quantity</label>
                    <input type="number" id="product-quantity" class="ledger-input" step="1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-low-stock" data-en="Low Stock Alert Level" data-ur="کم اسٹاک الرٹ لیول">Low Stock Alert Level</label>
                    <input type="number" id="product-low-stock" class="ledger-input" step="1" min="0" value="5">
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Product" data-ur="پروڈکٹ محفوظ کریں">Save Product</button>
            </form>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="stock-adjustment-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('stock-adjustment-modal')">&times;</span>
            <h3 data-en="Adjust Stock for" data-ur="اسٹاک ایڈجسٹ کریں">Adjust Stock for <span id="adj-product-name"></span></h3>
            <form id="stock-adjustment-form">
                <input type="hidden" id="adj-product-id">
                <div class="form-group">
                    <label for="adj-current-stock" data-en="Current Stock" data-ur="موجودہ اسٹاک">Current Stock</label>
                    <input type="number" id="adj-current-stock" class="ledger-input" disabled>
                </div>
                <div class="form-group">
                    <label for="adj-type" data-en="Adjustment Type" data-ur="ایڈجسٹمنٹ کی قسم">Adjustment Type</label>
                    <select id="adj-type" class="ledger-select">
                        <option value="add" data-en="Add Stock" data-ur="اسٹاک شامل کریں">Add Stock</option>
                        <option value="deduct" data-en="Deduct Stock" data-ur="اسٹاک کم کریں">Deduct Stock</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adj-quantity" data-en="Quantity to Adjust" data-ur="ایڈجسٹ کرنے کی مقدار">Quantity to Adjust</label>
                    <input type="number" id="adj-quantity" class="ledger-input" min="1" required>
                </div>
                <div class="form-group">
                    <label for="adj-reason" data-en="Reason (e.g., Damage, Theft)" data-ur="وجہ (مثلاً، نقصان، چوری)">Reason</label>
                    <textarea id="adj-reason" class="ledger-textarea" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Apply Adjustment" data-ur="ایڈجسٹمنٹ لاگو کریں">Apply Adjustment</button>
            </form>
        </div>
    </div>


    <!-- Manual Transaction Modal -->
    <div id="transaction-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('transaction-form-modal')">&times;</span>
            <h3><span data-en="Add Manual Transaction for" data-ur="کے لیے دستی لین دین شامل کریں"></span> <span id="transaction-modal-entity-name"></span></h3>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id"> <!-- For editing manual transactions -->
                <input type="hidden" id="transaction-entity-id">
                <input type="hidden" id="transaction-entity-type">
                <div class="form-group">
                    <label for="transaction-date" data-en="Date" data-ur="تاریخ">Date</label>
                    <input type="date" id="transaction-date" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="transaction-type" data-en="Transaction Type" data-ur="لین دین کی قسم">Transaction Type</label>
                    <select id="transaction-type" class="ledger-select" required>
                        <option value="debit" data-en="Debit (Payment Made / Sale)" data-ur="ڈیبٹ (ادائیگی کی / فروخت)">Debit (Payment Made / Sale)</option>
                        <option value="credit" data-en="Credit (Payment Received)" data-ur="کریڈٹ (ادائیگی وصول کی)">Credit (Payment Received)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-amount" data-en="Amount (Rs)" data-ur="رقم (روپے)">Amount (Rs)</label>
                    <input type="number" id="transaction-amount" class="ledger-input" step="0.01" min="0.01" required>
                </div>
                 <div class="form-group">
                    <label for="transaction-description" data-en="Description" data-ur="تفصیل">Description</label>
                    <textarea id="transaction-description" class="ledger-textarea" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Transaction" data-ur="لین دین محفوظ کریں">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Income/Expense Form Modal -->
    <div id="accounting-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('accounting-form-modal')">&times;</span>
            <h3 id="accounting-modal-title">Add Income</h3>
            <form id="accounting-form">
                <input type="hidden" id="accounting-entry-id">
                <input type="hidden" id="accounting-entry-type"> <!-- 'income' or 'expense' -->
                <div class="form-group">
                    <label for="accounting-date" data-en="Date" data-ur="تاریخ">Date</label>
                    <input type="date" id="accounting-date" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="accounting-category" data-en="Category" data-ur="زمرہ">Category</label>
                    <select id="accounting-category" class="ledger-select" required></select>
                </div>
                 <div class="form-group" id="accounting-supplier-group" style="display:none;">
                    <label for="accounting-supplier" data-en="Supplier (Optional)" data-ur="سپلائر (اختیاری)">Supplier</label>
                    <select id="accounting-supplier" class="ledger-select"></select>
                </div>
                <div class="form-group">
                    <label for="accounting-amount" data-en="Amount (Rs)" data-ur="رقم (روپے)">Amount (Rs)</label>
                    <input type="number" id="accounting-amount" class="ledger-input" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="accounting-description" data-en="Description" data-ur="تفصیل">Description</label>
                    <textarea id="accounting-description" class="ledger-textarea"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Entry" data-ur="اندراج محفوظ کریں">Save Entry</button>
            </form>
        </div>
    </div>

    <!-- Sale Form Modal -->
    <div id="sale-form-modal" class="modal">
        <div class="modal-content modal-lg">
            <span class="modal-close" onclick="closeModal('sale-form-modal')">&times;</span>
            <h3 data-en="New Sale / Invoice" data-ur="نئی فروخت / انوائس">New Sale / Invoice</h3>
            <form id="sale-form">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="sale-customer" data-en="Customer (Optional)" data-ur="صارف (اختیاری)">Customer</label>
                        <select id="sale-customer" class="ledger-select"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="sale-date" data-en="Date" data-ur="تاریخ">Date</label>
                        <input type="date" id="sale-date" class="ledger-input" required>
                    </div>
                </div>

                <div class="section">
                    <h4 data-en="Add Products" data-ur="مصنوعات شامل کریں">Add Products</h4>
                    <div class="item-entry-form">
                         <div class="form-group">
                            <label for="sale-product-select" data-en="Product" data-ur="پروڈکٹ">Product</label>
                            <select id="sale-product-select" class="ledger-select"></select>
                        </div>
                        <div class="form-group">
                            <label for="sale-item-qty" data-en="Quantity" data-ur="مقدار">Quantity</label>
                            <input type="number" id="sale-item-qty" class="ledger-input" min="1" value="1">
                        </div>
                        <button type="button" id="add-sale-item-btn" class="btn btn-primary" data-en="Add Item" data-ur="آئٹم شامل کریں">Add Item</button>
                    </div>
                    <table class="data-table">
                        <thead><tr><th data-en="Product" data-ur="پروڈکٹ">Product</th><th data-en="Qty" data-ur="مقدار">Qty</th><th data-en="Price" data-ur="قیمت">Price</th><th data-en="Total" data-ur="کل">Total</th><th></th></tr></thead>
                        <tbody id="sale-items-table-body"></tbody>
                    </table>
                </div>

                <div class="invoice-totals">
                    <span data-en="Total Amount:" data-ur="کل رقم:">Total Amount:</span> <span id="sale-total-amount">Rs 0.00</span>
                </div>

                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="sale-payment-status" data-en="Payment Status" data-ur="ادائیگی کی حیثیت">Payment Status</label>
                        <select id="sale-payment-status" class="ledger-select" required>
                            <option value="paid" data-en="Paid (Cash Sale)" data-ur="ادا شدہ (نقد فروخت)">Paid (Cash Sale)</option>
                            <option value="credit" data-en="Credit (Add to Khata)" data-ur="ادھار (کھاتہ میں شامل کریں)">Credit (Add to Khata)</option>
                            <option value="partially_paid" data-en="Partially Paid" data-ur="جزوی طور پر ادا شدہ">Partially Paid</option>
                        </select>
                    </div>
                    <div class="form-group" id="sale-amount-paid-div" style="flex: 1; display: none;">
                        <label for="sale-amount-paid" data-en="Amount Paid" data-ur="ادا شدہ رقم">Amount Paid</label>
                        <input type="number" id="sale-amount-paid" class="ledger-input" min="0" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn btn-success" data-en="Complete Sale" data-ur="فروخت مکمل کریں">Complete Sale</button>
            </form>
        </div>
    </div>

    <!-- Purchase Form Modal -->
    <div id="purchase-form-modal" class="modal">
         <div class="modal-content modal-lg">
            <span class="modal-close" onclick="closeModal('purchase-form-modal')">&times;</span>
            <h3 data-en="New Purchase" data-ur="نئی خریداری">New Purchase</h3>
            <form id="purchase-form">
                 <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="purchase-supplier" data-en="Supplier" data-ur="سپلائر">Supplier</label>
                        <select id="purchase-supplier" class="ledger-select" required></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="purchase-date" data-en="Date" data-ur="تاریخ">Date</label>
                        <input type="date" id="purchase-date" class="ledger-input" required>
                    </div>
                </div>

                <div class="section">
                    <h4 data-en="Add Products" data-ur="مصنوعات شامل کریں">Add Products</h4>
                     <div class="item-entry-form">
                         <div class="form-group">
                            <label for="purchase-product-select" data-en="Product" data-ur="پروڈکٹ">Product</label>
                            <select id="purchase-product-select" class="ledger-select"></select>
                        </div>
                        <div class="form-group">
                            <label for="purchase-item-qty" data-en="Quantity" data-ur="مقدار">Quantity</label>
                            <input type="number" id="purchase-item-qty" class="ledger-input" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="purchase-item-price" data-en="Unit Price" data-ur="فی یونٹ قیمت">Unit Price</label>
                            <input type="number" id="purchase-item-price" class="ledger-input" min="0" step="0.01">
                        </div>
                        <button type="button" id="add-purchase-item-btn" class="btn btn-primary" data-en="Add Item" data-ur="آئٹم شامل کریں">Add Item</button>
                    </div>
                     <table class="data-table">
                        <thead><tr><th data-en="Product" data-ur="پروڈکٹ">Product</th><th data-en="Qty" data-ur="مقدار">Qty</th><th data-en="Price" data-ur="قیمت">Price</th><th data-en="Total" data-ur="کل">Total</th><th></th></tr></thead>
                        <tbody id="purchase-items-table-body"></tbody>
                    </table>
                </div>

                 <div class="invoice-totals">
                    <span data-en="Total Amount:" data-ur="کل رقم:">Total Amount:</span> <span id="purchase-total-amount">Rs 0.00</span>
                </div>

                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="purchase-payment-status" data-en="Payment Status" data-ur="ادائیگی کی حیثیت">Payment Status</label>
                        <select id="purchase-payment-status" class="ledger-select" required>
                            <option value="paid" data-en="Paid" data-ur="ادا شدہ">Paid</option>
                            <option value="credit" data-en="Credit (Add to Khata)" data-ur="ادھار (کھاتہ میں شامل کریں)">Credit (Add to Khata)</option>
                             <option value="partially_paid" data-en="Partially Paid" data-ur="جزوی طور پر ادا شدہ">Partially Paid</option>
                        </select>
                    </div>
                    <div class="form-group" id="purchase-amount-paid-div" style="flex: 1; display: none;">
                        <label for="purchase-amount-paid" data-en="Amount Paid" data-ur="ادا شدہ رقم">Amount Paid</label>
                        <input type="number" id="purchase-amount-paid" class="ledger-input" min="0" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn btn-success" data-en="Complete Purchase" data-ur="خریداری مکمل کریں">Complete Purchase</button>
            </form>
        </div>
    </div>

    <!-- Sale/Purchase Details Modal (Generic) -->
    <div id="transaction-details-modal" class="modal">
        <div class="modal-content modal-lg">
            <span class="modal-close" onclick="closeModal('transaction-details-modal')">&times;</span>
            <h3 id="transaction-details-title">Sale Details</h3>
            <div id="transaction-details-content">
                <p><strong><span data-en="Date:" data-ur="تاریخ:">Date:</span></strong> <span id="detail-date"></span></p>
                <p><strong><span data-en="Associated Entity:" data-ur="متعلقہ اینٹیٹی:">Associated Entity:</span></strong> <span id="detail-entity"></span></p>
                <p><strong><span data-en="Total Amount:" data-ur="کل رقم:">Total Amount:</span></strong> <span id="detail-total-amount"></span></p>
                <p><strong><span data-en="Payment Status:" data-ur="ادائیگی کی حیثیت:">Payment Status:</span></strong> <span id="detail-payment-status"></span></p>
                <p id="detail-amount-paid-row" style="display: none;"><strong><span data-en="Amount Paid:" data-ur="ادا شدہ رقم:">Amount Paid:</span></strong> <span id="detail-amount-paid"></span></p>

                <h4 style="margin-top: 20px;" data-en="Items" data-ur="آئٹمز">Items</h4>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-en="Product" data-ur="پروڈکٹ">Product</th>
                                <th data-en="Quantity" data-ur="مقدار">Quantity</th>
                                <th data-en="Unit Price" data-ur="فی یونٹ قیمت">Unit Price</th>
                                <th data-en="Item Total" data-ur="آئٹم کل">Item Total</th>
                            </tr>
                        </thead>
                        <tbody id="detail-items-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button id="print-bill-btn" class="btn btn-info no-print" data-en="Print Bill" data-ur="بل پرنٹ کریں">Print Bill</button>
                <button id="delete-sale-purchase-btn" class="btn btn-danger no-print" data-en="Delete Transaction" data-ur="لین دین حذف کریں">Delete Transaction</button>
                <button id="process-return-btn" class="btn btn-warning no-print" data-en="Process Return" data-ur="واپسی پروسیس کریں" style="display: none;">Process Return</button>
            </div>
        </div>
    </div>


    <!-- Return/Refund Modal -->
    <div id="return-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('return-modal')">&times;</span>
            <h3 id="return-modal-title">Process Return</h3>
            <p><span data-en="Transaction ID:" data-ur="لین دین ID:">Transaction ID:</span> <span id="return-transaction-id"></span></p>
            <p><span data-en="Customer/Supplier:" data-ur="صارف/سپلائر:">Customer/Supplier:</span> <span id="return-entity-name"></span></p>
            <p><span data-en="Original Amount:" data-ur="اصل رقم:">Original Amount:</span> <span id="return-original-amount"></span></p>

            <h4 data-en="Items to Return" data-ur="واپس کرنے کے آئٹمز">Items to Return</h4>
            <table class="data-table">
                <thead><tr><th data-en="Product" data-ur="پروڈکٹ">Product</th><th data-en="Max Qty" data-ur="زیادہ سے زیادہ مقدار">Max Qty</th><th data-en="Return Qty" data-ur="واپس کی مقدار">Return Qty</th><th data-en="Price" data-ur="قیمت">Price</th></tr></thead>
                <tbody id="return-items-table-body"></tbody>
            </table>

            <div class="form-group" style="margin-top: 15px;">
                <label for="return-refund-amount" data-en="Refund/Credit Amount" data-ur="رقم کی واپسی/کریڈٹ">Refund/Credit Amount</label>
                <input type="number" id="return-refund-amount" class="ledger-input" step="0.01" min="0" readonly>
            </div>
            <div class="form-group">
                <label for="return-notes" data-en="Return Notes (Optional)" data-ur="واپسی کے نوٹس (اختیاری)">Return Notes</label>
                <textarea id="return-notes" class="ledger-textarea"></textarea>
            </div>
            <button type="button" id="confirm-return-btn" class="btn btn-success" data-en="Confirm Return" data-ur="واپسی کی تصدیق کریں">Confirm Return</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
             <span class="modal-close" onclick="closeModal('alert-modal')">&times;</span>
             <h4 id="alert-title">Alert</h4>
             <p id="alert-message" style="margin: 15px 0;"></p>
             <div id="alert-buttons" style="text-align: right;">
                 <button id="alert-ok-btn" class="btn btn-primary" onclick="closeModal('alert-modal')">OK</button>
                 <button id="alert-confirm-btn" class="btn btn-danger" style="display: none;">Confirm</button>
                 <button id="alert-cancel-btn" class="btn btn-secondary" style="display: none;" onclick="closeModal('alert-modal')">Cancel</button>
             </div>
        </div>
    </div>


    <script>
        // --- Constants and Globals ---
        const DB_NAME = 'CompleteShopDB';
        const DB_VERSION = 4; // Increment for income/expenses/categories/settings stores
        const STORES = {
            CUSTOMERS: 'customers',
            SUPPLIERS: 'suppliers',
            TRANSACTIONS: 'transactions', // Manual Khata entries (customer/supplier)
            PRODUCTS: 'products',
            STOCK_ADJUSTMENTS: 'stockAdjustments', // Stock changes not via sales/purchases
            SALES: 'sales',
            SALE_ITEMS: 'saleItems',
            PURCHASES: 'purchases',
            PURCHASE_ITEMS: 'purchaseItems',
            INCOME: 'income', // New store for direct income entries
            EXPENSES: 'expenses', // New store for expense entries
            CATEGORIES: 'categories', // New store for income/expense categories
            SETTINGS: 'settings' // Application settings
        };

        let db;
        let currentViewedId = null; // Customer/Supplier ID for details view
        let currentViewedType = null; // 'customer' or 'supplier'
        let currentLanguage = localStorage.getItem('khataLanguage') || 'en';
        let currentReportData = null; // To hold data for export/print

        // Sale/Purchase Form State
        let saleItems = [];
        let purchaseItems = [];
        let detailModalTransactionType = null; // To track if sale or purchase being viewed for details modal

        // --- IndexedDB Initialization ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => {
                    console.error("Database error:", event.target.errorCode);
                    customAlert(getLang("Error opening database..."), getLang("Database Error"));
                    reject("Error opening database");
                };
                request.onsuccess = (event) => { db = event.target.result; console.log("Database opened successfully"); resolve(db); };
                request.onupgradeneeded = (event) => {
                    db = event.target.result; console.log("Upgrading database..."); const transaction = event.target.transaction;
                    Object.values(STORES).forEach(storeName => {
                        if (!db.objectStoreNames.contains(storeName)) {
                            const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                            if (storeName === STORES.CUSTOMERS || storeName === STORES.SUPPLIERS || storeName === STORES.PRODUCTS) { store.createIndex('name', 'name', { unique: false }); }
                            if (storeName === STORES.TRANSACTIONS || storeName === STORES.STOCK_ADJUSTMENTS || storeName === STORES.INCOME || storeName === STORES.EXPENSES) { store.createIndex('date', 'date', { unique: false }); }
                            if (storeName === STORES.TRANSACTIONS) { store.createIndex('entityId_type', ['entityId', 'entityType'], { unique: false }); }
                            if (storeName === STORES.SALE_ITEMS) { store.createIndex('saleId', 'saleId', { unique: false }); store.createIndex('productId', 'productId', { unique: false }); }
                            if (storeName === STORES.PURCHASE_ITEMS) { store.createIndex('purchaseId', 'purchaseId', { unique: false }); store.createIndex('productId', 'productId', { unique: false }); }
                            if (storeName === STORES.STOCK_ADJUSTMENTS) { store.createIndex('productId', 'productId', { unique: false }); }
                            if (storeName === STORES.EXPENSES) { store.createIndex('categoryId', 'categoryId', { unique: false }); store.createIndex('supplierId', 'supplierId', { unique: false, multiEntry: true }); }
                            if (storeName === STORES.INCOME) { store.createIndex('categoryId', 'categoryId', { unique: false }); }
                            if (storeName === STORES.CATEGORIES) { store.createIndex('type', 'type', { unique: false }); store.createIndex('name_type', ['name', 'type'], { unique: true });} // New for categories
                            // No indexes for SETTINGS, typically single record
                        }
                    });
                    console.log("Database upgrade complete");
                };
            });
        }

        // --- Generic DB Operations (CRUD Helpers) ---
        function getStore(storeName, mode, transaction = null) {
            return transaction ? transaction.objectStore(storeName) : db.transaction(storeName, mode).objectStore(storeName);
        }
        function promise(request) {
            return new Promise((resolve, reject) => {
                request.onsuccess = event => resolve(event.target.result);
                request.onerror = event => reject(event.target.error);
            });
        }
        function addObject(storeName, object, transaction = null) { return promise(getStore(storeName, 'readwrite', transaction).add(object)); }
        function getObject(storeName, key, transaction = null) { return promise(getStore(storeName, 'readonly', transaction).get(key)); }
        function updateObject(storeName, object, transaction = null) { return promise(getStore(storeName, 'readwrite', transaction).put(object)); }
        function deleteObject(storeName, key, transaction = null) { return promise(getStore(storeName, 'readwrite', transaction).delete(key)); }
        function getAllObjects(storeName, indexName = null, query = null, transaction = null) { return promise((indexName ? getStore(storeName, 'readonly', transaction).index(indexName) : getStore(storeName, 'readonly', transaction)).getAll(query)); }

        // --- UI Rendering & Formatting ---
        function formatCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) return `Rs ---`;
            return `Rs ${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        function formatDate(dateString) {
            if (!dateString) return '';
             const date = new Date(dateString + 'T00:00:00');
             if (isNaN(date.getTime())) return 'Invalid Date';
            const options = { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Karachi' };
            try { return date.toLocaleDateString('en-PK', options); }
            catch (e) { return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
        }
        function renderBalance(balance) {
            const amount = parseFloat(balance);
            if (isNaN(amount)) return `<span>Rs ---</span>`;
            const formatted = formatCurrency(Math.abs(amount));
            if (amount > 0.005) { return `<span class="balance-negative">${formatted} (${getLang('Lena Hai')})</span>`; }
            else if (amount < -0.005) { return `<span class="balance-positive">${formatted} (${getLang('Dena Hai')})</span>`; }
            else { return `<span>${formatCurrency(0)} (${getLang('Settled')})</span>`; }
        }

        // --- Core Business Logic: Entities (Customer, Supplier, Product) ---
        async function saveEntity(type, data) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            if (data.id) { const existing = await getObject(storeName, data.id); data.balance = existing.balance; await updateObject(storeName, data); }
            else { data.balance = 0; delete data.id; await addObject(storeName, data); }
            customAlert(getLang(`${type}_saved_successfully`), getLang('Success')); closeModal(`${type}-form-modal`);
            await loadEntities(type); await updateDashboard();
        }
        async function editEntity(type, id) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, id);
            document.getElementById(`${type}-id`).value = entity.id; document.getElementById(`${type}-name`).value = entity.name;
            document.getElementById(`${type}-phone`).value = entity.phone || ''; document.getElementById(`${type}-address`).value = entity.address || '';
            document.getElementById(`${type}-modal-title`).textContent = getLang(`Edit ${type}`); openModal(`${type}-form-modal`);
        }
        async function confirmDeleteEntity(type, id) {
             customConfirm(getLang(`confirm_delete_${type}`),getLang("Confirm Deletion"), async () => {
                    const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
                    await deleteObject(storeName, id);
                    customAlert(getLang(`${type}_deleted_successfully`), getLang("Deleted"));
                    if (currentViewedId === id && currentViewedType === type) showListView(type);
                    await loadEntities(type); await updateDashboard();
                });
        }
        async function loadEntities(type, searchTerm = '') {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entities = await getAllObjects(storeName);
            const tableBody = document.getElementById(`${type}-table-body`); tableBody.innerHTML = '';
            const filtered = entities.filter(e => (e.name?.toLowerCase().includes(searchTerm.toLowerCase()) || e.phone?.includes(searchTerm)));
            if (filtered.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">${getLang(`no_${type}s_found`)}</td></tr>`; return; }
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            filtered.forEach(entity => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td><a href="#" onclick="event.preventDefault(); showDetailsView('${type}', ${entity.id});">${entity.name}</a></td>
                    <td class="hide-mobile">${entity.phone || '-'}</td><td>${renderBalance(entity.balance)}</td>
                    <td class="no-print"><button class="btn btn-warning btn-icon" onclick="editEntity('${type}', ${entity.id})" title="${getLang('Edit')}">✏️</button>
                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteEntity('${type}', ${entity.id})" title="${getLang('Delete')}">🗑️</button></td>`;
            });
        }

        // Product Logic
        async function saveProduct(productData) {
            if (productData.id) { const existing = await getObject(STORES.PRODUCTS, productData.id); productData.quantity = existing.quantity; await updateObject(STORES.PRODUCTS, productData); }
            else { delete productData.id; await addObject(STORES.PRODUCTS, productData); }
            customAlert(getLang('product_saved_successfully'), getLang('Success')); closeModal('product-form-modal');
            await loadProducts(); await updateDashboard();
        }
        async function editProduct(id) {
             const product = await getObject(STORES.PRODUCTS, id);
             document.getElementById('product-id').value = product.id; document.getElementById('product-name').value = product.name;
             document.getElementById('product-category').value = product.category || ''; document.getElementById('product-sku').value = product.sku || '';
             document.getElementById('product-sale-price').value = product.salePrice; document.getElementById('product-purchase-price').value = product.purchasePrice;
             document.getElementById('product-quantity').value = product.quantity; document.getElementById('product-quantity').disabled = true;
             document.getElementById('product-low-stock').value = product.lowStockThreshold;
             document.getElementById('product-modal-title').textContent = getLang('Edit Product'); openModal('product-form-modal');
        }
        async function confirmDeleteProduct(id) {
            customConfirm(getLang('confirm_delete_product'),getLang('Confirm Deletion'), async () => {
                    await deleteObject(STORES.PRODUCTS, id);
                    customAlert(getLang('product_deleted_successfully'), getLang('Deleted'));
                    await loadProducts(); await updateDashboard();
                });
        }
        async function loadProducts(searchTerm = '') {
            const products = await getAllObjects(STORES.PRODUCTS);
            const tableBody = document.getElementById('product-table-body'); tableBody.innerHTML = '';
            const filtered = products.filter(p => p.name?.toLowerCase().includes(searchTerm.toLowerCase()) || p.sku?.toLowerCase().includes(searchTerm.toLowerCase()) || p.category?.toLowerCase().includes(searchTerm.toLowerCase()));
            if (filtered.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">${getLang('no_products_found')}</td></tr>`; return; }
            filtered.sort((a,b) => a.name.localeCompare(b.name));
            filtered.forEach(p => {
                let status = `<span class="stock-ok">${getLang('In Stock')}</span>`;
                if (p.quantity <= 0) { status = `<span class="stock-out">${getLang('Out of Stock')}</span>`; }
                else if (p.quantity <= p.lowStockThreshold) { status = `<span class="stock-low">${getLang('Low Stock')}</span>`; }
                const row = tableBody.insertRow();
                row.className = p.quantity <= 0 ? 'stock-out-row' : (p.quantity <= p.lowStockThreshold ? 'stock-low-row' : '');
                row.innerHTML = `<td>${p.name}</td><td>${p.category || '-'}</td><td>${p.sku || '-'}</td><td>${formatCurrency(p.salePrice)}</td>
                    <td class="hide-mobile">${formatCurrency(p.purchasePrice)}</td><td>${p.quantity}</td><td>${status}</td>
                    <td class="no-print"><button class="btn btn-warning btn-icon" onclick="editProduct(${p.id})">✏️</button>
                    <button class="btn btn-info btn-icon" onclick="openStockAdjustmentModal(${p.id})">📦</button>
                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteProduct(${p.id})">🗑️</button></td>`;
            });
        }
        async function openStockAdjustmentModal(productId) {
            const product = await getObject(STORES.PRODUCTS, productId);
            if (!product) { customAlert("Product not found.", "Error"); return; }
            document.getElementById('stock-adjustment-form').reset();
            document.getElementById('adj-product-id').value = product.id;
            document.getElementById('adj-product-name').textContent = product.name;
            document.getElementById('adj-current-stock').value = product.quantity;
            openModal('stock-adjustment-modal');
        }
        async function applyStockAdjustment(e) {
            e.preventDefault();
            const productId = parseInt(document.getElementById('adj-product-id').value);
            const type = document.getElementById('adj-type').value;
            const quantity = parseInt(document.getElementById('adj-quantity').value);
            const reason = document.getElementById('adj-reason').value.trim();
            if (!quantity || quantity <= 0) { customAlert("Quantity must be positive.", "Error"); return; }
            if (!reason) { customAlert("Reason is required.", "Error"); return; }

            const transaction = db.transaction([STORES.PRODUCTS, STORES.STOCK_ADJUSTMENTS], 'readwrite');
            try {
                const product = await getObject(STORES.PRODUCTS, productId, transaction);
                if (type === 'add') { product.quantity += quantity; }
                else if (type === 'deduct') {
                    if (product.quantity < quantity) { throw new Error("Cannot deduct more than current stock."); }
                    product.quantity -= quantity;
                }
                await updateObject(STORES.PRODUCTS, product, transaction);
                await addObject(STORES.STOCK_ADJUSTMENTS, { productId, date: new Date().toISOString().split('T')[0], type, quantity, reason, newStock: product.quantity }, transaction);
                await promise(transaction.done);
                customAlert("Stock adjusted successfully.", "Success");
                closeModal('stock-adjustment-modal');
                await loadProducts(); await updateDashboard();
            } catch (err) {
                transaction.abort(); customAlert(`Stock adjustment failed: ${err.message}`, "Error");
            }
        }


        // --- Core Business Logic: Transactions & Balances ---
        async function addTransaction(data, transaction) {
             await addObject(STORES.TRANSACTIONS, data, transaction);
             await updateEntityBalance(data.entityId, data.entityType, transaction);
        }
        async function updateEntityBalance(entityId, entityType, transaction) {
            const allTransactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]), transaction);
            const totalBalance = allTransactions.reduce((bal, tx) => bal + (tx.type === 'debit' ? tx.amount : -tx.amount), 0);
            const storeName = entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, entityId, transaction);
            if (entity) { entity.balance = totalBalance; await updateObject(storeName, entity, transaction); }
        }
        async function getTransactionsForEntity(entityId, entityType, startDate = null, endDate = null) {
            let transactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]));
            
            if (startDate) transactions = transactions.filter(t => t.date >= startDate);
            if (endDate) transactions = transactions.filter(t => t.date <= endDate);

            transactions.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime() || a.id - b.id);
            let runningBalance = 0;
            if (startDate) {
                const transactionsBeforePeriod = (await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]))).filter(t => t.date < startDate);
                runningBalance = transactionsBeforePeriod.reduce((bal, tx) => bal + (tx.type === 'debit' ? tx.amount : -tx.amount), 0);
            }
            return transactions.map(tx => {
                const amount = parseFloat(tx.amount);
                runningBalance += (tx.type === 'debit' ? amount : -amount);
                return { ...tx, balanceAfter: runningBalance };
            });
        }

        // --- UI Navigation & View Management ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`.nav-tab[data-page="${pageId}"]`).classList.add('active');
            const pageActions = {
                'dashboard-page': updateDashboard, 'customers-page': () => loadEntities('customer'),
                'suppliers-page': () => loadEntities('supplier'), 'inventory-page': loadProducts,
                'sales-page': loadSales, 'purchases-page': loadPurchases, 'reports-page': handleReportTypeChange,
                'accounting-page': loadAccountingEntries, 'settings-page': loadSettings
            };
            if(pageActions[pageId]) pageActions[pageId]();
        }
        function showListView(type) {
            document.getElementById(`${type}-details-view`).style.display = 'none'; document.getElementById(`${type}-list-view`).style.display = 'block';
            currentViewedId = null; currentViewedType = null; loadEntities(type);
        }
        async function showDetailsView(type, id) {
             currentViewedId = id; currentViewedType = type;
             const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
             const entity = await getObject(storeName, id);
             if (!entity) { customAlert(getLang(`${type}_not_found`), getLang("Error")); showListView(type); return; }
             document.getElementById(`details-${type}-name`).textContent = entity.name;
             document.getElementById(`${type}-info`).innerHTML = `
                <p><strong>${getLang('Phone')}:</strong> ${entity.phone || '-'} | <strong>${getLang('Address')}:</strong> ${entity.address || '-'}</p>
                <p><strong>${getLang('Current Balance')}:</strong> <span id="details-current-balance-${type}-header">${renderBalance(entity.balance)}</span></p>`;
             
             document.getElementById(`${type}-ledger-start-date`).value = '';
             document.getElementById(`${type}-ledger-end-date`).value = '';

             await loadTransactionsForView(type, id);
             document.getElementById(`${type}-list-view`).style.display = 'none'; document.getElementById(`${type}-details-view`).style.display = 'block';
        }
        async function loadTransactionsForView(type, id) {
            const startDate = document.getElementById(`${type}-ledger-start-date`)?.value || null;
            const endDate = document.getElementById(`${type}-ledger-end-date`)?.value || null;

            const transactions = (await getTransactionsForEntity(id, type, startDate, endDate)).reverse();
            const table = document.getElementById(`transaction-table-${type}`);
            const balanceSummary = document.getElementById(`details-current-balance-${type}`);
            const entity = await getObject(type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, id);

            table.innerHTML = `<thead><tr><th>${getLang("Date")}</th><th>${getLang("Description")}</th><th>${getLang("Debit")}</th><th>${getLang("Credit")}</th><th>${getLang("Balance")}</th><th>${getLang("Actions")}</th></tr></thead>
                <tbody>${transactions.map(tx => `<tr><td>${formatDate(tx.date)}</td><td>${tx.description || '-'}</td>
                    <td>${tx.type === 'debit' ? formatCurrency(tx.amount) : '-'}</td><td>${tx.type === 'credit' ? formatCurrency(tx.amount) : '-'}</td>
                    <td>${renderBalance(tx.balanceAfter)}</td>
                    <td><button class="btn btn-warning btn-icon" onclick="editManualTransaction(${tx.id})">✏️</button>
                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteManualTransaction(${tx.id})">🗑️</button></td></tr>`).join('')}</tbody>`;
             if (transactions.length === 0) { table.querySelector('tbody').innerHTML = `<tr><td colspan="6" style="text-align:center;">${getLang('no_transactions_found')}</td></tr>`; }
             balanceSummary.innerHTML = renderBalance(entity.balance);
             document.getElementById(`details-current-balance-${type}-header`).innerHTML = renderBalance(entity.balance);
        }

        async function editManualTransaction(transactionId) {
            const tx = await getObject(STORES.TRANSACTIONS, transactionId);
            if (!tx) { customAlert("Transaction not found.", "Error"); return; }
            document.getElementById('transaction-id').value = tx.id;
            document.getElementById('transaction-entity-id').value = tx.entityId;
            document.getElementById('transaction-entity-type').value = tx.entityType;
            document.getElementById('transaction-modal-entity-name').textContent = (await getObject(tx.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, tx.entityId))?.name || 'N/A';
            document.getElementById('transaction-date').value = tx.date;
            document.getElementById('transaction-type').value = tx.type;
            document.getElementById('transaction-amount').value = tx.amount;
            document.getElementById('transaction-description').value = tx.description;
            openModal('transaction-form-modal');
        }

        async function confirmDeleteManualTransaction(transactionId) {
            customConfirm(getLang("Are you sure you want to delete this manual transaction?"), getLang("Confirm Deletion"), async () => {
                const tx = await getObject(STORES.TRANSACTIONS, transactionId);
                if (!tx) { customAlert("Transaction not found.", "Error"); return; }
                const transaction = db.transaction([STORES.TRANSACTIONS, STORES.CUSTOMERS, STORES.SUPPLIERS], 'readwrite');
                try {
                    await deleteObject(STORES.TRANSACTIONS, transactionId, transaction);
                    await updateEntityBalance(tx.entityId, tx.entityType, transaction);
                    await promise(transaction.done);
                    customAlert("Manual transaction deleted successfully.", "Success");
                    await loadTransactionsForView(tx.entityType, tx.entityId);
                }
                catch (err) { transaction.abort(); customAlert(`Deletion failed: ${err.message}`, "Error"); }
            });
        }


        // --- Event Listener Setup ---
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => switchPage(tab.dataset.page)));
            document.getElementById('add-customer-btn').addEventListener('click', () => {
                document.getElementById('customer-form').reset(); document.getElementById('customer-id').value = '';
                document.getElementById('customer-modal-title').textContent = getLang('Add New Customer'); openModal('customer-form-modal');
            });
            document.getElementById('customer-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveEntity('customer', { id: parseInt(document.getElementById('customer-id').value) || null, name: document.getElementById('customer-name').value.trim(), phone: document.getElementById('customer-phone').value.trim(), address: document.getElementById('customer-address').value.trim(), });
            });
            document.getElementById('customer-search').addEventListener('input', (e) => loadEntities('customer', e.target.value));
            document.getElementById('back-to-list-btn-customer').addEventListener('click', () => showListView('customer'));
            document.getElementById('add-manual-transaction-btn-customer').addEventListener('click', () => openManualTransactionModal('customer', currentViewedId));
            document.getElementById('customer-ledger-filter-btn').addEventListener('click', () => loadTransactionsForView('customer', currentViewedId));
            document.getElementById('customer-ledger-clear-filter-btn').addEventListener('click', () => { document.getElementById('customer-ledger-start-date').value = ''; document.getElementById('customer-ledger-end-date').value = ''; loadTransactionsForView('customer', currentViewedId); });

            document.getElementById('add-supplier-btn').addEventListener('click', () => {
                document.getElementById('supplier-form').reset(); document.getElementById('supplier-id').value = '';
                document.getElementById('supplier-modal-title').textContent = getLang('Add New Supplier'); openModal('supplier-form-modal');
            });
            document.getElementById('supplier-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveEntity('supplier', { id: parseInt(document.getElementById('supplier-id').value) || null, name: document.getElementById('supplier-name').value.trim(), phone: document.getElementById('supplier-phone').value.trim(), address: document.getElementById('supplier-address').value.trim(), });
            });
            document.getElementById('supplier-search').addEventListener('input', (e) => loadEntities('supplier', e.target.value));
            document.getElementById('back-to-list-btn-supplier').addEventListener('click', () => showListView('supplier'));
            document.getElementById('add-manual-transaction-btn-supplier').addEventListener('click', () => openManualTransactionModal('supplier', currentViewedId));
            document.getElementById('supplier-ledger-filter-btn').addEventListener('click', () => loadTransactionsForView('supplier', currentViewedId));
            document.getElementById('supplier-ledger-clear-filter-btn').addEventListener('click', () => { document.getElementById('supplier-ledger-start-date').value = ''; document.getElementById('supplier-ledger-end-date').value = ''; loadTransactionsForView('supplier', currentViewedId); });


            document.getElementById('add-product-btn').addEventListener('click', () => {
                document.getElementById('product-form').reset(); document.getElementById('product-id').value = '';
                document.getElementById('product-quantity').disabled = false;
                document.getElementById('product-modal-title').textContent = getLang('Add New Product'); openModal('product-form-modal');
            });
            document.getElementById('product-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveProduct({ id: parseInt(document.getElementById('product-id').value) || null, name: document.getElementById('product-name').value.trim(), category: document.getElementById('product-category').value.trim(), sku: document.getElementById('product-sku').value.trim(), salePrice: parseFloat(document.getElementById('product-sale-price').value), purchasePrice: parseFloat(document.getElementById('product-purchase-price').value), quantity: parseInt(document.getElementById('product-quantity').value), lowStockThreshold: parseInt(document.getElementById('product-low-stock').value) });
            });
            document.getElementById('product-search').addEventListener('input', (e) => loadProducts(e.target.value));
            document.getElementById('adjust-stock-btn').addEventListener('click', () => { customAlert("Select a product from the table first, then click the '📦' icon to adjust its stock.", "Info"); });
            document.getElementById('stock-adjustment-form').addEventListener('submit', applyStockAdjustment);


            document.getElementById('transaction-form').addEventListener('submit', async e => {
                e.preventDefault(); 
                const transaction = db.transaction([STORES.TRANSACTIONS, STORES.CUSTOMERS, STORES.SUPPLIERS], 'readwrite');
                const data = { id: parseInt(document.getElementById('transaction-id').value) || null, entityId: parseInt(document.getElementById('transaction-entity-id').value), entityType: document.getElementById('transaction-entity-type').value, date: document.getElementById('transaction-date').value, type: document.getElementById('transaction-type').value, amount: parseFloat(document.getElementById('transaction-amount').value), description: document.getElementById('transaction-description').value.trim() };
                
                if (data.id) { // Editing existing manual transaction
                    const oldTx = await getObject(STORES.TRANSACTIONS, data.id, transaction);
                    // Revert old transaction's impact before applying new one
                    const tempEntity = await getObject(oldTx.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, oldTx.entityId, transaction);
                    tempEntity.balance -= (oldTx.type === 'debit' ? oldTx.amount : -oldTx.amount);
                    await updateObject(tempEntity.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, tempEntity, transaction);
                    
                    await updateObject(STORES.TRANSACTIONS, data, transaction);
                } else { // Adding new manual transaction
                    await addObject(STORES.TRANSACTIONS, data, transaction);
                }
                await updateEntityBalance(data.entityId, data.entityType, transaction);

                await promise(transaction.done);
                customAlert(getLang('transaction_saved_successfully'), getLang('Success')); closeModal('transaction-form-modal');
                await loadTransactionsForView(data.entityType, data.entityId);
            });


             document.getElementById('add-sale-btn').addEventListener('click', openSaleModal);
             document.getElementById('sale-form').addEventListener('submit', completeSale);
             document.getElementById('add-sale-item-btn').addEventListener('click', addSaleItem);
             document.getElementById('sale-payment-status').addEventListener('change', (e) => { document.getElementById('sale-amount-paid-div').style.display = e.target.value === 'partially_paid' ? 'block' : 'none'; });
             document.getElementById('sale-product-select').addEventListener('change', (e) => {}); // No action needed here, already handled by addSaleItem button

             document.getElementById('add-purchase-btn').addEventListener('click', openPurchaseModal);
             document.getElementById('purchase-form').addEventListener('submit', completePurchase);
             document.getElementById('add-purchase-item-btn').addEventListener('click', addPurchaseItem);
             document.getElementById('purchase-payment-status').addEventListener('change', (e) => { document.getElementById('purchase-amount-paid-div').style.display = e.target.value === 'partially_paid' ? 'block' : 'none'; });
             document.getElementById('purchase-product-select').addEventListener('change', async (e) => {
                 const selectedProductId = parseInt(e.target.value);
                 if (selectedProductId) { const product = await getObject(STORES.PRODUCTS, selectedProductId); document.getElementById('purchase-item-price').value = product.purchasePrice || 0; }
                 else { document.getElementById('purchase-item-price').value = ''; }
             });

             // Sale/Purchase Details Modal buttons
             document.getElementById('print-bill-btn').addEventListener('click', printCurrentBillInvoice);
             document.getElementById('delete-sale-purchase-btn').addEventListener('click', confirmDeleteSaleOrPurchase);
             document.getElementById('process-return-btn').addEventListener('click', openReturnModal);


             document.getElementById('backup-btn').addEventListener('click', backupData);
             document.getElementById('restore-file').addEventListener('change', handleRestoreFile);
             document.getElementById('language-switch').addEventListener('change', (e) => setLanguage(e.target.value));
             document.getElementById('generate-report-btn').addEventListener('click', generateReport);
             document.getElementById('print-report-btn').addEventListener('click', printReport);
             document.getElementById('export-csv-btn').addEventListener('click', exportReportToCSV);
             document.getElementById('report-type-select').addEventListener('change', handleReportTypeChange);

             // Settings page
             document.getElementById('general-settings-form').addEventListener('submit', saveSettings);
             document.getElementById('add-income-category-btn').addEventListener('click', () => addCategory('income'));
             document.getElementById('add-expense-category-btn').addEventListener('click', () => addCategory('expense'));
             document.getElementById('export-customers-btn').addEventListener('click', () => exportDataToCSV(STORES.CUSTOMERS));
             document.getElementById('export-products-btn').addEventListener('click', () => exportDataToCSV(STORES.PRODUCTS));
             document.getElementById('export-transactions-btn').addEventListener('click', () => exportDataToCSV(STORES.TRANSACTIONS));

             // Return modal
             document.getElementById('confirm-return-btn').addEventListener('click', confirmProcessReturn);

             // Accounting page
             document.getElementById('add-income-btn').addEventListener('click', () => openAccountingForm('income'));
             document.getElementById('add-expense-btn').addEventListener('click', () => openAccountingForm('expense'));
             document.getElementById('accounting-form').addEventListener('submit', saveAccountingEntry);
             document.getElementById('accounting-filter-btn').addEventListener('click', loadAccountingEntries);
             document.getElementById('accounting-clear-filter-btn').addEventListener('click', () => { document.getElementById('accounting-start-date').value = ''; document.getElementById('accounting-end-date').value = ''; loadAccountingEntries(); });
             document.getElementById('accounting-entry-type').addEventListener('change', (e) => {
                const type = e.target.value;
                document.getElementById('accounting-supplier-group').style.display = (type === 'expense') ? 'block' : 'none';
                populateCategoriesDropdown(type);
             });
        }
                // --- Accounting Logic ---
        async function openAccountingForm(type, entryId = null) {
            document.getElementById('accounting-form').reset();
            document.getElementById('accounting-entry-id').value = '';
            document.getElementById('accounting-entry-type').value = type;
            document.getElementById('accounting-modal-title').textContent = getLang(`Add ${type.charAt(0).toUpperCase() + type.slice(1)}`);
            document.getElementById('accounting-date').valueAsDate = new Date();

            // Populate categories dropdown
            await populateCategoriesDropdown(type);

            // Populate suppliers dropdown if it's an expense
            if (type === 'expense') {
                document.getElementById('accounting-supplier-group').style.display = 'block';
                const supplierSelect = document.getElementById('accounting-supplier');
                supplierSelect.innerHTML = `<option value="">${getLang('Select Supplier (Optional)')}</option>`;
                const suppliers = await getAllObjects(STORES.SUPPLIERS);
                suppliers.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            } else {
                document.getElementById('accounting-supplier-group').style.display = 'none';
            }

            if (entryId) { // Editing existing entry
                const store = type === 'income' ? STORES.INCOME : STORES.EXPENSES;
                const entry = await getObject(store, entryId);
                if (!entry) { customAlert("Entry not found.", "Error"); return; }
                document.getElementById('accounting-entry-id').value = entry.id;
                document.getElementById('accounting-date').value = entry.date;
                document.getElementById('accounting-category').value = entry.categoryId;
                document.getElementById('accounting-amount').value = entry.amount;
                document.getElementById('accounting-description').value = entry.description || '';
                if (type === 'expense' && entry.supplierId) {
                    document.getElementById('accounting-supplier').value = entry.supplierId;
                }
            }
            openModal('accounting-form-modal');
        }

        async function populateCategoriesDropdown(type) {
            const categorySelect = document.getElementById('accounting-category');
            categorySelect.innerHTML = `<option value="">${getLang('Select Category')}</option>`;
            const categories = await getAllObjects(STORES.CATEGORIES, 'type', type);
            categories.sort((a, b) => a.name.localeCompare(b.name)).forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
        }

        async function saveAccountingEntry(e) {
            e.preventDefault();
            const entryType = document.getElementById('accounting-entry-type').value;
            const storeName = entryType === 'income' ? STORES.INCOME : STORES.EXPENSES;
            const entryId = parseInt(document.getElementById('accounting-entry-id').value) || null;

            const data = {
                id: entryId,
                date: document.getElementById('accounting-date').value,
                categoryId: parseInt(document.getElementById('accounting-category').value),
                amount: parseFloat(document.getElementById('accounting-amount').value),
                description: document.getElementById('accounting-description').value.trim()
            };

            if (!data.categoryId) { customAlert(getLang("Please select a category."), "Error"); return; }
            if (isNaN(data.amount) || data.amount <= 0) { customAlert("Amount must be a positive number.", "Error"); return; }

            if (entryType === 'expense') {
                data.supplierId = parseInt(document.getElementById('accounting-supplier').value) || null;
            }

            try {
                if (data.id) { // Editing
                    await updateObject(storeName, data);
                } else { // Adding
                    delete data.id; // Ensure ID is not set for new auto-incremented entries
                    await addObject(storeName, data);
                }
                customAlert(getLang("Entry saved successfully."), getLang('Success'));
                closeModal('accounting-form-modal');
                await loadAccountingEntries(); // Refresh table
                await updateDashboard();
            } catch (err) {
                console.error("Error saving accounting entry:", err);
                customAlert(`Failed to save entry: ${err.message}`, "Error");
            }
        }

        async function loadAccountingEntries() {
            const startDate = document.getElementById('accounting-start-date').value;
            const endDate = document.getElementById('accounting-end-date').value;

            let allIncome = await getAllObjects(STORES.INCOME);
            let allExpenses = await getAllObjects(STORES.EXPENSES);
            const categories = (await getAllObjects(STORES.CATEGORIES)).reduce((map, c) => (map[c.id] = c.name, map), {});

            if (startDate) {
                allIncome = allIncome.filter(i => i.date >= startDate);
                allExpenses = allExpenses.filter(e => e.date >= startDate);
            }
            if (endDate) {
                allIncome = allIncome.filter(i => i.date <= endDate);
                allExpenses = allExpenses.filter(e => e.date <= endDate);
            }

            const entries = [
                ...allIncome.map(i => ({ ...i, type: 'income', displayAmount: formatCurrency(i.amount) })),
                ...allExpenses.map(e => ({ ...e, type: 'expense', displayAmount: formatCurrency(e.amount) }))
            ];

            entries.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

            const tableBody = document.getElementById('accounting-table-body');
            tableBody.innerHTML = '';
            let totalIncome = 0;
            let totalExpenses = 0;

            if (entries.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${getLang('No entries found for the selected criteria.')}</td></tr>`;
            } else {
                entries.forEach(entry => {
                    const row = tableBody.insertRow();
                    const amountCell = entry.type === 'income' ? `<span class="balance-negative">${entry.displayAmount}</span>` : `<span class="balance-positive">${entry.displayAmount}</span>`;
                    
                    if (entry.type === 'income') totalIncome += entry.amount;
                    else totalExpenses += entry.amount;

                    row.innerHTML = `
                        <td>${formatDate(entry.date)}</td>
                        <td>${getLang(entry.type === 'income' ? 'Income' : 'Expense')}</td>
                        <td>${categories[entry.categoryId] || 'N/A'}</td>
                        <td>${entry.description || '-'}</td>
                        <td>${amountCell}</td>
                        <td>
                            <button class="btn btn-warning btn-icon" onclick="openAccountingForm('${entry.type}', ${entry.id})">✏️</button>
                            <button class="btn btn-danger btn-icon" onclick="confirmDeleteAccountingEntry('${entry.type}', ${entry.id})">🗑️</button>
                        </td>
                    `;
                });
            }

            document.getElementById('accounting-total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('accounting-total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('accounting-net-profit').textContent = formatCurrency(totalIncome - totalExpenses);

            // Update dashboard totals as well for immediate feedback
            await updateDashboard();
        }

        async function confirmDeleteAccountingEntry(type, id) {
            customConfirm(getLang("Are you sure you want to delete this entry?"), getLang("Confirm Deletion"), async () => {
                const store = type === 'income' ? STORES.INCOME : STORES.EXPENSES;
                await deleteObject(store, id);
                customAlert(getLang("Entry deleted successfully."), getLang("Deleted"));
                await loadAccountingEntries();
            });
        }

        // Category management (Settings page)
        async function addCategory(type) {
            const inputId = `new-${type}-category-name`;
            const categoryName = document.getElementById(inputId).value.trim();
            if (!categoryName) { customAlert("Category name cannot be empty.", "Error"); return; }
            try {
                await addObject(STORES.CATEGORIES, { name: categoryName, type: type });
                customAlert(getLang("Category added successfully."), getLang("Success"));
                document.getElementById(inputId).value = '';
                await loadCategories(type);
            } catch (error) {
                if (error.name === 'ConstraintError') { customAlert(getLang("Category already exists."), "Error"); }
                else { customAlert(`Failed to add category: ${error.message}`, "Error"); }
            }
        }

        async function loadCategories(type) {
            const categories = await getAllObjects(STORES.CATEGORIES, 'type', type);
            const tableBody = document.getElementById(`${type}-categories-table-body`);
            tableBody.innerHTML = '';
            categories.forEach(cat => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${cat.name}</td><td><button class="btn btn-danger btn-icon" onclick="confirmDeleteCategory(${cat.id}, '${type}')">🗑️</button></td>`;
            });
        }

        async function confirmDeleteCategory(id, type) {
            customConfirm(getLang("Are you sure you want to delete this category?"), getLang("Confirm Deletion"), async () => {
                const relatedStore = type === 'income' ? STORES.INCOME : STORES.EXPENSES;
                const relatedEntries = await getAllObjects(relatedStore, 'categoryId', id);
                if (relatedEntries.length > 0) {
                    customAlert(getLang("Cannot delete a category that has associated entries."), "Error");
                    return;
                }
                await deleteObject(STORES.CATEGORIES, id);
                customAlert(getLang("Category deleted successfully."), getLang("Deleted"));
                await loadCategories(type);
            });
        }

        async function openManualTransactionModal(type, id) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, id);
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-entity-id').value = id;
            document.getElementById('transaction-entity-type').value = type;
            document.getElementById('transaction-modal-entity-name').textContent = entity.name;
            document.getElementById('transaction-date').valueAsDate = new Date();
            openModal('transaction-form-modal');
        }

        // --- MODAL, ALERT, CONFIRM, and LANGUAGE functions ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) { closeModal(event.target.id); } });

        function customAlert(message, titleKey = "Alert") {
            document.getElementById('alert-title').textContent = getLang(titleKey);
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-confirm-btn').style.display = 'none';
            document.getElementById('alert-cancel-btn').style.display = 'none';
            document.getElementById('alert-ok-btn').style.display = 'inline-block';
            document.getElementById('alert-ok-btn').textContent = getLang("OK");
            openModal('alert-modal');
        }

        function customConfirm(message, titleKey = "Confirm", onConfirm, onCancel = null) {
            document.getElementById('alert-title').textContent = getLang(titleKey);
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-ok-btn').style.display = 'none';
            document.getElementById('alert-confirm-btn').style.display = 'inline-block';
            document.getElementById('alert-cancel-btn').style.display = 'inline-block';
            document.getElementById('alert-confirm-btn').textContent = getLang("Confirm");
            document.getElementById('alert-cancel-btn').textContent = getLang("Cancel");
            const confirmBtn = document.getElementById('alert-confirm-btn');
            confirmBtn.onclick = () => { closeModal('alert-modal'); if (onConfirm) onConfirm(); };
             document.getElementById('alert-cancel-btn').onclick = () => { closeModal('alert-modal'); if (onCancel) onCancel(); };
            openModal('alert-modal');
        }

        const translations = {
            en: {"Shop Management System":"Shop Management System","Dashboard":"Dashboard","Sales":"Sales","Purchases":"Purchases","Customers":"Customers","Suppliers":"Suppliers","Inventory":"Inventory","Accounting":"Accounting","Reports":"Reports","Settings":"Settings","Total Customers":"Total Customers","Receivables (Lena Hai)":"Receivables (Lena Hai)","Payables (Dena Hai)":"Payables (Dena Hai)","Low Stock Items":"Low Stock Items","Total Inventory Value":"Total Inventory Value","Total Income (Period)":"Total Income (Period)","Total Expenses (Period)":"Total Expenses (Period)","Period From:":"Period From:","Period To:":"Period To:","Backup & Restore":"Backup & Restore","Backup Data (JSON)":"Backup Data (JSON)","Restore Data (JSON)":"Restore Data (JSON)","Sales History":"Sales History","New Sale":"New Sale","Date":"Date","Customer":"Customer","Amount":"Amount","Status":"Status","Actions":"Actions","Purchase History":"Purchase History","New Purchase":"New Purchase","Supplier":"Supplier","Add New Customer":"Add New Customer","Search Customers...":"Search Customers...","Name":"Name","Phone":"Phone","Balance":"Balance","no_customers_found":"No customers found.","Edit":"Edit","Delete":"Delete","Customer Details":"Customer Details","Back to List":"Back to List","Address":"Address","Current Balance:":"Current Balance:","Transactions":"Transactions","Add Manual Transaction":"Add Manual Transaction","no_transactions_found":"No transactions found.","Add New Supplier":"Add New Supplier","Search Suppliers...":"Search Suppliers...","no_suppliers_found":"No suppliers found.","Supplier Details":"Supplier Details","Product Inventory":"Product Inventory","Add New Product":"Add New Product","Search Products...":"Search Products...","Product Name":"Product Name","Category":"Category","SKU":"SKU","Sale Price":"Sale Price","Purchase Price":"Purchase Price","Stock":"Stock","no_products_found":"No products found.","Adjust Stock":"Adjust Stock","Income & Expenses":"Income & Expenses","Add Income":"Add Income","Add Expense":"Add Expense","Type":"Type","Description":"Description","Net Profit:":"Net Profit:","Report Type":"Report Type","Sales Report":"Sales Report","Purchase Report":"Purchase Report","Profit & Loss Statement":"Profit & Loss Statement","Inventory Report":"Inventory Report","Customer Ledger":"Customer Ledger","Supplier Ledger":"Supplier Ledger","Income Report (Categorized)":"Income Report (Categorized)","Expense Report (Categorized)":"Expense Report (Categorized)","Start Date":"Start Date","End Date":"End Date","Select Entity":"Select Entity","Generate Report":"Generate Report","Print / PDF":"Print / PDF","Export to Excel (CSV)":"Export to Excel (CSV)","Select a report type and date range, then click 'Generate Report'.":"Select a report type and date range, then click 'Generate Report'.","General Settings":"General Settings","Shop Name":"Shop Name","Shop Phone":"Shop Phone","Shop Address":"Shop Address","Save Settings":"Save Settings","Categories Management":"Categories Management","Income Categories":"Income Categories","New Income Category Name":"New Income Category Name","Add Income Category":"Add Income Category","Expense Categories":"Expense Categories","New Expense Category Name":"New Expense Category Name","Add Expense Category":"Add Expense Category","Data Import/Export":"Data Import/Export","Export Customers":"Export Customers","Export Products":"Export Products","Export All Transactions":"Export All Transactions","Phone (Optional)":"Phone (Optional)","Address (Optional)":"Address (Optional)","Save Customer":"Save Customer","customer_saved_successfully":"Customer saved successfully.","confirm_delete_customer":"Are you sure you want to delete this customer? Their transaction history will remain for reporting.","customer_deleted_successfully":"Customer deleted successfully.","customer_not_found":"Customer not found.","Save Supplier":"Save Supplier","supplier_saved_successfully":"Supplier saved successfully.","confirm_delete_supplier":"Are you sure you want to delete this supplier? Their transaction history will remain for reporting.","supplier_deleted_successfully":"Supplier deleted successfully.","supplier_not_found":"Supplier not found.","Category (Optional)":"Category (Optional)","SKU / Barcode (Optional)":"SKU / Barcode (Optional)","Sale Price (Rs)":"Sale Price (Rs)","Purchase Price (Rs)":"Purchase Price (Rs)","Initial Stock Quantity":"Initial Stock Quantity","Low Stock Alert Level":"Low Stock Alert Level","Save Product":"Save Product","product_saved_successfully":"Product saved successfully.","confirm_delete_product":"Are you sure you want to delete this product?","product_deleted_successfully":"Product deleted successfully.","Edit Product":"Edit Product","In Stock":"In Stock","Out of Stock":"Out of Stock","Low Stock":"Low Stock","Adjust Stock for":"Adjust Stock for","Current Stock":"Current Stock","Adjustment Type":"Adjustment Type","Add Stock":"Add Stock","Deduct Stock":"Deduct Stock","Quantity to Adjust":"Quantity to Adjust","Reason (e.g., Damage, Theft)":"Reason (e.g., Damage, Theft)","Apply Adjustment":"Apply Adjustment","Stock adjusted successfully.":"Stock adjusted successfully.","Quantity must be positive.":"Quantity must be positive.", "Reason is required.":"Reason is required.","Cannot deduct more than current stock.":"Cannot deduct more than current stock.","Stock adjustment failed:":"Stock adjustment failed:","Add Manual Transaction for":"Add Manual Transaction for","Transaction Type":"Transaction Type","Debit (Payment Made / Sale)":"Debit (Payment Made / Sale)","Credit (Payment Received)":"Credit (Payment Received)","Amount (Rs)":"Amount (Rs)","Description":"Description","Save Transaction":"Save Transaction","transaction_saved_successfully":"Transaction saved successfully.","Are you sure you want to delete this manual transaction?":"Are you sure you want to delete this manual transaction?","Manual transaction deleted successfully.":"Manual transaction deleted successfully.","New Sale / Invoice":"New Sale / Invoice","Customer (Optional)":"Customer (Optional)","Add Products":"Add Products","Product":"Product","Quantity":"Quantity","Add Item":"Add Item","Qty":"Qty","Price":"Price","Total":"Total","Total Amount:":"Total Amount:","Payment Status":"Payment Status","Paid (Cash Sale)":"Paid (Cash Sale)","Credit (Add to Khata)":"Credit (Add to Khata)","Partially Paid":"Partially Paid","Amount Paid":"Amount Paid","Complete Sale":"Complete Sale","Please add items to the sale.":"Please add items to the sale.","Selected customer is required for credit sales.":"Selected customer is required for credit sales.","Selected customer is required for partial sales.":"Selected customer is required for partial sales.","Amount paid cannot be equal to or greater than total for a partial payment.":"Amount paid cannot be equal to or greater than total for a partial payment.","Amount paid must be greater than zero for a partial payment.":"Amount paid must be greater than zero for a partial payment.","Sale completed successfully.":"Sale completed successfully.","Sale failed:":"Sale failed:","New Purchase":"New Purchase","Unit Price":"Unit Price","Paid":"Paid","Complete Purchase":"Complete Purchase","Please add items to the purchase.":"Please add items to the purchase.","Purchase completed successfully.":"Purchase completed successfully.","Purchase failed:":"Purchase failed:","Alert":"Alert","OK":"OK","Confirm":"Confirm","Success":"Success","Error":"Error","Deleted":"Deleted","Lena Hai":"Receivable","Dena Hai":"Payable","Settled":"Settled","Language":"Language","Error opening database...":"Error opening database. Please check browser permissions and disable private mode.","Database Error":"Database Error", "Item Total": "Item Total", "Associated Entity:": "Associated Entity:", "Sale Details": "Sale Details", "Purchase Details": "Purchase Details", "Items": "Items", "Print Bill": "Print Bill", "Delete Transaction": "Delete Transaction", "Process Return": "Process Return", "Return Notes (Optional)": "Return Notes (Optional)", "Confirm Return": "Confirm Return", "Transaction ID:": "Transaction ID:", "Customer/Supplier:": "Customer/Supplier:", "Original Amount:": "Original Amount:", "Items to Return": "Items to Return", "Max Qty": "Max Qty", "Return Qty": "Return Qty", "Refund/Credit Amount": "Refund/Credit Amount", "Return processed successfully.":"Return processed successfully.", "Return failed:":"Return failed:", "Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries.":"Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries.", "Sale/Purchase deleted successfully.":"Sale/Purchase deleted successfully.", "Cannot return more than original quantity.":"Cannot return more than original quantity.", "Invalid return quantity.":"Invalid return quantity.", "Please enter a reason for the return.":"Please enter a reason for the return.", "Cannot process return for zero quantity.":"Cannot process return for zero quantity.", "Refund/Return": "Refund/Return", "Supplier Return": "Supplier Return", "Grand Total:": "Grand Total:", "Balance Due:": "Balance Due:", "Thank you for your business!": "Thank you for your business!", "Bill/Invoice": "Bill/Invoice", "Bill": "Bill", "Invoice": "Invoice", "Info": "Info", "Select a product from the table first, then click the '📦' icon to adjust its stock.": "Select a product from the table first, then click the '📦' icon to adjust its stock.", "Settings saved successfully.": "Settings saved successfully.", "Category Name": "Category Name", "Add Category": "Add Category", "Category already exists.":"Category already exists.", "Category added successfully.":"Category added successfully.","Category deleted successfully.":"Category deleted successfully.", "Are you sure you want to delete this category?":"Are you sure you want to delete this category?","Cannot delete a category that has associated entries.":"Cannot delete a category that has associated entries.","Add Income":"Add Income", "Add Expense":"Add Expense", "Save Entry":"Save Entry", "Income Entry":"Income Entry", "Expense Entry":"Expense Entry", "Entry saved successfully.":"Entry saved successfully.","Are you sure you want to delete this entry?":"Are you sure you want to delete this entry?","Entry deleted successfully.":"Entry deleted successfully.","Total Income:":"Total Income:","Total Expenses:":"Total Expenses:","Net Profit:":"Net Profit:","Please select a category.":"Please select a category."
            },
            ur: {"Shop Management System":"شاپ مینجمنٹ سسٹم","Dashboard":"ڈیش بورڈ","Sales":"فروخت","Purchases":"خریداری","Customers":"صارفین","Suppliers":"سپلائرز","Inventory":"انوینٹری","Accounting":"اکاؤنٹنگ","Reports":"رپورٹس","Settings":"سیٹنگز","Total Customers":"کل صارفین","Receivables (Lena Hai)":"واجبات (لینا ہے)","Payables (Dena Hai)":"واجب الادا (دینا ہے)","Low Stock Items":"کم اسٹاک آئٹمز","Total Inventory Value":"کل انوینٹری مالیت","Total Income (Period)":"کل آمدنی (مدت)","Total Expenses (Period)":"کل اخراجات (مدت)","Period From:":"مدت سے:","Period To:":"مدت تک:","Backup & Restore":"بیک اپ اور بحال کریں","Backup Data (JSON)":"ڈیٹا بیک اپ (JSON)","Restore Data (JSON)":"ڈیٹا بحال کریں (JSON)","Sales History":"فروخت کی سرگزشت","New Sale":"نئی فروخت","Date":"تاریخ","Customer":"صارف","Amount":"رقم","Status":"حیثیت","Actions":"کاروائیاں","Purchase History":"خریداری کی سرگزشت","New Purchase":"نئی خریداری","Supplier":"سپلائر","Add New Customer":"نیا صارف شامل کریں","Search Customers...":"صارفین تلاش کریں...","Name":"نام","Phone":"فون","Balance":"بیلنس","no_customers_found":"کوئی صارف نہیں ملا۔","Edit":"ترمیم","Delete":"حذف کریں","Customer Details":"صارف کی تفصیلات","Back to List":"فہرست پر واپس","Address":"پتہ","Current Balance:":"موجودہ بیلنس:","Transactions":"لین دین","Add Manual Transaction":"دستی لین دین شامل کریں","no_transactions_found":"کوئی لین دین نہیں ملا۔","Add New Supplier":"نیا سپلائر شامل کریں","Search Suppliers...":"سپلائرز تلاش کریں...","no_suppliers_found":"کوئی سپلائر نہیں ملا۔","Supplier Details":"سپلائر کی تفصیلات","Product Inventory":"مصنوعات کی انوینٹری","Add New Product":"نئی پروڈکٹ شامل کریں","Search Products...":"پروڈکٹس تلاش کریں...","Product Name":"پروڈکٹ کا نام","Category":"زمرہ","SKU":"ایس کے یو","Sale Price":"فروخت کی قیمت","Purchase Price":"خریداری کی قیمت","Stock":"اسٹاک","no_products_found":"کوئی پروڈکٹ نہیں ملی۔","Adjust Stock":"اسٹاک ایڈجسٹ کریں","Income & Expenses":"آمدنی اور اخراجات","Add Income":"آمدنی شامل کریں","Add Expense":"خرچہ شامل کریں","Type":"قسم","Description":"تفصیل","Net Profit:":"خالص منافع:","Report Type":"رپورٹ کی قسم","Sales Report":"سیلز رپورٹ","Purchase Report":"پرچیز رپورٹ","Profit & Loss Statement":"نفع و نقصان کا بیان","Inventory Report":"انوینٹری رپورٹ","Customer Ledger":"کسٹمر لیجر","Supplier Ledger":"سپلائر لیجر","Income Report (Categorized)":"آمدنی کی رپورٹ (زمرہ بندی شدہ)","Expense Report (Categorized)":"خرچ کی رپورٹ (زمرہ بندی شدہ)","Start Date":"شروعاتی تاریخ","End Date":"اختتامی تاریخ","Select Entity":"اینٹیٹی منتخب کریں","Generate Report":"رپورٹ بنائیں","Print / PDF":"پرنٹ / پی ڈی ایف","Export to Excel (CSV)":"ایکسل میں ایکسپورٹ","Select a report type and date range, then click 'Generate Report'.":"رپورٹ کی قسم اور تاریخ کی حد منتخب کریں، پھر 'رپورٹ بنائیں' پر کلک کریں۔","General Settings":"عمومی سیٹنگز","Shop Name":"دکان کا نام","Shop Phone":"دکان کا فون","Shop Address":"دکان کا پتہ","Save Settings":"سیٹنگز محفوظ کریں","Categories Management":"اقسام کا انتظام","Income Categories":"آمدنی کی اقسام","New Income Category Name":"آمدنی کی نئی قسم کا نام","Add Income Category":"آمدنی کی قسم شامل کریں","Expense Categories":"اخراجات کی اقسام","New Expense Category Name":"اخراجات کی نئی قسم کا نام","Add Expense Category":"اخراجات کی قسم شامل کریں","Data Import/Export":"ڈیٹا درآمد/برآمد","Export Customers":"صارفین برآمد کریں","Export Products":"مصنوعات برآمد کریں","Export All Transactions":"تمام لین دین برآمد کریں","Phone (Optional)":"فون (اختیاری)","Address (Optional)":"پتہ (اختیاری)","Save Customer":"صارف محفوظ کریں","customer_saved_successfully":"صارف کامیابی سے محفوظ ہو گیا۔","confirm_delete_customer":"کیا آپ واقعی اس صارف کو حذف کرنا چاہتے ہیں؟ ان کی لین دین کی تاریخ رپورٹنگ کے لیے باقی رہے گی۔","customer_deleted_successfully":"صارف کامیابی سے حذف ہو گیا۔","customer_not_found":"صارف نہیں ملا۔","Save Supplier":"سپلائر محفوظ کریں","supplier_saved_successfully":"سپلائر کامیابی سے محفوظ ہو گیا۔","confirm_delete_supplier":"کیا آپ واقعی اس سپلائر کو حذف کرنا چاہتے ہیں؟ ان کی لین دین کی تاریخ رپورٹنگ کے لیے باقی رہے گی۔","supplier_deleted_successfully":"سپلائر کامیابی سے حذف ہو گیا۔","supplier_not_found":"سپلائر نہیں ملا۔","Category (Optional)":"زمرہ (اختیاری)","SKU / Barcode (Optional)":"ایس کے یو / بار کوڈ (اختیاری)","Sale Price (Rs)":"فروخت کی قیمت (روپے)","Purchase Price (Rs)":"خریداری کی قیمت (روپے)","Initial Stock Quantity":"ابتدائی اسٹاک مقدار","Low Stock Alert Level":"کم اسٹاک الرٹ لیول","Save Product":"پروڈکٹ محفوظ کریں","product_saved_successfully":"پروڈکٹ کامیابی سے محفوظ ہو گئی۔","confirm_delete_product":"کیا آپ واقعی اس پروڈکٹ کو حذف کرنا چاہتے ہیں؟","product_deleted_successfully":"پروڈکٹ کامیابی سے حذف ہو گئی۔","Edit Product":"پروڈکٹ میں ترمیم کریں","In Stock":"اسٹاک میں ہے","Out of Stock":"اسٹاک ختم","Low Stock":"کم اسٹاک","Adjust Stock for":"اسٹاک ایڈجسٹ کریں","Current Stock":"موجودہ اسٹاک","Adjustment Type":"ایڈجسٹمنٹ کی قسم","Add Stock":"اسٹاک شامل کریں","Deduct Stock":"اسٹاک کم کریں","Quantity to Adjust":"ایڈجسٹ کرنے کی مقدار","Reason (e.g., Damage, Theft)":"وجہ (مثلاً، نقصان، چوری)","Apply Adjustment":"ایڈجسٹمنٹ لاگو کریں","Stock adjusted successfully.":"اسٹاک کامیابی سے ایڈجسٹ ہو گیا۔","Quantity must be positive.":"مقدار مثبت ہونی چاہیے۔","Reason is required.":"وجہ درکار ہے۔","Cannot deduct more than current stock.":"موجودہ اسٹاک سے زیادہ کم نہیں کیا جا سکتا۔","Stock adjustment failed:":"اسٹاک ایڈجسٹمنٹ ناکام:","Add Manual Transaction for":"کے لیے دستی لین دین شامل کریں","Transaction Type":"لین دین کی قسم","Debit (Payment Made / Sale)":"ڈیبٹ (ادائیگی کی / فروخت)","Credit (Payment Received)":"کریڈٹ (ادائیگی وصول کی)","Amount (Rs)":"رقم (روپے)","Description":"تفصیل","Save Transaction":"لین دین محفوظ کریں","transaction_saved_successfully":"لین دین کامیابی سے محفوظ ہو گیا۔","Are you sure you want to delete this manual transaction?":"کیا آپ واقعی اس دستی لین دین کو حذف کرنا چاہتے ہیں؟","Manual transaction deleted successfully.":"دستی لین دین کامیابی سے حذف ہو گیا۔","New Sale / Invoice":"نئی فروخت / انوائس","Customer (Optional)":"صارف (اختیاری)","Add Products":"مصنوعات شامل کریں","Product":"پروڈکٹ","Quantity":"مقدار","Add Item":"آئٹم شامل کریں","Qty":"مقدار","Price":"قیمت","Total":"کل","Total Amount:":"کل رقم:","Payment Status":"ادائیگی کی حیثیت","Paid (Cash Sale)":"ادا شدہ (نقد فروخت)","Credit (Add to Khata)":"ادھار (کھاتہ میں شامل کریں)","Partially Paid":"جزوی طور پر ادا شدہ","Amount Paid":"ادا شدہ رقم","Complete Sale":"فروخت مکمل کریں","Please add items to the sale.":"براہ کرم فروخت میں آئٹمز شامل کریں۔","Selected customer is required for credit sales.":"ادھار فروخت کے لیے صارف کا انتخاب ضروری ہے۔","Selected customer is required for partial sales.":"جزوی فروخت کے لیے صارف کا انتخاب ضروری ہے۔","Amount paid cannot be equal to or greater than total for a partial payment.":"جزوی ادائیگی کے لیے ادا شدہ رقم کل رقم کے برابر یا اس سے زیادہ نہیں ہو سکتی۔","Amount paid must be greater than zero for a partial payment.":"جزوی ادائیگی کے لیے ادا شدہ رقم صفر سے زیادہ ہونی چاہیے۔","Sale completed successfully.":"فروخت کامیابی سے مکمل ہوئی۔","Sale failed:":"فروخت ناکام:","New Purchase":"نئی خریداری","Unit Price":"فی یونٹ قیمت","Paid":"ادا شدہ","Complete Purchase":"خریداری مکمل کریں","Please add items to the purchase.":"براہ کرم خریداری میں آئٹمز شامل کریں۔","Purchase completed successfully.":"خریداری کامیابی سے مکمل ہوئی۔","Purchase failed:":"خریداری ناکام:","Alert":"انتباہ","OK":"ٹھیک ہے","Confirm":"تصدیق کریں","Success":"کامیابی","Error":"خرابی","Deleted":"حذف کر دیا گیا۔","Lena Hai":"لینا ہے","Dena Hai":"دینا ہے","Settled":"حساب برابر","Language":"زبان","Error opening database...":"ڈیٹا بیس کھولنے میں خرابی۔ براہ کرم براؤزر کی اجازت کو چیک کریں اور نجی موڈ کو غیر فعال کریں۔","Database Error":"ڈیٹا بیس کی خرابی", "Item Total": "آئٹم کل", "Associated Entity:": "متعلقہ اینٹیٹی:", "Sale Details": "فروخت کی تفصیلات", "Purchase Details": "خریداری کی تفصیلات", "Items": "آئٹمز", "Print Bill": "بل پرنٹ کریں", "Delete Transaction": "لین دین حذف کریں", "Process Return": "واپسی پروسیس کریں", "Return Notes (Optional)": "واپسی کے نوٹس (اختیاری)", "Confirm Return": "واپسی کی تصدیق کریں", "Transaction ID:": "لین دین ID:", "Customer/Supplier:": "صارف/سپلائر:", "Original Amount:": "اصل رقم:", "Items to Return": "واپس کرنے کے آئٹمز", "Max Qty": "زیادہ سے زیادہ مقدار", "Return Qty": "واپس کی مقدار", "Refund/Credit Amount": "رقم کی واپسی/کریڈٹ", "Return processed successfully.":"واپسی کامیابی سے پروسیس ہو گئی۔", "Return failed:":"واپسی ناکام:", "Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries.":"کیا آپ واقعی اس فروخت/خریداری کو حذف کرنا چاہتے ہیں؟ یہ اسٹاک اور کھاتہ کے اندراجات کو واپس کر دے گا۔", "Sale/Purchase deleted successfully.":"فروخت/خریداری کامیابی سے حذف ہو گئی۔", "Cannot return more than original quantity.":"اصل مقدار سے زیادہ واپس نہیں کیا جا سکتا۔", "Invalid return quantity.":"غلط واپسی مقدار۔", "Please enter a reason for the return.":"براہ کرم واپسی کی وجہ درج کریں۔", "Cannot process return for zero quantity.":"صفر مقدار کے لیے واپسی پروسیس نہیں کی جا سکتی ہے۔", "Refund/Return": "رقم کی واپسی/واپسی", "Supplier Return": "سپلائر واپسی", "Grand Total:": "کل رقم:", "Balance Due:": "بقایا رقم:", "Thank you for your business!": "آپ کے کاروبار کا شکریہ!", "Bill/Invoice": "بل/انوائس", "Bill": "بل", "Invoice": "انوائس", "Info": "معلومات", "Select a product from the table first, then click the '📦' icon to adjust its stock.": "براہ کرم پہلے ٹیبل سے ایک پروڈکٹ منتخب کریں، پھر اس کا اسٹاک ایڈجسٹ کرنے کے لیے '📦' آئیکن پر کلک کریں۔", "Settings saved successfully.": "سیٹنگز کامیابی سے محفوظ ہو گئیں۔", "Category Name": "زمرہ کا نام", "Add Category": "زمرہ شامل کریں", "Category already exists.":"زمرہ پہلے سے موجود ہے۔", "Category added successfully.":"زمرہ کامیابی سے شامل ہو گیا۔","Category deleted successfully.":"زمرہ کامیابی سے حذف ہو گیا۔", "Are you sure you want to delete this category?":"کیا آپ واقعی اس زمرہ کو حذف کرنا چاہتے ہیں؟","Cannot delete a category that has associated entries.":"ایسا زمرہ حذف نہیں کیا جا سکتا جس کے ساتھ متعلقہ اندراجات ہوں۔","Add Income":"آمدنی شامل کریں", "Add Expense":"خرچہ شامل کریں", "Save Entry":"اندراج محفوظ کریں", "Income Entry":"آمدنی کا اندراج", "Expense Entry":"خرچ کا اندراج", "Entry saved successfully.":"اندراج کامیابی سے محفوظ ہو گیا۔","Are you sure you want to delete this entry?":"کیا آپ واقعی اس اندراج کو حذف کرنا چاہتے ہیں؟","Entry deleted successfully.":"اندراج کامیابی سے حذف ہو گیا۔","Total Income:":"کل آمدنی:","Total Expenses:":"کل اخراجات:","Net Profit:":"خالص منافع:","Please select a category.":"براہ کرم ایک زمرہ منتخب کریں۔"
            }
        };

        function getLang(key) {
            return translations[currentLanguage]?.[key] || translations['en']?.[key] || key;
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('khataLanguage', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ur' ? 'rtl' : 'ltr';

            document.querySelectorAll('[data-en]').forEach(el => {
                const key = el.dataset.en;
                if (el.matches('input[placeholder], textarea[placeholder]')) el.placeholder = getLang(key);
                else if (el.tagName === 'OPTION') {
                    const optKey = el.dataset.en || el.value;
                    el.textContent = getLang(optKey);
                }
                else el.textContent = getLang(key);
            });
            const activePage = document.querySelector('.page.active')?.id || 'dashboard-page';
            switchPage(activePage);
        }

        async function updateDashboard() {
            const customers = await getAllObjects(STORES.CUSTOMERS);
            const suppliers = await getAllObjects(STORES.SUPPLIERS);
            const products = await getAllObjects(STORES.PRODUCTS);

            document.getElementById('total-customers').textContent = customers.length;

            let totalReceivables = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
            let totalPayables = suppliers.reduce((sum, s) => sum + (s.balance < 0 ? Math.abs(s.balance) : 0), 0);

            document.getElementById('total-receivables').textContent = formatCurrency(totalReceivables);
            document.getElementById('total-payables').textContent = formatCurrency(totalPayables);

            const lowStockCount = products.filter(p => p.quantity > 0 && p.quantity <= p.lowStockThreshold).length;
            document.getElementById('low-stock-items').textContent = lowStockCount;

            const inventoryValue = products.reduce((sum, p) => sum + (p.purchasePrice * p.quantity), 0);
            document.getElementById('inventory-value').textContent = formatCurrency(inventoryValue);

            // Dashboard Period Income/Expenses
            const startDate = document.getElementById('dashboard-start-date').value;
            const endDate = document.getElementById('dashboard-end-date').value;
            
            let allIncome = await getAllObjects(STORES.INCOME);
            let allExpenses = await getAllObjects(STORES.EXPENSES);

            if (startDate) {
                allIncome = allIncome.filter(i => i.date >= startDate);
                allExpenses = allExpenses.filter(e => e.date >= startDate);
            }
            if (endDate) {
                allIncome = allIncome.filter(i => i.date <= endDate);
                allExpenses = allExpenses.filter(e => e.date <= endDate);
            }

            const totalIncomePeriod = allIncome.reduce((sum, i) => sum + i.amount, 0);
            const totalExpensesPeriod = allExpenses.reduce((sum, e) => sum + e.amount, 0);

            document.getElementById('total-income-period').textContent = formatCurrency(totalIncomePeriod);
            document.getElementById('total-expenses-period').textContent = formatCurrency(totalExpensesPeriod);
        }

        // --- SALE & PURCHASE LOGIC ---
        // Sale Functions
        async function openSaleModal() {
            saleItems = [];
            document.getElementById('sale-form').reset();
            document.getElementById('sale-amount-paid').value = ''; // Clear amount paid
            document.getElementById('sale-amount-paid-div').style.display = 'none';

            const customerSelect = document.getElementById('sale-customer');
            customerSelect.innerHTML = `<option value="">${getLang('Paid (Cash Sale)')}</option>`;
            const customers = await getAllObjects(STORES.CUSTOMERS);
            customers.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            
            const productSelect = document.getElementById('sale-product-select');
            productSelect.innerHTML = `<option value="">Select a Product</option>`;
            const products = await getAllObjects(STORES.PRODUCTS);
            products.filter(p => p.quantity > 0).sort((a,b) => a.name.localeCompare(b.name)).forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.quantity})</option>`);
            
            document.getElementById('sale-date').valueAsDate = new Date();
            renderSaleItems();
            openModal('sale-form-modal');
        }

        async function addSaleItem() {
            const productId = parseInt(document.getElementById('sale-product-select').value);
            if (!productId) { customAlert('Please select a product.'); return; }
            const product = await getObject(STORES.PRODUCTS, productId);
            const qty = parseInt(document.getElementById('sale-item-qty').value);
            if (!qty || qty <= 0) { customAlert('Invalid quantity.'); return; }
            
            const existingItem = saleItems.find(item => item.productId === product.id);
            const currentStock = product.quantity;
            const quantityInCart = existingItem ? existingItem.quantity : 0;
            if (quantityInCart + qty > currentStock) {
                customAlert(`Not enough stock. Only ${currentStock - quantityInCart} more available.`); return;
            }

            if(existingItem) {
                existingItem.quantity += qty;
            } else {
                 saleItems.push({ productId: product.id, name: product.name, quantity: qty, price: product.salePrice });
            }
            renderSaleItems();
            document.getElementById('sale-product-select').value = '';
            document.getElementById('sale-item-qty').value = 1;
        }

        function renderSaleItems() {
            const body = document.getElementById('sale-items-table-body');
            let total = saleItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            body.innerHTML = saleItems.map((item, index) => {
                return `<tr>
                    <td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(item.quantity * item.price)}</td>
                    <td><button type="button" class="btn btn-danger btn-icon" onclick="removeSaleItem(${index})">X</button></td>
                </tr>`;
            }).join('');
            document.getElementById('sale-total-amount').textContent = formatCurrency(total);
        }

        function removeSaleItem(index) {
            saleItems.splice(index, 1);
            renderSaleItems();
        }

        async function completeSale(e) {
            e.preventDefault();
            if (saleItems.length === 0) { customAlert(getLang("Please add items to the sale.")); return; }
            const customerId = parseInt(document.getElementById('sale-customer').value) || null;
            const paymentStatus = document.getElementById('sale-payment-status').value;
            const amountPaid = parseFloat(document.getElementById('sale-amount-paid').value) || 0;
            const totalAmount = saleItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            if (paymentStatus === 'credit' && !customerId) { customAlert(getLang("Selected customer is required for credit sales.")); return; }
            if (paymentStatus === 'partially_paid' && !customerId) { customAlert(getLang("Selected customer is required for partial sales.")); return; }
            if (paymentStatus === 'partially_paid' && amountPaid >= totalAmount) { customAlert("Amount paid cannot be equal to or greater than total for a partial payment."); return;}
            if (paymentStatus === 'partially_paid' && amountPaid <= 0) { customAlert("Amount paid must be greater than zero for a partial payment."); return;}

            const allStoreNames = Object.values(STORES);
            const transaction = db.transaction(allStoreNames, 'readwrite');
            try {
                const saleData = { customerId, date: document.getElementById('sale-date').value, totalAmount, paymentStatus, amountPaid };
                const saleId = await addObject(STORES.SALES, saleData, transaction);
                
                for (const item of saleItems) {
                    await addObject(STORES.SALE_ITEMS, { saleId, productId: item.productId, quantity: item.quantity, unitPrice: item.price }, transaction);
                    const product = await getObject(STORES.PRODUCTS, item.productId, transaction);
                    product.quantity -= item.quantity;
                    await updateObject(STORES.PRODUCTS, product, transaction);
                }
                
                let creditAmount = 0;
                if (paymentStatus === 'credit') { creditAmount = totalAmount; }
                else if (paymentStatus === 'partially_paid') { creditAmount = totalAmount - amountPaid; }
                
                if (creditAmount > 0) {
                    await addObject(STORES.TRANSACTIONS, { entityId: customerId, entityType: 'customer', date: document.getElementById('sale-date').value, type: 'debit', amount: creditAmount, description: `Sale Invoice #${saleId}` }, transaction);
                    await updateEntityBalance(customerId, 'customer', transaction);
                }

                // Add to Income (Sales = Revenue)
                const incomeCategory = (await getAllObjects(STORES.CATEGORIES, 'name_type', IDBKeyRange.only(['Sales', 'income']), transaction))?.[0];
                if (incomeCategory) {
                    await addObject(STORES.INCOME, { date: document.getElementById('sale-date').value, amount: totalAmount, categoryId: incomeCategory.id, description: `Sale Invoice #${saleId}` }, transaction);
                } else {
                    console.warn("Income category 'Sales' not found. Please create it in settings.");
                }

                await promise(transaction.done);
                customAlert(getLang("Sale completed successfully."), getLang("Success"));
                closeModal('sale-form-modal');
                await loadSales(); await updateDashboard(); await loadProducts(); await loadAccountingEntries();
            } catch(err) {
                transaction.abort(); console.error(err); customAlert(`Sale failed: ${err.message}`, 'Error');
            }
        }

        async function loadSales() {
             const sales = await getAllObjects(STORES.SALES);
             sales.sort((a,b) => new Date(b.date) - new Date(a.date));
             const body = document.getElementById('sales-table-body');
             body.innerHTML = '';
             for(const sale of sales) {
                 let customerName = getLang('Paid (Cash Sale)');
                 if(sale.customerId) {
                     const customer = await getObject(STORES.CUSTOMERS, sale.customerId);
                     customerName = customer ? customer.name : 'Deleted Customer';
                 }
                 let statusText = getLang(sale.paymentStatus);
                 if (sale.paymentStatus === 'partially_paid') {
                     statusText += ` (${formatCurrency(sale.amountPaid)} Paid)`;
                 }
                 body.insertRow().innerHTML = `
                    <td>${formatDate(sale.date)}</td> <td>${customerName}</td> <td>${formatCurrency(sale.totalAmount)}</td>
                    <td>${statusText}</td>
                    <td class="no-print"><button class="btn btn-info btn-icon" onclick="showTransactionDetails('sale', ${sale.id})">📄</button></td>`;
             }
        }

        // Purchase Functions
        async function openPurchaseModal() {
            purchaseItems = [];
            document.getElementById('purchase-form').reset();
            document.getElementById('purchase-amount-paid').value = '';
            document.getElementById('purchase-amount-paid-div').style.display = 'none';

            const supplierSelect = document.getElementById('purchase-supplier');
            supplierSelect.innerHTML = `<option value="">Select a Supplier</option>`;
            const suppliers = await getAllObjects(STORES.SUPPLIERS);
            suppliers.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            
            const productSelect = document.getElementById('purchase-product-select');
            productSelect.innerHTML = `<option value="">Select a Product</option>`;
            const products = await getAllObjects(STORES.PRODUCTS);
            products.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`);

            document.getElementById('purchase-date').valueAsDate = new Date();
            renderPurchaseItems();
            openModal('purchase-form-modal');
        }

        async function addPurchaseItem() {
            const productId = parseInt(document.getElementById('purchase-product-select').value);
            if (!productId) { customAlert('Please select a product.'); return; }
            const product = await getObject(STORES.PRODUCTS, productId);

            const qty = parseInt(document.getElementById('purchase-item-qty').value);
            let price = parseFloat(document.getElementById('purchase-item-price').value);
            
            if (!qty || qty <= 0) { customAlert('Invalid quantity.'); return; }
            if (isNaN(price) || price < 0) {
                price = product.purchasePrice || 0;
                document.getElementById('purchase-item-price').value = price;
            }

            const existingItem = purchaseItems.find(item => item.productId === product.id);
            if(existingItem) existingItem.quantity += qty;
            else purchaseItems.push({ productId: product.id, name: product.name, quantity: qty, price });
            
            renderPurchaseItems();
            document.getElementById('purchase-product-select').value = '';
            document.getElementById('purchase-item-qty').value = 1;
            document.getElementById('purchase-item-price').value = ''; // Clear for next item
        }

        function renderPurchaseItems() {
             const body = document.getElementById('purchase-items-table-body');
            let total = purchaseItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            body.innerHTML = purchaseItems.map((item, index) => {
                return `<tr>
                    <td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(item.quantity * item.price)}</td>
                    <td><button type="button" class="btn btn-danger btn-icon" onclick="removePurchaseItem(${index})">X</button></td>
                </tr>`;
            }).join('');
            document.getElementById('purchase-total-amount').textContent = formatCurrency(total);
        }

        function removePurchaseItem(index) {
             purchaseItems.splice(index, 1);
            renderPurchaseItems();
        }

        async function completePurchase(e) {
            e.preventDefault();
            if (purchaseItems.length === 0) { customAlert(getLang("Please add items to the purchase.")); return; }
            const supplierId = parseInt(document.getElementById('purchase-supplier').value);
            if(!supplierId) { customAlert("Please select a supplier."); return; }
            const paymentStatus = document.getElementById('purchase-payment-status').value;
            const amountPaid = parseFloat(document.getElementById('purchase-amount-paid').value) || 0;
            const totalAmount = purchaseItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            if (paymentStatus === 'partially_paid' && amountPaid >= totalAmount) { customAlert("Amount paid cannot be equal to or greater than total for a partial payment."); return;}
            if (paymentStatus === 'partially_paid' && amountPaid <= 0) { customAlert("Amount paid must be greater than zero for a partial payment."); return;}

            const allStoreNames = Object.values(STORES);
            const transaction = db.transaction(allStoreNames, 'readwrite');
             try {
                const purchaseData = { supplierId, date: document.getElementById('purchase-date').value, totalAmount, paymentStatus, amountPaid };
                const purchaseId = await addObject(STORES.PURCHASES, purchaseData, transaction);
                
                for (const item of purchaseItems) {
                    await addObject(STORES.PURCHASE_ITEMS, { purchaseId, productId: item.productId, quantity: item.quantity, unitPrice: item.price }, transaction);
                    const product = await getObject(STORES.PRODUCTS, item.productId, transaction);
                    product.quantity += item.quantity;
                    product.purchasePrice = item.price; // Update product's default purchase price
                    await updateObject(STORES.PRODUCTS, product, transaction);
                }

                let creditAmount = 0; // Amount we owe the supplier
                if (paymentStatus === 'credit') { creditAmount = totalAmount; }
                else if (paymentStatus === 'partially_paid') { creditAmount = totalAmount - amountPaid; }

                if (creditAmount > 0) {
                    await addObject(STORES.TRANSACTIONS, { entityId: supplierId, entityType: 'supplier', date: document.getElementById('purchase-date').value, type: 'credit', amount: creditAmount, description: `Purchase #${purchaseId}`}, transaction);
                    await updateEntityBalance(supplierId, 'supplier', transaction);
                }

                // Add to Expenses (Purchases = Cost of Goods or Expense)
                const expenseCategory = (await getAllObjects(STORES.CATEGORIES, 'name_type', IDBKeyRange.only(['Purchases', 'expense']), transaction))?.[0];
                if (expenseCategory) {
                     await addObject(STORES.EXPENSES, { date: document.getElementById('purchase-date').value, amount: totalAmount, categoryId: expenseCategory.id, description: `Purchase #${purchaseId}`, supplierId: supplierId }, transaction);
                } else {
                     console.warn("Expense category 'Purchases' not found. Please create it in settings.");
                }
                
                await promise(transaction.done);
                customAlert(getLang("Purchase completed successfully."), getLang("Success"));
                closeModal('purchase-form-modal');
                await loadPurchases(); await updateDashboard(); await loadProducts(); await loadAccountingEntries();
            } catch(err) {
                transaction.abort(); console.error(err); customAlert(`Purchase failed: ${err.message}`, 'Error');
            }
        }

        async function loadPurchases() {
             const purchases = await getAllObjects(STORES.PURCHASES);
             purchases.sort((a,b) => new Date(b.date) - new Date(a.date));
             const body = document.getElementById('purchases-table-body');
             body.innerHTML = '';
             for(const purchase of purchases) {
                 const supplier = await getObject(STORES.SUPPLIERS, purchase.supplierId);
                 const supplierName = supplier ? supplier.name : 'Deleted Supplier';
                 let statusText = getLang(purchase.paymentStatus);
                 if (purchase.paymentStatus === 'partially_paid') {
                     statusText += ` (${formatCurrency(purchase.amountPaid)} Paid)`;
                 }
                 body.insertRow().innerHTML = `
                    <td>${formatDate(purchase.date)}</td><td>${supplierName}</td><td>${formatCurrency(purchase.totalAmount)}</td>
                    <td>${statusText}</td>
                    <td class="no-print"><button class="btn btn-info btn-icon" onclick="showTransactionDetails('purchase', ${purchase.id})">📄</button></td>`;
             }
        }

        async function showTransactionDetails(type, id) {
            detailModalTransactionType = type;
            window._currentBillId = id; // Store ID for print bill button to access

            const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
            const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
            const transaction = await getObject(storeName, id);
            if (!transaction) { customAlert(`${type} not found.`, "Error"); return; }

            const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entityIdField = type === 'sale' ? 'customerId' : 'supplierId';
            const entity = transaction[entityIdField] ? await getObject(entityStoreName, transaction[entityIdField]) : null;
            const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});

            document.getElementById('transaction-details-title').textContent = getLang(`${type === 'sale' ? 'Sale' : 'Purchase'} Details`);
            document.getElementById('detail-date').textContent = formatDate(transaction.date);
            document.getElementById('detail-entity').textContent = entity ? entity.name : (type === 'sale' ? getLang('Cash Sale') : 'N/A');
            document.getElementById('detail-total-amount').textContent = formatCurrency(transaction.totalAmount);
            document.getElementById('detail-payment-status').textContent = getLang(transaction.paymentStatus);

            const amountPaidRow = document.getElementById('detail-amount-paid-row');
            const balanceDueLine = document.getElementById('print-balance-due-line');
            if (transaction.paymentStatus === 'partially_paid') {
                amountPaidRow.style.display = 'block';
                document.getElementById('detail-amount-paid').textContent = formatCurrency(transaction.amountPaid);
                const balanceDue = transaction.totalAmount - transaction.amountPaid;
                balanceDueLine.style.display = 'block';
                document.getElementById('print-balance-due').textContent = formatCurrency(balanceDue);
            } else {
                amountPaidRow.style.display = 'none';
                balanceDueLine.style.display = 'none';
            }

            const itemsTableBody = document.getElementById('detail-items-table-body');
            itemsTableBody.innerHTML = items.map(item => `
                <tr>
                    <td>${products[item.productId]?.name || 'Deleted Product'}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.quantity * item.unitPrice)}</td>
                </tr>
            `).join('');

            document.getElementById('delete-sale-purchase-btn').onclick = () => confirmDeleteSaleOrPurchase(type, id);
            const processReturnBtn = document.getElementById('process-return-btn');
            // Show process return only for Sales (Refund) and Purchases (Supplier Return)
            processReturnBtn.style.display = (type === 'sale' || type === 'purchase') ? 'inline-block' : 'none';
            processReturnBtn.onclick = () => openReturnModal(type, id);

            openModal('transaction-details-modal');
        }

        async function confirmDeleteSaleOrPurchase(type, id) {
            customConfirm(getLang("Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries."), getLang("Confirm Deletion"), async () => {
                const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
                const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
                const transactionData = await getObject(storeName, id);
                if (!transactionData) { customAlert(`${type} not found.`, "Error"); return; }
                const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);

                const allStoreNames = Object.values(STORES);
                const dbTx = db.transaction(allStoreNames, 'readwrite');
                try {
                    // 1. Revert stock
                    for (const item of items) {
                        const product = await getObject(STORES.PRODUCTS, item.productId, dbTx);
                        if (!product) { console.warn(`Product ID ${item.productId} not found for item in ${type} ${id}. Skipping stock revert.`); continue; }
                        if (type === 'sale') { product.quantity += item.quantity; } // Sale: increase stock
                        else if (type === 'purchase') { product.quantity -= item.quantity; } // Purchase: decrease stock
                        await updateObject(STORES.PRODUCTS, product, dbTx);
                    }

                    // 2. Revert Khata entry (if applicable)
                    if (transactionData.paymentStatus === 'credit' || transactionData.paymentStatus === 'partially_paid') {
                        const entityId = type === 'sale' ? transactionData.customerId : transactionData.supplierId;
                        const entityType = type === 'sale' ? 'customer' : 'supplier';
                        const expectedDescription = (type === 'sale' ? `Sale Invoice #${id}` : `Purchase #${id}`);
                        const entityTransactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]), dbTx);
                        const associatedTransaction = entityTransactions.find(tx => tx.description === expectedDescription && tx.amount === (transactionData.totalAmount - (transactionData.amountPaid || 0)));
                        if (associatedTransaction) {
                            await deleteObject(STORES.TRANSACTIONS, associatedTransaction.id, dbTx);
                            await updateEntityBalance(entityId, entityType, dbTx);
                        } else { console.warn(`Associated Khata transaction not found for ${type} ${id}. Khata balance might need manual adjustment.`); }
                    }

                    // 3. Revert Income/Expense entry
                    const accountingStore = type === 'sale' ? STORES.INCOME : STORES.EXPENSES;
                    const accountingCategoryName = type === 'sale' ? 'Sales' : 'Purchases';
                    const accountingEntries = await getAllObjects(accountingStore, 'date', null, dbTx); // Get all entries to find it
                    const relatedAccountingEntry = accountingEntries.find(entry => entry.description === `${accountingCategoryName} #${id}` && entry.amount === transactionData.totalAmount);
                    if (relatedAccountingEntry) {
                        await deleteObject(accountingStore, relatedAccountingEntry.id, dbTx);
                    } else { console.warn(`Associated accounting entry not found for ${type} ${id}. Income/Expense might need manual adjustment.`); }


                    // 4. Delete sale/purchase items
                    for (const item of items) { await deleteObject(itemStoreName, item.id, dbTx); }

                    // 5. Delete sale/purchase record itself
                    await deleteObject(storeName, id, dbTx);

                    await promise(dbTx.done);
                    customAlert(getLang("Sale/Purchase deleted successfully."), getLang("Deleted"));
                    closeModal('transaction-details-modal');
                    if (type === 'sale') await loadSales();
                    else await loadPurchases();
                    await updateDashboard(); await loadProducts(); await loadAccountingEntries();
                }
                catch (err) { dbTx.abort(); customAlert(`Deletion failed: ${err.message}`, "Error"); }
            });
        }

        async function openReturnModal(type, id) {
            const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
            const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
            const transaction = await getObject(storeName, id);
            if (!transaction) { customAlert(`${type} not found.`, "Error"); return; }
            
            window._returnTransaction = transaction;
            window._returnType = type;

            const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entityIdField = type === 'sale' ? 'customerId' : 'supplierId';
            const entity = transaction[entityIdField] ? await getObject(entityStoreName, transaction[entityIdField]) : null;
            const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});

            document.getElementById('return-modal-title').textContent = getLang(type === 'sale' ? 'Refund/Return' : 'Supplier Return');
            document.getElementById('return-transaction-id').textContent = id;
            document.getElementById('return-entity-name').textContent = entity ? entity.name : (type === 'sale' ? getLang('Cash Sale') : 'N/A');
            document.getElementById('return-original-amount').textContent = formatCurrency(transaction.totalAmount);
            document.getElementById('return-refund-amount').value = '0.00';
            document.getElementById('return-notes').value = '';

            const returnItemsTableBody = document.getElementById('return-items-table-body');
            returnItemsTableBody.innerHTML = items.map(item => `
                <tr>
                    <td>${products[item.productId]?.name || 'Deleted Product'}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" data-product-id="${item.productId}" data-original-price="${item.unitPrice}" data-max-qty="${item.quantity}" class="ledger-input return-qty-input" value="0" min="0" max="${item.quantity}" style="width: 80px;"></td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                </tr>
            `).join('');

            returnItemsTableBody.querySelectorAll('.return-qty-input').forEach(input => {
                input.addEventListener('input', calculateReturnRefundAmount);
            });
            calculateReturnRefundAmount();
            openModal('return-modal');
        }

        function calculateReturnRefundAmount() {
            let refundAmount = 0;
            document.querySelectorAll('#return-items-table-body .return-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.originalPrice) || 0;
                const maxQty = parseInt(input.dataset.maxQty) || 0;

                if (qty > maxQty) { input.value = maxQty; refundAmount += maxQty * price; }
                else { refundAmount += qty * price; }
            });
            document.getElementById('return-refund-amount').value = refundAmount.toFixed(2);
        }

        async function confirmProcessReturn() {
            const transaction = window._returnTransaction;
            const type = window._returnType;
            const returnNotes = document.getElementById('return-notes').value.trim();
            const refundAmount = parseFloat(document.getElementById('return-refund-amount').value);

            if (!returnNotes) { customAlert(getLang("Please enter a reason for the return."), "Error"); return; }
            if (refundAmount <= 0) { customAlert(getLang("Cannot process return for zero quantity."), "Error"); return; }

            const itemsToReturn = [];
            document.querySelectorAll('#return-items-table-body .return-qty-input').forEach(input => {
                const productId = parseInt(input.dataset.productId);
                const qty = parseInt(input.value) || 0;
                const originalPrice = parseFloat(input.dataset.originalPrice) || 0;
                if (qty > 0) { itemsToReturn.push({ productId, quantity: qty, unitPrice: originalPrice }); }
            });
            if (itemsToReturn.length === 0) { customAlert(getLang("Please select at least one item to return."), "Error"); return; }

            const allStoreNames = Object.values(STORES);
            const dbTx = db.transaction(allStoreNames, 'readwrite');
            try {
                // 1. Update stock
                for (const item of itemsToReturn) {
                    const product = await getObject(STORES.PRODUCTS, item.productId, dbTx);
                    if (!product) { console.warn(`Product ID ${item.productId} not found for return. Skipping stock update.`); continue; }
                    if (type === 'sale') { product.quantity += item.quantity; }
                    else if (type === 'purchase') { product.quantity -= item.quantity; }
                    await updateObject(STORES.PRODUCTS, product, dbTx);
                }

                // 2. Create a new Khata transaction for the return
                const entityId = type === 'sale' ? transaction.customerId : transaction.supplierId;
                const entityType = type === 'sale' ? 'customer' : 'supplier';
                const khataTxType = type === 'sale' ? 'credit' : 'debit';

                // Check if entity exists before creating transaction (e.g. for cash sales)
                if (entityId) {
                    await addObject(STORES.TRANSACTIONS, {
                        entityId, entityType, date: new Date().toISOString().split('T')[0], type: khataTxType,
                        amount: refundAmount, description: `${getLang(type === 'sale' ? 'Refund/Return' : 'Supplier Return')} for ${type} #${transaction.id}: ${returnNotes}`
                    }, dbTx);
                    await updateEntityBalance(entityId, entityType, dbTx);
                }

                // 3. Create a new Accounting entry for the return
                const accountingStore = type === 'sale' ? STORES.INCOME : STORES.EXPENSES;
                const accountingCategoryName = type === 'sale' ? 'Sales Returns' : 'Purchase Returns';
                let accountingCategory = (await getAllObjects(STORES.CATEGORIES, 'name_type', IDBKeyRange.only([accountingCategoryName, type === 'sale' ? 'income' : 'expense']), dbTx))?.[0];
                
                // If "Sales Returns" or "Purchase Returns" category doesn't exist, create it
                if (!accountingCategory) {
                    const categoryId = await addObject(STORES.CATEGORIES, { name: accountingCategoryName, type: type === 'sale' ? 'income' : 'expense' }, dbTx);
                    accountingCategory = { id: categoryId };
                }

                if (accountingCategory) {
                    await addObject(accountingStore, {
                        date: new Date().toISOString().split('T')[0],
                        amount: refundAmount,
                        categoryId: accountingCategory.id,
                        description: `${getLang(type === 'sale' ? 'Refund/Return' : 'Supplier Return')} #${transaction.id}: ${returnNotes}`,
                        supplierId: type === 'purchase' ? entityId : undefined // Only for expense return
                    }, dbTx);
                } else {
                    console.warn(`Accounting category '${accountingCategoryName}' not found and could not be created.`);
                }
                
                await promise(dbTx.done);
                customAlert(getLang("Return processed successfully."), getLang("Success"));
                closeModal('return-modal');
                closeModal('transaction-details-modal');
                if (type === 'sale') await loadSales();
                else await loadPurchases();
                await updateDashboard(); await loadProducts(); await loadAccountingEntries();
            }
            catch (err) { dbTx.abort(); customAlert(`Return failed: ${err.message}`, "Error"); }
        }


        // --- Backup & Restore ---
        async function backupData() {
            customAlert(getLang("Generating backup..."), "In Progress");
            try {
                const backup = { version: DB_VERSION, backupDate: new Date().toISOString() };
                for (const storeName of Object.values(STORES)) {
                    backup[storeName] = await getAllObjects(storeName);
                }

                const jsonString = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ShopBackup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                closeModal('alert-modal');
                customAlert('Backup successful!', 'Success');
            }
            catch (error) { closeModal('alert-modal'); customAlert(`Backup failed: ${error.message}`, 'Error'); }
        }

        function handleRestoreFile(event) {
             const file = event.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!backupData.version || !backupData.customers) throw new Error("Invalid backup file format.");
                    customConfirm("This will overwrite ALL existing data. Are you sure?", "Confirm Restore",
                        () => restoreData(backupData),
                        () => event.target.value = ''
                    );
                }
                catch(err) { customAlert(`Error reading file: ${err.message}`, 'Error'); }
             };
             reader.readAsText(file);
        }

        async function restoreData(backupData) {
            customAlert("Restoring... please wait.", "In Progress");
            const transaction = db.transaction(Object.values(STORES), 'readwrite');
            try {
                for (const storeName of Object.values(STORES)) {
                    await promise(transaction.objectStore(storeName).clear());
                    if (backupData[storeName]) {
                        for (const obj of backupData[storeName]) {
                            await promise(transaction.objectStore(storeName).add(obj));
                        }
                    }
                }
                await promise(transaction.done);
                closeModal('alert-modal');
                customAlert("Restore complete! The page will now reload.", "Success");
                setTimeout(() => window.location.reload(), 1500);
            }
            catch(error) { transaction.abort(); closeModal('alert-modal'); customAlert(`Restore failed: ${error.message}`, 'Error'); }
        }

        // --- Reports Module ---
        async function handleReportTypeChange() {
            const reportType = document.getElementById('report-type-select').value;
            const entitySelectorDiv = document.getElementById('report-entity-selector-div');
            const entitySelect = document.getElementById('report-entity-select');
            
            if (reportType === 'customer_ledger' || reportType === 'supplier_ledger') {
                const entityType = reportType.split('_')[0];
                const storeName = entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
                const entities = await getAllObjects(storeName);
                entitySelect.innerHTML = `<option value="">Select a ${entityType}</option>`;
                entities.sort((a, b) => a.name.localeCompare(b.name)).forEach(e => {
                    entitySelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                });
                entitySelectorDiv.style.display = 'block';
            } else {
                entitySelectorDiv.style.display = 'none';
            }
        }

        async function generateReport() {
            const reportType = document.getElementById('report-type-select').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const outputDiv = document.getElementById('report-output');
            outputDiv.innerHTML = '<em>Generating...</em>';
            
            let reportData;
            try {
                switch(reportType) {
                    case 'sales': reportData = await generateSalesReport(startDate, endDate); break;
                    case 'purchases': reportData = await generatePurchaseReport(startDate, endDate); break;
                    case 'profit_loss_statement': reportData = await generateProfitLossStatement(startDate, endDate); break;
                    case 'inventory': reportData = await generateInventoryReport(); break;
                    case 'customer_ledger': 
                    case 'supplier_ledger': 
                        const entityId = parseInt(document.getElementById('report-entity-select').value);
                        if (!entityId) { throw new Error('Please select an entity.'); }
                        reportData = await generateEntityLedger(reportType.split('_')[0], entityId, startDate, endDate); 
                        break;
                    case 'income_report': reportData = await generateIncomeReport(startDate, endDate); break;
                    case 'expense_report': reportData = await generateExpenseReport(startDate, endDate); break;
                    default: throw new Error("Unknown report type.");
                }
                
                displayReport(reportData);
                currentReportData = reportData;
                document.getElementById('print-report-btn').disabled = false;
                document.getElementById('export-csv-btn').disabled = false;

            } catch(err) {
                outputDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
                document.getElementById('print-report-btn').disabled = true;
                document.getElementById('export-csv-btn').disabled = true;
            }
        }

        function displayReport(data) {
            const outputDiv = document.getElementById('report-output');
            let tableHTML = `<h3 data-en="${data.title}">${getLang(data.title)}</h3>`;
            if (data.period) {
                tableHTML += `<p style="text-align:center;">${data.period}</p>`;
            }
            tableHTML += `<table class="data-table"><thead><tr>${data.headers.map(h => `<th>${getLang(h)}</th>`).join('')}</tr></thead><tbody>`;
            tableHTML += data.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
            tableHTML += `</tbody></table>`;
            if(data.summary) {
                tableHTML += `<div style="text-align:right; margin-top:15px; font-weight:bold;">${data.summary}</div>`;
            }
            outputDiv.innerHTML = tableHTML;
        }

        function printReport() {
            if (!currentReportData) return;
            document.getElementById('printable-report-title').textContent = getLang(currentReportData.title);
            document.getElementById('printable-report-period').textContent = currentReportData.period || '';
            const tableClone = document.getElementById('report-output').querySelector('.data-table').cloneNode(true);
            const summaryClone = document.getElementById('report-output').querySelector('div[style*="text-align:right"]')?.cloneNode(true);
            
            const printableTableDiv = document.getElementById('printable-report-table');
            printableTableDiv.innerHTML = '';
            printableTableDiv.appendChild(tableClone);
            
            const printableSummaryDiv = document.getElementById('printable-report-summary');
            printableSummaryDiv.innerHTML = '';
            if (summaryClone) printableSummaryDiv.appendChild(summaryClone);

            const mainAppContainer = document.querySelector('.container');
            mainAppContainer.style.display = 'none';
            document.getElementById('printable-report-content').style.display = 'block';
            window.print();
            mainAppContainer.style.display = 'flex';
            document.getElementById('printable-report-content').style.display = 'none';
        }

        function exportReportToCSV() {
            if (!currentReportData) return;
            const { headers, rows, title } = currentReportData;
            let csvContent = '\uFEFF';
            csvContent += headers.map(h => `"${getLang(h).replace(/"/g, '""')}"`).join(',') + '\r\n';
            rows.forEach(row => {
                const cleanRow = row.map(cell => `"${String(cell).replace(/<[^>]*>/g, '').replace(/"/g, '""')}"`);
                csvContent += cleanRow.join(',') + '\r\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const filename = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generateSalesReport(startDate, endDate) {
            let sales = await getAllObjects(STORES.SALES);
            if(startDate) sales = sales.filter(s => s.date >= startDate);
            if(endDate) sales = sales.filter(s => s.date <= endDate);
            sales.sort((a,b) => new Date(a.date) - new Date(b.date));

            const customers = (await getAllObjects(STORES.CUSTOMERS)).reduce((map, c) => (map[c.id] = c.name, map), {});
            let total = 0;
            const rows = sales.map(s => {
                total += s.totalAmount;
                return [ formatDate(s.date), s.customerId ? customers[s.customerId] || 'Deleted' : getLang('Paid (Cash Sale)'),
                    formatCurrency(s.totalAmount), getLang(s.paymentStatus) ];
            });
            return { title: 'Sales Report', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Customer', 'Amount', 'Status'], rows: rows, summary: `<strong>Total Sales:</strong> ${formatCurrency(total)}` };
        }

        async function generatePurchaseReport(startDate, endDate) {
            let purchases = await getAllObjects(STORES.PURCHASES);
            if(startDate) purchases = purchases.filter(p => p.date >= startDate);
            if(endDate) purchases = purchases.filter(p => p.date <= endDate);
            purchases.sort((a,b) => new Date(a.date) - new Date(b.date));

            const suppliers = (await getAllObjects(STORES.SUPPLIERS)).reduce((map, s) => (map[s.id] = s.name, map), {});
            let total = 0;
            const rows = purchases.map(p => {
                total += p.totalAmount;
                return [ formatDate(p.date), suppliers[p.supplierId] || 'Deleted', formatCurrency(p.totalAmount), getLang(p.paymentStatus) ];
            });
            return { title: 'Purchase Report', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Supplier', 'Amount', 'Status'], rows: rows, summary: `<strong>Total Purchases:</strong> ${formatCurrency(total)}` };
        }
        
        async function generateProfitLossStatement(startDate, endDate) {
            let allIncome = await getAllObjects(STORES.INCOME);
            let allExpenses = await getAllObjects(STORES.EXPENSES);
            const categories = (await getAllObjects(STORES.CATEGORIES)).reduce((map, c) => (map[c.id] = c.name, map), {});

            if (startDate) {
                allIncome = allIncome.filter(i => i.date >= startDate);
                allExpenses = allExpenses.filter(e => e.date >= startDate);
            }
            if (endDate) {
                allIncome = allIncome.filter(i => i.date <= endDate);
                allExpenses = allExpenses.filter(e => e.date <= endDate);
            }

            const totalIncome = allIncome.reduce((sum, i) => sum + i.amount, 0);
            const totalExpenses = allExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalIncome - totalExpenses;

            const rows = [];
            rows.push([getLang('Total Income:'), '', '', formatCurrency(totalIncome)]);
            rows.push([getLang('Total Expenses:'), '', '', formatCurrency(totalExpenses)]);
            rows.push([getLang('Net Profit:'), '', '', formatCurrency(netProfit)]);

            return { title: 'Profit & Loss Statement', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Description', 'Category', 'Date', 'Amount'], rows: rows,
                summary: `<strong>Net Profit:</strong> ${formatCurrency(netProfit)}` };
        }

        async function generateInventoryReport() {
            const products = await getAllObjects(STORES.PRODUCTS);
            let totalValue = 0;
            const rows = products.sort((a,b) => a.name.localeCompare(b.name)).map(p => {
                const value = p.purchasePrice * p.quantity; totalValue += value;
                let status = getLang('In Stock');
                if (p.quantity <= 0) status = getLang('Out of Stock');
                else if (p.quantity <= p.lowStockThreshold) status = getLang('Low Stock');
                return [p.name, p.quantity, formatCurrency(p.purchasePrice), formatCurrency(p.salePrice), formatCurrency(value), status];
            });
            return { title: 'Inventory Report', headers: ['Product Name', 'Stock', 'Purchase Price', 'Sale Price', 'Stock Value', 'Status'],
                rows: rows, summary: `<strong>Total Inventory Value:</strong> ${formatCurrency(totalValue)}` }
        }

        async function generateEntityLedger(type, entityId, startDate, endDate) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, entityId);
            let allTransactions = await getTransactionsForEntity(entityId, type, startDate, endDate);

            let openingBalance = 0;
            if (startDate) {
                const transactionsBeforePeriod = (await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, type]))).filter(t => t.date < startDate);
                openingBalance = transactionsBeforePeriod.reduce((bal, tx) => bal + (tx.type === 'debit' ? tx.amount : -tx.amount), 0);
            }
            
            let currentBalance = openingBalance;
            const rows = allTransactions.map(tx => {
                const txAmount = parseFloat(tx.amount);
                currentBalance += (tx.type === 'debit' ? txAmount : -txAmount);
                return [formatDate(tx.date), tx.description, tx.type === 'debit' ? formatCurrency(tx.amount) : '-', tx.type === 'credit' ? formatCurrency(tx.amount) : '-', renderBalance(currentBalance)];
            });
            
            rows.unshift(['-', getLang('Opening Balance'), '-', '-', renderBalance(openingBalance)]);

            return { title: `${getLang(type === 'customer' ? 'Customer' : 'Supplier')} Ledger: ${entity.name}`,
                period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Description', 'Debit', 'Credit', 'Balance'], rows: rows,
                summary: `<strong>Closing Balance:</strong> ${renderBalance(entity.balance)}` }
        }

        async function generateIncomeReport(startDate, endDate) {
            let incomeEntries = await getAllObjects(STORES.INCOME);
            const categories = (await getAllObjects(STORES.CATEGORIES)).reduce((map, c) => (map[c.id] = c.name, map), {});

            if (startDate) incomeEntries = incomeEntries.filter(i => i.date >= startDate);
            if (endDate) incomeEntries = incomeEntries.filter(i => i.date <= endDate);

            incomeEntries.sort((a,b) => new Date(a.date) - new Date(b.date));

            let total = 0;
            const rows = incomeEntries.map(i => {
                total += i.amount;
                return [formatDate(i.date), categories[i.categoryId] || 'N/A', i.description || '-', formatCurrency(i.amount)];
            });

            return { title: 'Income Report (Categorized)', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Category', 'Description', 'Amount'], rows: rows, summary: `<strong>Total Income:</strong> ${formatCurrency(total)}` };
        }

        async function generateExpenseReport(startDate, endDate) {
            let expenseEntries = await getAllObjects(STORES.EXPENSES);
            const categories = (await getAllObjects(STORES.CATEGORIES)).reduce((map, c) => (map[c.id] = c.name, map), {});
            const suppliers = (await getAllObjects(STORES.SUPPLIERS)).reduce((map, s) => (map[s.id] = s.name, map), {});

            if (startDate) expenseEntries = expenseEntries.filter(e => e.date >= startDate);
            if (endDate) expenseEntries = expenseEntries.filter(e => e.date <= endDate);

            expenseEntries.sort((a,b) => new Date(a.date) - new Date(b.date));

            let total = 0;
            const rows = expenseEntries.map(e => {
                total += e.amount;
                return [formatDate(e.date), categories[e.categoryId] || 'N/A', e.description || '-', e.supplierId ? suppliers[e.supplierId] || 'N/A' : '-', formatCurrency(e.amount)];
            });

            return { title: 'Expense Report (Categorized)', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Category', 'Description', 'Supplier', 'Amount'], rows: rows, summary: `<strong>Total Expenses:</strong> ${formatCurrency(total)}` };
        }


        // --- Settings Logic ---
        async function loadSettings() {
            const settings = await getObject(STORES.SETTINGS, 1);
            if (settings) {
                document.getElementById('shop-name').value = settings.shopName || '';
                document.getElementById('shop-phone').value = settings.shopPhone || '';
                document.getElementById('shop-address').value = settings.shopAddress || '';
            } else {
                // Initialize settings with defaults if no record exists
                await addObject(STORES.SETTINGS, { id: 1, shopName: 'Your Shop', shopPhone: '', shopAddress: '' });
                loadSettings(); // Reload to populate form
            }
            await loadCategories('income');
            await loadCategories('expense');
        }

        async function saveSettings(e) {
            e.preventDefault();
            const settings = {
                id: 1,
                shopName: document.getElementById('shop-name').value.trim(),
                shopPhone: document.getElementById('shop-phone').value.trim(),
                shopAddress: document.getElementById('shop-address').value.trim()
            };
            await updateObject(STORES.SETTINGS, settings);
            customAlert(getLang("Settings saved successfully."), getLang("Success"));
            updateDashboard();
        }

        // Category Management (Settings page)
        async function addCategory(type) {
            const inputId = `new-${type}-category-name`;
            const categoryName = document.getElementById(inputId).value.trim();
            if (!categoryName) { customAlert("Category name cannot be empty.", "Error"); return; }
            try {
                await addObject(STORES.CATEGORIES, { name: categoryName, type: type });
                customAlert(getLang("Category added successfully."), getLang("Success"));
                document.getElementById(inputId).value = '';
                await loadCategories(type);
            } catch (error) {
                if (error.name === 'ConstraintError') { customAlert(getLang("Category already exists."), "Error"); }
                else { customAlert(`Failed to add category: ${error.message}`, "Error"); }
            }
        }

        async function loadCategories(type) {
            const categories = await getAllObjects(STORES.CATEGORIES, 'type', type);
            const tableBody = document.getElementById(`${type}-categories-table-body`);
            tableBody.innerHTML = '';
            categories.forEach(cat => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${cat.name}</td><td><button class="btn btn-danger btn-icon" onclick="confirmDeleteCategory(${cat.id}, '${type}')">🗑️</button></td>`;
            });
        }

        async function confirmDeleteCategory(id, type) {
            customConfirm(getLang("Are you sure you want to delete this category?"), getLang("Confirm Deletion"), async () => {
                const relatedStore = type === 'income' ? STORES.INCOME : STORES.EXPENSES;
                const relatedEntries = await getAllObjects(relatedStore, 'categoryId', id);
                if (relatedEntries.length > 0) {
                    customAlert(getLang("Cannot delete a category that has associated entries."), "Error");
                    return;
                }
                await deleteObject(STORES.CATEGORIES, id);
                customAlert(getLang("Category deleted successfully."), getLang("Deleted"));
                await loadCategories(type);
            });
        }


        // --- Data Export for specific stores ---
        async function exportDataToCSV(storeName) {
            try {
                const data = await getAllObjects(storeName);
                if (data.length === 0) { customAlert(`No data found in ${storeName} to export.`, "Info"); return; }

                let csvContent = '\uFEFF';
                const headers = Object.keys(data[0]);
                csvContent += headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\r\n';

                data.forEach(rowObj => {
                    const row = headers.map(header => {
                        let value = rowObj[header];
                        if (typeof value === 'object' && value !== null) value = JSON.stringify(value);
                        return `"${String(value || '').replace(/"/g, '""')}"`;
                    });
                    csvContent += row.join(',') + '\r\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${storeName}_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                customAlert(`${storeName} data exported successfully.`, "Success");

            } catch (error) { customAlert(`Error exporting ${storeName} data: ${error.message}`, "Error"); }
        }

        // --- Print Bill/Invoice ---
        async function printCurrentBillInvoice() {
            const type = detailModalTransactionType;
            const id = window._currentBillId; // Use the stored ID

            const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
            const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
            const transactionData = await getObject(storeName, id);
            if (!transactionData) { customAlert(`${type} not found.`, "Error"); return; }

            const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entityIdField = type === 'sale' ? 'customerId' : 'supplierId';
            const entity = transactionData[entityIdField] ? await getObject(entityStoreName, transactionData[entityIdField]) : null;
            const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});
            const settings = await getObject(STORES.SETTINGS, 1) || {};

            document.getElementById('print-shop-name').textContent = settings.shopName || 'Your Shop Name';
            document.getElementById('print-shop-phone').textContent = `${getLang('Phone')}: ${settings.shopPhone || 'N/A'}`;
            document.getElementById('print-shop-address').textContent = `${getLang('Address')}: ${settings.shopAddress || 'N/A'}`;

            document.getElementById('print-bill-type').textContent = getLang(type === 'sale' ? 'Invoice' : 'Bill');
            document.getElementById('print-entity-info').innerHTML = `
                <p><strong>${getLang(type === 'sale' ? 'Customer' : 'Supplier')}:</strong> ${entity ? entity.name : (type === 'sale' ? getLang('Cash Sale') : 'N/A')}</p>
                ${entity?.phone ? `<p><strong>${getLang('Phone')}:</strong> ${entity.phone}</p>` : ''}
            `;
            document.getElementById('print-transaction-info').innerHTML = `
                <p><strong>${getLang('Date')}:</strong> ${formatDate(transactionData.date)}</p>
                <p><strong>${getLang('Bill/Invoice')} ID:</strong> ${id}</p>
            `;

            const printItemsBody = document.getElementById('print-item-details');
            printItemsBody.innerHTML = items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${products[item.productId]?.name || 'Deleted Product'}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.quantity * item.unitPrice)}</td>
                </tr>
            `).join('');

            document.getElementById('print-grand-total').textContent = formatCurrency(transactionData.totalAmount);
            if (transactionData.paymentStatus === 'partially_paid') {
                document.getElementById('print-amount-paid-line').style.display = 'block';
                document.getElementById('print-amount-paid').textContent = formatCurrency(transactionData.amountPaid);
                const balanceDue = transactionData.totalAmount - transactionData.amountPaid;
                document.getElementById('print-balance-due-line').style.display = 'block';
                document.getElementById('print-balance-due').textContent = formatCurrency(balanceDue);
            } else {
                document.getElementById('print-amount-paid-line').style.display = 'none';
                document.getElementById('print-balance-due-line').style.display = 'none';
            }
            
            const mainAppContainer = document.querySelector('.container');
            mainAppContainer.style.display = 'none';
            document.getElementById('printable-bill-invoice').style.display = 'block';
            window.print();
            mainAppContainer.style.display = 'flex';
            document.getElementById('printable-bill-invoice').style.display = 'none';
        }
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => switchPage(tab.dataset.page)));
            document.getElementById('add-customer-btn').addEventListener('click', () => {
                document.getElementById('customer-form').reset(); document.getElementById('customer-id').value = '';
                document.getElementById('customer-modal-title').textContent = getLang('Add New Customer'); openModal('customer-form-modal');
            });
            document.getElementById('customer-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveEntity('customer', { id: parseInt(document.getElementById('customer-id').value) || null, name: document.getElementById('customer-name').value.trim(), phone: document.getElementById('customer-phone').value.trim(), address: document.getElementById('customer-address').value.trim(), });
            });
            document.getElementById('customer-search').addEventListener('input', (e) => loadEntities('customer', e.target.value));
            document.getElementById('back-to-list-btn-customer').addEventListener('click', () => showListView('customer'));
            document.getElementById('add-manual-transaction-btn-customer').addEventListener('click', () => openManualTransactionModal('customer', currentViewedId));
            document.getElementById('customer-ledger-filter-btn').addEventListener('click', () => loadTransactionsForView('customer', currentViewedId));
            document.getElementById('customer-ledger-clear-filter-btn').addEventListener('click', () => { document.getElementById('customer-ledger-start-date').value = ''; document.getElementById('customer-ledger-end-date').value = ''; loadTransactionsForView('customer', currentViewedId); });

            document.getElementById('add-supplier-btn').addEventListener('click', () => {
                document.getElementById('supplier-form').reset(); document.getElementById('supplier-id').value = '';
                document.getElementById('supplier-modal-title').textContent = getLang('Add New Supplier'); openModal('supplier-form-modal');
            });
            document.getElementById('supplier-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveEntity('supplier', { id: parseInt(document.getElementById('supplier-id').value) || null, name: document.getElementById('supplier-name').value.trim(), phone: document.getElementById('supplier-phone').value.trim(), address: document.getElementById('supplier-address').value.trim(), });
            });
            document.getElementById('supplier-search').addEventListener('input', (e) => loadEntities('supplier', e.target.value));
            document.getElementById('back-to-list-btn-supplier').addEventListener('click', () => showListView('supplier'));
            document.getElementById('add-manual-transaction-btn-supplier').addEventListener('click', () => openManualTransactionModal('supplier', currentViewedId));
            document.getElementById('supplier-ledger-filter-btn').addEventListener('click', () => loadTransactionsForView('supplier', currentViewedId));
            document.getElementById('supplier-ledger-clear-filter-btn').addEventListener('click', () => { document.getElementById('supplier-ledger-start-date').value = ''; document.getElementById('supplier-ledger-end-date').value = ''; loadTransactionsForView('supplier', currentViewedId); });


            document.getElementById('add-product-btn').addEventListener('click', () => {
                document.getElementById('product-form').reset(); document.getElementById('product-id').value = '';
                document.getElementById('product-quantity').disabled = false;
                document.getElementById('product-modal-title').textContent = getLang('Add New Product'); openModal('product-form-modal');
            });
            document.getElementById('product-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveProduct({ id: parseInt(document.getElementById('product-id').value) || null, name: document.getElementById('product-name').value.trim(), category: document.getElementById('product-category').value.trim(), sku: document.getElementById('product-sku').value.trim(), salePrice: parseFloat(document.getElementById('product-sale-price').value), purchasePrice: parseFloat(document.getElementById('product-purchase-price').value), quantity: parseInt(document.getElementById('product-quantity').value), lowStockThreshold: parseInt(document.getElementById('product-low-stock').value) });
            });
            document.getElementById('product-search').addEventListener('input', (e) => loadProducts(e.target.value));
            document.getElementById('adjust-stock-btn').addEventListener('click', () => { customAlert("Select a product from the table first, then click the '📦' icon to adjust its stock.", "Info"); });
            document.getElementById('stock-adjustment-form').addEventListener('submit', applyStockAdjustment);


            document.getElementById('transaction-form').addEventListener('submit', async e => {
                e.preventDefault(); 
                const transaction = db.transaction([STORES.TRANSACTIONS, STORES.CUSTOMERS, STORES.SUPPLIERS], 'readwrite');
                const data = { id: parseInt(document.getElementById('transaction-id').value) || null, entityId: parseInt(document.getElementById('transaction-entity-id').value), entityType: document.getElementById('transaction-entity-type').value, date: document.getElementById('transaction-date').value, type: document.getElementById('transaction-type').value, amount: parseFloat(document.getElementById('transaction-amount').value), description: document.getElementById('transaction-description').value.trim() };
                
                if (data.id) { // Editing existing manual transaction
                    const oldTx = await getObject(STORES.TRANSACTIONS, data.id, transaction);
                    // Revert old transaction's impact before applying new one
                    const tempEntity = await getObject(oldTx.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, oldTx.entityId, transaction);
                    tempEntity.balance -= (oldTx.type === 'debit' ? oldTx.amount : -oldTx.amount);
                    await updateObject(tempEntity.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, tempEntity, transaction);
                    
                    await updateObject(STORES.TRANSACTIONS, data, transaction);
                } else { // Adding new manual transaction
                    await addObject(STORES.TRANSACTIONS, data, transaction);
                }
                await updateEntityBalance(data.entityId, data.entityType, transaction);

                await promise(transaction.done);
                customAlert(getLang('transaction_saved_successfully'), getLang('Success')); closeModal('transaction-form-modal');
                await loadTransactionsForView(data.entityType, data.entityId);
            });


             document.getElementById('add-sale-btn').addEventListener('click', openSaleModal);
             document.getElementById('sale-form').addEventListener('submit', completeSale);
             document.getElementById('add-sale-item-btn').addEventListener('click', addSaleItem);
             document.getElementById('sale-payment-status').addEventListener('change', (e) => { document.getElementById('sale-amount-paid-div').style.display = e.target.value === 'partially_paid' ? 'block' : 'none'; });
             document.getElementById('sale-product-select').addEventListener('change', (e) => {}); // No action needed here, already handled by addSaleItem button

             document.getElementById('add-purchase-btn').addEventListener('click', openPurchaseModal);
             document.getElementById('purchase-form').addEventListener('submit', completePurchase);
             document.getElementById('add-purchase-item-btn').addEventListener('click', addPurchaseItem);
             document.getElementById('purchase-payment-status').addEventListener('change', (e) => { document.getElementById('purchase-amount-paid-div').style.display = e.target.value === 'partially_paid' ? 'block' : 'none'; });
             document.getElementById('purchase-product-select').addEventListener('change', async (e) => {
                 const selectedProductId = parseInt(e.target.value);
                 if (selectedProductId) { const product = await getObject(STORES.PRODUCTS, selectedProductId); document.getElementById('purchase-item-price').value = product.purchasePrice || 0; }
                 else { document.getElementById('purchase-item-price').value = ''; }
             });

             // Sale/Purchase Details Modal buttons
             document.getElementById('print-bill-btn').addEventListener('click', printCurrentBillInvoice);
             document.getElementById('delete-sale-purchase-btn').addEventListener('click', confirmDeleteSaleOrPurchase);
             document.getElementById('process-return-btn').addEventListener('click', openReturnModal);


             document.getElementById('backup-btn').addEventListener('click', backupData);
             document.getElementById('restore-file').addEventListener('change', handleRestoreFile);
             document.getElementById('language-switch').addEventListener('change', (e) => setLanguage(e.target.value));
             document.getElementById('generate-report-btn').addEventListener('click', generateReport);
             document.getElementById('print-report-btn').addEventListener('click', printReport);
             document.getElementById('export-csv-btn').addEventListener('click', exportReportToCSV);
             document.getElementById('report-type-select').addEventListener('change', handleReportTypeChange);

             // Settings page
             document.getElementById('general-settings-form').addEventListener('submit', saveSettings);
             document.getElementById('add-income-category-btn').addEventListener('click', () => addCategory('income'));
             document.getElementById('add-expense-category-btn').addEventListener('click', () => addCategory('expense'));
             document.getElementById('export-customers-btn').addEventListener('click', () => exportDataToCSV(STORES.CUSTOMERS));
             document.getElementById('export-products-btn').addEventListener('click', () => exportDataToCSV(STORES.PRODUCTS));
             document.getElementById('export-transactions-btn').addEventListener('click', () => exportDataToCSV(STORES.TRANSACTIONS));

             // Return modal
             document.getElementById('confirm-return-btn').addEventListener('click', confirmProcessReturn);

             // Accounting page
             document.getElementById('add-income-btn').addEventListener('click', () => openAccountingForm('income'));
             document.getElementById('add-expense-btn').addEventListener('click', () => openAccountingForm('expense'));
             document.getElementById('accounting-form').addEventListener('submit', saveAccountingEntry);
             document.getElementById('accounting-filter-btn').addEventListener('click', loadAccountingEntries);
             document.getElementById('accounting-clear-filter-btn').addEventListener('click', () => { document.getElementById('accounting-start-date').value = ''; document.getElementById('accounting-end-date').value = ''; loadAccountingEntries(); });
             document.getElementById('accounting-entry-type').addEventListener('change', (e) => {
                const type = e.target.value;
                document.getElementById('accounting-supplier-group').style.display = (type === 'expense') ? 'block' : 'none';
                populateCategoriesDropdown(type);
             });
        }

  

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                setupEventListeners();
                setLanguage(currentLanguage);
                switchPage('dashboard-page');
                console.log("Application initialized successfully.");
            } catch (error) {
                console.error("CRITICAL: Initialization failed:", error);
                 document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;"><h1>Initialization Failed</h1><p>Could not start the application. Please ensure your browser supports IndexedDB and is not in private mode.</p><p><i>Error: ${error.message}</i></p></div>`;
            }
        });
    </script>
</body>
</html>