
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Shop Management System</title>
    <style>
        /* --- Base Styles & Fonts --- */
        :root {
            --primary-color: #006400; /* Dark Green */
            --secondary-color: #f4f4f4; /* Light Gray */
            --text-color: #333;
            --border-color: #ccc;
            --ledger-line-color: #e0e0e0;
            --ledger-bg-color: #fdfdfd;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --success-color: #28a745;
            --font-handwritten: 'cursive', 'Segoe Script', 'Brush Script MT', sans-serif; /* Fallback fonts */
            --font-sans: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 15px auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: 600;
        }

        h1 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        h2 {
           font-size: 1.5em;
        }

        h3 {
            font-size: 1.2em;
        }

        /* --- Navigation Tabs --- */
        .main-nav {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }
        .nav-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            background-color: #f1f1f1;
            font-size: 1em;
            font-weight: 500;
            color: var(--primary-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .nav-tab:hover {
            background-color: #e7e7e7;
        }
        .nav-tab.active {
            background-color: #fff;
            border-color: var(--primary-color) var(--primary-color) #fff;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* --- Ledger Paper Styling --- */
        .ledger-input,
        .ledger-textarea,
        .ledger-select {
            background-color: var(--ledger-bg-color);
            border: none;
            border-bottom: 1px solid var(--ledger-line-color);
            padding: 10px 5px 5px 5px;
            margin-bottom: 10px;
            width: 100%;
            font-family: var(--font-handwritten);
            font-size: 1.1em;
            line-height: 1.8; /* Simulate lines */
            background-image: linear-gradient(to bottom, transparent 95%, var(--ledger-line-color) 95%);
            background-size: 100% 1.8em; /* Match line-height */
            background-repeat: repeat-y;
            background-position: 0 5px; /* Adjust vertical position */
            resize: vertical; /* Allow textarea resize */
        }
        .ledger-textarea { min-height: 80px; }
        .ledger-input:focus, .ledger-textarea:focus, .ledger-select:focus {
            outline: none;
            border-bottom: 2px solid var(--primary-color);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin: 5px;
            text-decoration: none;
            color: #fff;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover:not(:disabled) { background-color: #004d00; }
        .btn-secondary { background-color: #6c757d; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        .btn-success { background-color: var(--success-color); color: #fff; }
        .btn-success:hover:not(:disabled) { background-color: #218838; }
        .btn-warning { background-color: var(--warning-color); color: #212529; }
        .btn-warning:hover:not(:disabled) { background-color: #e0a800; }
        .btn-info { background-color: var(--info-color); color: #fff;}
        .btn-info:hover:not(:disabled) { background-color: #138496;}
        .btn-icon { padding: 8px 10px; font-size: 0.9em; }

        /* --- Forms & Modals --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-family: var(--font-sans); }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fff; margin: 5% auto; padding: 25px; border-radius: 8px;
            max-width: 600px; width: 90%; position: relative; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .modal-content.modal-lg { max-width: 900px; }
        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 1.8em;
            font-weight: bold; color: #aaa; cursor: pointer; line-height: 1;
        }
        .modal-close:hover, .modal-close:focus { color: #333; }

        /* --- Tables --- */
        .data-table {
            width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .data-table thead { background-color: var(--primary-color); color: #fff; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table tbody tr:nth-child(even) { background-color: var(--ledger-bg-color); }
        .data-table tbody tr:hover { background-color: #e9e9e9; }
        .data-table td .btn { padding: 5px 8px; font-size: 0.85em; margin: 2px; }
        .balance-positive { color: var(--danger-color); font-weight: bold; } /* We owe them */
        .balance-negative { color: var(--success-color); font-weight: bold; } /* They owe us */
        .stock-ok { color: var(--success-color); }
        .stock-low { color: var(--warning-color); font-weight: bold; }
        .stock-out { color: var(--danger-color); font-weight: bold; }


        /* --- Layout & Sections --- */
        .section {
            margin-bottom: 25px; padding: 15px; background: #fff;
            border-radius: 5px; border: 1px solid var(--border-color);
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; flex-wrap: wrap;
        }
        .section-header h2, .section-header h3 { margin-bottom: 0; }
        .dashboard-summary {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .summary-card {
            background-color: var(--ledger-bg-color); padding: 15px; border-radius: 5px;
            border: 1px solid var(--border-color); text-align: center;
        }
        .summary-card h4 { margin-bottom: 8px; font-size: 1em; color: var(--primary-color); }
        .summary-card p { font-size: 1.3em; font-weight: bold; }
        #customer-details-view, #supplier-details-view { display: none; }

        /* --- Filters & Search --- */
        .filter-controls {
            display: flex; gap: 10px; margin-bottom: 15px;
            flex-wrap: wrap; align-items: center;
        }
        .filter-controls label { margin-bottom: 0; margin-right: 5px; font-family: var(--font-sans); font-weight: normal; }
        .filter-controls input[type="date"], .filter-controls input[type="text"], .filter-controls select {
             padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;
             font-family: var(--font-sans); font-size: 0.95em;
             background-image: none; background-color: #fff; line-height: normal;
        }

        /* --- Sale/Purchase Form specific styles --- */
        .item-entry-form { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; flex-wrap: wrap; }
        .item-entry-form .form-group { flex: 1; min-width: 150px; }
        .invoice-totals {
            margin-top: 20px; padding-top: 15px; border-top: 2px solid var(--primary-color);
            text-align: right; font-size: 1.2em; font-weight: bold;
        }


        /* --- Urdu Toggle --- */
        .language-toggle {
            position: absolute; top: 15px; right: 15px; display: flex; align-items: center;
        }
        .language-toggle label { margin: 0 5px 0 0; font-size: 0.9em; font-weight: normal; }

        /* --- Reporting Section --- */
        #report-output {
            margin-top: 20px;
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 5px;
        }
        #report-output h3 { text-align: center; }

        /* --- Print Styles --- */
        @media print {
            body { padding: 0; background-color: #fff; font-size: 10pt; }
            .container { max-width: 100%; margin: 0; padding: 0; box-shadow: none; border-radius: 0; }
            .no-print { display: none !important; }
            .section { border: none; padding: 0; margin-bottom: 15px; page-break-inside: avoid; }
            h1, h2, h3 { color: #000; }
            .data-table { box-shadow: none; font-size: 9pt; }
            .data-table th, .data-table td { padding: 5px 8px; border: 1px solid #ccc; }
            .data-table thead { background-color: #eee; color: #000; }
            .page.active, #printable-report-content { display: block !important; }
            .page:not(.active), #reports-page, #dashboard-page, #sales-page, #purchases-page, #customers-page, #suppliers-page, #inventory-page { display: none !important; }
            #printable-report-content h2 { text-align: center; font-size: 1.5em; }
            #printable-report-content h3 { text-align: center; font-size: 1.2em; }

            /* Specific styles for print invoice/bill */
            .printable-bill-invoice {
                width: 100%;
                padding: 15px;
                font-family: var(--font-sans);
            }
            .printable-bill-invoice h2, .printable-bill-invoice h3 {
                text-align: center;
                margin-bottom: 10px;
            }
            .printable-bill-invoice .shop-info {
                text-align: center;
                margin-bottom: 20px;
            }
            .printable-bill-invoice .header-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 15px;
                border-bottom: 1px solid #000;
                padding-bottom: 10px;
            }
            .printable-bill-invoice .item-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }
            .printable-bill-invoice .item-table th, .printable-bill-invoice .item-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            .printable-bill-invoice .item-table th {
                background-color: #f0f0f0;
            }
            .printable-bill-invoice .totals {
                text-align: right;
                font-weight: bold;
                font-size: 1.1em;
            }
            .printable-bill-invoice .footer-notes {
                margin-top: 30px;
                font-size: 0.9em;
                text-align: center;
                border-top: 1px dashed #ccc;
                padding-top: 10px;
            }
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; margin: 10px auto; }
            h1 { font-size: 1.6em; } h2 { font-size: 1.3em; } h3 { font-size: 1.1em; }
            .btn { width: 100%; margin: 5px 0; }
            .btn-icon { width: auto; }
            .section-header { flex-direction: column; align-items: flex-start; }
            .section-header div { margin-top: 10px; width: 100%; display: flex; flex-direction: column; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            .data-table .hide-mobile { display: none; }
            .modal-content { margin: 15% auto; width: 95%; padding: 20px; }
            .language-toggle { position: static; margin: 10px 0; justify-content: flex-end; }
            .main-nav { justify-content: center; }
            .nav-tab { font-size: 0.9em; padding: 8px 10px;}
        }

         @media (max-width: 480px) {
            h1 { font-size: 1.4em; }
            .dashboard-summary { grid-template-columns: 1fr; }
            .data-table { font-size: 0.8em; }
            .data-table th, .data-table td { padding: 6px 4px; }
         }
        .urdu-font-force { font-family: 'Noto Nastaliq Urdu', serif !important; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="language-toggle no-print">
            <label for="language-switch" data-en="Language" data-ur="10101910">Language:</label>
            <select id="language-switch">
                <option value="en">English</option>
                <option value="ur">Urdu (19191712)</option>
            </select>
        </div>

        <h1 data-en="Shop Management System" data-ur="121916 19141014191011 11111119">Shop Management System</h1>

        <!-- Main Navigation -->
        <nav class="main-nav no-print">
            <div class="nav-tab active" data-page="dashboard-page" data-en="Dashboard" data-ur="161412 10121916">Dashboard</div>
            <div class="nav-tab" data-page="sales-page" data-en="Sales" data-ur="1519121612">Sales</div>
            <div class="nav-tab" data-page="purchases-page" data-en="Purchases" data-ur="16191417191914">Purchases</div>
            <div class="nav-tab" data-page="customers-page" data-en="Customers" data-ur="131919151410">Customers</div>
            <div class="nav-tab" data-page="suppliers-page" data-en="Suppliers" data-ur="11161819181910">Suppliers</div>
            <div class="nav-tab" data-page="inventory-page" data-en="Inventory" data-ur="1910121410111914">Inventory</div>
            <div class="nav-tab" data-page="reports-page" data-en="Reports" data-ur="191612191111">Reports</div>
            <div class="nav-tab" data-page="settings-page" data-en="Settings" data-ur="111411101510">Settings</div>
        </nav>

        <!-- Page: Dashboard -->
        <div id="dashboard-page" class="page active">
            <div class="section">
                <div class="dashboard-summary">
                    <div class="summary-card">
                        <h4 data-en="Total Customers" data-ur="1918 131919151410">Total Customers</h4>
                        <p id="total-customers">0</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Receivables (Lena Hai)" data-ur="121914101912 (18141019 1310)">Receivables (Lena Hai)</h4>
                        <p id="total-receivables" class="balance-negative">Rs 0.00</p>
                    </div>
                     <div class="summary-card">
                        <h4 data-en="Payables (Dena Hai)" data-ur="12191410 1918191719 (17141019 1310)">Payables (Dena Hai)</h4>
                        <p id="total-payables" class="balance-positive">Rs 0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Low Stock Items" data-ur="1919 1911111919 1418111910">Low Stock Items</h4>
                        <p id="low-stock-items" class="stock-low">0</p>
                    </div>
                    <div class="summary-card">
                        <h4 data-en="Total Inventory Value" data-ur="1918 1910121410111914 1919181412">Total Inventory Value</h4>
                        <p id="inventory-value">Rs 0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Sales -->
        <div id="sales-page" class="page">
            <div class="section">
                <div class="section-header">
                    <h2 data-en="Sales History" data-ur="1519121612 1914 111915101212">Sales History</h2>
                    <div>
                        <button id="add-sale-btn" class="btn btn-primary no-print" data-en="New Sale" data-ur="101814 1519121612">New Sale</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="sales-table">
                        <thead>
                            <tr>
                                <th data-en="Date" data-ur="1219191416">Date</th>
                                <th data-en="Customer" data-ur="13191915">Customer</th>
                                <th data-en="Amount" data-ur="191619">Amount</th>
                                <th data-en="Status" data-ur="1514131412">Status</th>
                                <th data-en="Actions" data-ur="191919121918141916" class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page: Purchases -->
        <div id="purchases-page" class="page">
             <div class="section">
                <div class="section-header">
                    <h2 data-en="Purchase History" data-ur="16191417191914 1914 111915101212">Purchase History</h2>
                    <div>
                        <button id="add-purchase-btn" class="btn btn-primary no-print" data-en="New Purchase" data-ur="101814 16191417191914">New Purchase</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="purchases-table">
                        <thead>
                            <tr>
                                <th data-en="Date" data-ur="1219191416">Date</th>
                                <th data-en="Supplier" data-ur="111618191819">Supplier</th>
                                <th data-en="Amount" data-ur="191619">Amount</th>
                                <th data-en="Status" data-ur="1514131412">Status</th>
                                <th data-en="Actions" data-ur="191919121918141916" class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page: Customers -->
        <div id="customers-page" class="page">
            <div id="customer-list-view">
                <div class="section">
                    <div class="section-header">
                        <h2 data-en="Customers" data-ur="131919151410">Customers</h2>
                        <div>
                            <button id="add-customer-btn" class="btn btn-primary no-print" data-en="Add New Customer" data-ur="101419 13191915 12191918 19191416">Add New Customer</button>
                        </div>
                    </div>
                     <div class="filter-controls no-print">
                         <input type="text" id="customer-search" placeholder="Search Customers..." data-en-placeholder="Search Customers..." data-ur-placeholder="131919151410 12181912 19191416...">
                     </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="customer-table">
                            <thead>
                                <tr>
                                    <th data-en="Name" data-ur="101919">Name</th>
                                    <th data-en="Phone" data-ur="151210" class="hide-mobile">Phone</th>
                                    <th data-en="Balance" data-ur="1014181011">Balance</th>
                                    <th data-en="Actions" data-ur="191919121918141916" class="no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customer-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="customer-details-view">
                 <div class="section">
                     <div class="section-header">
                        <h2 id="details-customer-name">Customer Details</h2> <div>
                            <button id="back-to-list-btn-customer" class="btn btn-secondary no-print" data-en="Back to List" data-ur="1513191112 1619 12191611">Back to List</button>
                        </div>
                     </div>
                     <div id="customer-info"></div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h3 data-en="Transactions" data-ur="181410 171410">Transactions</h3>
                         <div class="filter-controls">
                            <label for="customer-ledger-start-date" data-en="From:" data-ur="1110:">From:</label>
                            <input type="date" id="customer-ledger-start-date">
                            <label for="customer-ledger-end-date" data-en="To:" data-ur="1219:">To:</label>
                            <input type="date" id="customer-ledger-end-date">
                            <button id="customer-ledger-filter-btn" class="btn btn-primary btn-icon" data-en="Filter" data-ur="15181119 19191416">Filter</button>
                            <button id="customer-ledger-clear-filter-btn" class="btn btn-secondary btn-icon" data-en="Clear" data-ur="131915 19191416">Clear</button>
                        </div>
                         <div>
                            <button id="add-manual-transaction-btn-customer" class="btn btn-primary no-print" data-en="Add Manual Transaction" data-ur="17111214 181410 171410 12191918 19191416">Add Transaction</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;"> <table class="data-table" id="transaction-table-customer"></table></div>
                    <div class="customer-balance-summary" style="text-align: right; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                        <span data-en="Current Balance:" data-ur="191214121713 1014181011:">Current Balance:</span> <span id="details-current-balance-customer">Rs 0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Suppliers -->
        <div id="suppliers-page" class="page">
            <div id="supplier-list-view">
                <div class="section">
                    <div class="section-header">
                        <h2 data-en="Suppliers" data-ur="11161819181910">Suppliers</h2>
                        <div>
                            <button id="add-supplier-btn" class="btn btn-primary no-print" data-en="Add New Supplier" data-ur="101419 111618191819 12191918 19191416">Add New Supplier</button>
                        </div>
                    </div>
                     <div class="filter-controls no-print">
                         <input type="text" id="supplier-search" placeholder="Search Suppliers..." data-en-placeholder="Search Suppliers..." data-ur-placeholder="11161819181910 12181912 19191416...">
                     </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="supplier-table">
                            <thead>
                                <tr>
                                    <th data-en="Name" data-ur="101919">Name</th>
                                    <th data-en="Phone" data-ur="151210" class="hide-mobile">Phone</th>
                                    <th data-en="Balance" data-ur="1014181011">Balance</th>
                                    <th data-en="Actions" data-ur="191919121918141916" class="no-print">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supplier-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="supplier-details-view">
                 <div class="section">
                     <div class="section-header">
                        <h2 id="details-supplier-name">Supplier Details</h2> <div>
                            <button id="back-to-list-btn-supplier" class="btn btn-secondary no-print" data-en="Back to List" data-ur="1513191112 1619 12191611">Back to List</button>
                        </div>
                     </div>
                     <div id="supplier-info"></div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h3 data-en="Transactions" data-ur="181410 171410">Transactions</h3>
                         <div class="filter-controls">
                            <label for="supplier-ledger-start-date" data-en="From:" data-ur="1110:">From:</label>
                            <input type="date" id="supplier-ledger-start-date">
                            <label for="supplier-ledger-end-date" data-en="To:" data-ur="1219:">To:</label>
                            <input type="date" id="supplier-ledger-end-date">
                            <button id="supplier-ledger-filter-btn" class="btn btn-primary btn-icon" data-en="Filter" data-ur="15181119 19191416">Filter</button>
                            <button id="supplier-ledger-clear-filter-btn" class="btn btn-secondary btn-icon" data-en="Clear" data-ur="131915 19191416">Clear</button>
                        </div>
                         <div>
                            <button id="add-manual-transaction-btn-supplier" class="btn btn-primary no-print" data-en="Add Manual Transaction" data-ur="17111214 181410 171410 12191918 19191416">Add Transaction</button>
                        </div>
                    </div>
                     <div style="overflow-x: auto;"> <table class="data-table" id="transaction-table-supplier"></table></div>
                     <div class="supplier-balance-summary" style="text-align: right; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                        <span data-en="Current Balance:" data-ur="191214121713 1014181011:">Current Balance:</span> <span id="details-current-balance-supplier">Rs 0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page: Inventory -->
        <div id="inventory-page" class="page">
            <div class="section">
                <div class="section-header">
                    <h2 data-en="Product Inventory" data-ur="19131012171912 1914 1910121410111914">Product Inventory</h2>
                    <div>
                        <button id="add-product-btn" class="btn btn-primary no-print" data-en="Add New Product" data-ur="101814 161912161911 12191918 19191416">Add New Product</button>
                        <button id="adjust-stock-btn" class="btn btn-info no-print" data-en="Adjust Stock" data-ur="1911111919 191416141111 19191416">Adjust Stock</button>
                    </div>
                </div>
                 <div class="filter-controls no-print">
                     <input type="text" id="product-search" placeholder="Search Products..." data-en-placeholder="Search Products..." data-ur-placeholder="16191216191111 12181912 19191416...">
                 </div>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="product-table">
                        <thead>
                            <tr>
                                <th data-en="Product Name" data-ur="161912161911 1919 101919">Product Name</th>
                                <th data-en="Category" data-ur="10191913">Category</th>
                                <th data-en="SKU" data-ur="191411 1910 1412">SKU</th>
                                <th data-en="Sale Price" data-ur="1519121612 1914 16141912">Sale Price</th>
                                <th data-en="Purchase Price" data-ur="16191417191914 1914 16141912" class="hide-mobile">Purchase Price</th>
                                <th data-en="Stock" data-ur="1911111919">Stock</th>
                                <th data-en="Status" data-ur="1514131412">Status</th>
                                <th data-en="Actions" data-ur="191919121918141916" class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page: Reports -->
        <div id="reports-page" class="page">
            <div class="section no-print">
                <h2 data-en="Reports" data-ur="191612191111">Reports</h2>
                <div class="filter-controls">
                    <div class="form-group">
                        <label for="report-type-select" data-en="Report Type" data-ur="1916121911 1914 161119">Report Type</label>
                        <select id="report-type-select">
                            <option value="sales" data-en="Sales Report" data-ur="11141810 1916121911">Sales Report</option>
                            <option value="purchases" data-en="Purchase Report" data-ur="1619141410 1916121911">Purchase Report</option>
                            <option value="profit_loss" data-en="Profit & Loss Report" data-ur="101517 12 1016131910 1914 1916121911">Profit & Loss Report</option>
                            <option value="inventory" data-en="Inventory Report" data-ur="1910121410111914 1916121911">Inventory Report</option>
                            <option value="customer_ledger" data-en="Customer Ledger" data-ur="1911111919 18141419">Customer Ledger</option>
                            <option value="supplier_ledger" data-en="Supplier Ledger" data-ur="111618191819 18141419">Supplier Ledger</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="report-start-date" data-en="Start Date" data-ur="12191217191214 1219191416">Start Date</label>
                        <input type="date" id="report-start-date">
                    </div>
                     <div class="form-group">
                        <label for="report-end-date" data-en="End Date" data-ur="19161212191914 1219191416">End Date</label>
                        <input type="date" id="report-end-date">
                    </div>
                    <div class="form-group" id="report-entity-selector-div" style="display:none;">
                        <label for="report-entity-select" data-en="Select Entity" data-ur="19141011141114 1910121610 19191416">Select Entity</label>
                        <select id="report-entity-select"></select>
                    </div>
                </div>
                <div>
                     <button id="generate-report-btn" class="btn btn-primary" data-en="Generate Report" data-ur="1916121911 101019181416">Generate Report</button>
                     <button id="print-report-btn" class="btn btn-secondary" data-en="Print / PDF" data-ur="16191011 / 1614 1614 191415" disabled>Print / PDF</button>
                     <button id="export-csv-btn" class="btn btn-success" data-en="Export to Excel (CSV)" data-ur="1914191118 191416 1914191116121911" disabled>Export to Excel (CSV)</button>
                </div>
            </div>
            <div id="report-output">
                <p data-en="Select a report type and date range, then click 'Generate Report'." data-ur="1916121911 1914 161119 191219 1219191416 1914 1517 1910121610 1919141612 161019 '1916121911 101019181416' 1619 191819 1919141612">Select a report type and date range, then click 'Generate Report'.</p>
            </div>
        </div>

        <!-- Page: Settings -->
        <div id="settings-page" class="page">
            <div class="section">
                <h2 data-en="Settings" data-ur="111411101510">Settings</h2>
                <form id="settings-form">
                    <div class="form-group">
                        <label for="shop-name" data-en="Shop Name" data-ur="17191910 1919 101919">Shop Name</label>
                        <input type="text" id="shop-name" class="ledger-input">
                    </div>
                    <div class="form-group">
                        <label for="shop-phone" data-en="Shop Phone" data-ur="17191910 1919 151210">Shop Phone</label>
                        <input type="tel" id="shop-phone" class="ledger-input">
                    </div>
                    <div class="form-group">
                        <label for="shop-address" data-en="Shop Address" data-ur="17191910 1919 161213">Shop Address</label>
                        <textarea id="shop-address" class="ledger-textarea"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" data-en="Save Settings" data-ur="111411101510 1915151216 19191416">Save Settings</button>
                </form>
            </div>
             <div id="backup-restore-section" class="section no-print">
                <h3 data-en="Backup & Restore" data-ur="101419 1916 191219 10151918 19191416">Backup & Restore</h3>
                <button id="backup-btn" class="btn btn-secondary" data-en="Backup Data (JSON)" data-ur="16141119 101419 1916 (JSON)">Backup Data (JSON)</button>
                <label for="restore-file" class="btn btn-warning" data-en="Restore Data (JSON)" data-ur="16141119 10151918 19191416 (JSON)">Restore Data (JSON)</label>
                <input type="file" id="restore-file" accept=".json" style="display: none;">
            </div>
             <div class="section no-print">
                 <h3 data-en="Data Import/Export" data-ur="16141119 1719141917/1019141917">Data Import/Export</h3>
                 <button id="export-customers-btn" class="btn btn-info" data-en="Export Customers" data-ur="131919151410 1019141917 19191416">Export Customers</button>
                 <button id="export-products-btn" class="btn btn-info" data-en="Export Products" data-ur="19131012171912 1019141917 19191416">Export Products</button>
                 <button id="export-transactions-btn" class="btn btn-info" data-en="Export All Transactions" data-ur="12191919 181410 171410 1019141917 19191416">Export All Transactions</button>
             </div>
        </div>


        <!-- Printable Report Area -->
        <div id="printable-report-content" style="display: none;">
            <h2 id="printable-report-title"></h2>
            <h3 id="printable-report-period"></h3>
            <div id="printable-report-table"></div>
            <div id="printable-report-summary" style="margin-top: 20px; text-align: right; font-weight: bold; font-size: 1.1em;"></div>
        </div>

        <!-- Printable Bill/Invoice Area -->
        <div id="printable-bill-invoice" class="printable-bill-invoice" style="display: none;">
            <div class="shop-info">
                <h2 id="print-shop-name">Your Shop Name</h2>
                <p id="print-shop-phone">Phone: N/A</p>
                <p id="print-shop-address">Address: N/A</p>
            </div>
            <h3 id="print-bill-type">Sale Invoice</h3>
            <div class="header-info">
                <div id="print-entity-info"></div>
                <div id="print-transaction-info"></div>
            </div>
            <table class="item-table">
                <thead><tr><th>#</th><th data-en="Product" data-ur="161912161911">Product</th><th data-en="Qty" data-ur="1916171919">Qty</th><th data-en="Unit Price" data-ur="1514 14121011 16141912">Unit Price</th><th data-en="Item Total" data-ur="14181119 1918">Item Total</th></tr></thead>
                <tbody id="print-item-details"></tbody>
            </table>
            <div class="totals">
                <p><span data-en="Grand Total:" data-ur="1918 191619:">Grand Total:</span> <span id="print-grand-total">Rs 0.00</span></p>
                <p id="print-amount-paid-line"><span data-en="Amount Paid:" data-ur="191719 121713 191619:">Amount Paid:</span> <span id="print-amount-paid">Rs 0.00</span></p>
                <p id="print-balance-due-line"><span data-en="Balance Due:" data-ur="1016191419 191619:">Balance Due:</span> <span id="print-balance-due">Rs 0.00</span></p>
            </div>
            <div class="footer-notes">
                <p data-en="Thank you for your business!" data-ur="1416 1910 19191912101919 1919 1219191413!">Thank you for your business!</p>
            </div>
        </div>

    </div>

    <!-- MODALS -->
    <!-- Customer Form Modal -->
    <div id="customer-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('customer-form-modal')">&times;</span>
            <h3 id="customer-modal-title">Add New Customer</h3>
            <form id="customer-form">
                <input type="hidden" id="customer-id">
                <div class="form-group">
                    <label for="customer-name" data-en="Name" data-ur="101919">Name</label>
                    <input type="text" id="customer-name" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="customer-phone" data-en="Phone (Optional)" data-ur="151210 (19161214191914)">Phone</label>
                    <input type="tel" id="customer-phone" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="customer-address" data-en="Address (Optional)" data-ur="161213 (19161214191914)">Address</label>
                    <textarea id="customer-address" class="ledger-textarea"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Customer" data-ur="13191915 1915151216 19191416">Save Customer</button>
            </form>
        </div>
    </div>

    <!-- Supplier Form Modal -->
    <div id="supplier-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('supplier-form-modal')">&times;</span>
            <h3 id="supplier-modal-title">Add New Supplier</h3>
            <form id="supplier-form">
                <input type="hidden" id="supplier-id">
                <div class="form-group">
                    <label for="supplier-name" data-en="Name" data-ur="101919">Name</label>
                    <input type="text" id="supplier-name" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="supplier-phone" data-en="Phone (Optional)" data-ur="151210 (19161214191914)">Phone</label>
                    <input type="tel" id="supplier-phone" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="supplier-address" data-en="Address (Optional)" data-ur="161213 (19161214191914)">Address</label>
                    <textarea id="supplier-address" class="ledger-textarea"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Supplier" data-ur="111618191819 1915151216 19191416">Save Supplier</button>
            </form>
        </div>
    </div>

    <!-- Product Form Modal -->
    <div id="product-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('product-form-modal')">&times;</span>
            <h3 id="product-modal-title">Add New Product</h3>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name" data-en="Product Name" data-ur="161912161911 1919 101919">Product Name</label>
                    <input type="text" id="product-name" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="product-category" data-en="Category (Optional)" data-ur="10191913 (19161214191914)">Category</label>
                    <input type="text" id="product-category" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="product-sku" data-en="SKU / Barcode (Optional)" data-ur="191411 1910 1412 / 101919 191216 (19161214191914)">SKU / Barcode</label>
                    <input type="text" id="product-sku" class="ledger-input">
                </div>
                <div class="form-group">
                    <label for="product-sale-price" data-en="Sale Price (Rs)" data-ur="1519121612 1914 16141912 (19121610)">Sale Price</label>
                    <input type="number" id="product-sale-price" class="ledger-input" step="0.01" min="0" required>
                </div>
                 <div class="form-group">
                    <label for="product-purchase-price" data-en="Purchase Price (Rs)" data-ur="16191417191914 1914 16141912 (19121610)">Purchase Price</label>
                    <input type="number" id="product-purchase-price" class="ledger-input" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-quantity" data-en="Initial Stock Quantity" data-ur="19101217191814 1911111919 1916171919">Initial Stock Quantity</label>
                    <input type="number" id="product-quantity" class="ledger-input" step="1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-low-stock" data-en="Low Stock Alert Level" data-ur="1919 1911111919 19181911 18141218">Low Stock Alert Level</label>
                    <input type="number" id="product-low-stock" class="ledger-input" step="1" min="0" value="5">
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Product" data-ur="161912161911 1915151216 19191416">Save Product</button>
            </form>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="stock-adjustment-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('stock-adjustment-modal')">&times;</span>
            <h3 data-en="Adjust Stock for" data-ur="1911111919 191416141111 19191416">Adjust Stock for <span id="adj-product-name"></span></h3>
            <form id="stock-adjustment-form">
                <input type="hidden" id="adj-product-id">
                <div class="form-group">
                    <label for="adj-current-stock" data-en="Current Stock" data-ur="191214121713 1911111919">Current Stock</label>
                    <input type="number" id="adj-current-stock" class="ledger-input" disabled>
                </div>
                <div class="form-group">
                    <label for="adj-type" data-en="Adjustment Type" data-ur="191416141111191011 1914 161119">Adjustment Type</label>
                    <select id="adj-type" class="ledger-select">
                        <option value="add" data-en="Add Stock" data-ur="1911111919 12191918 19191416">Add Stock</option>
                        <option value="deduct" data-en="Deduct Stock" data-ur="1911111919 1919 19191416">Deduct Stock</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adj-quantity" data-en="Quantity to Adjust" data-ur="191416141111 19191010 1914 1916171919">Quantity to Adjust</label>
                    <input type="number" id="adj-quantity" class="ledger-input" min="1" required>
                </div>
                <div class="form-group">
                    <label for="adj-reason" data-en="Reason (e.g., Damage, Theft)" data-ur="121413 (191318191512 101613191012 14121914)">Reason</label>
                    <textarea id="adj-reason" class="ledger-textarea" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Apply Adjustment" data-ur="191416141111191011 18191512 19191416">Apply Adjustment</button>
            </form>
        </div>
    </div>


    <!-- Manual Transaction Modal -->
    <div id="transaction-form-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('transaction-form-modal')">&times;</span>
            <h3><span data-en="Add Manual Transaction for" data-ur="1910 181410 17111214 181410 171410 12191918 19191416"></span> <span id="transaction-modal-entity-name"></span></h3>
            <form id="transaction-form">
                <input type="hidden" id="transaction-id"> <!-- For editing manual transactions -->
                <input type="hidden" id="transaction-entity-id">
                <input type="hidden" id="transaction-entity-type">
                <div class="form-group">
                    <label for="transaction-date" data-en="Date" data-ur="1219191416">Date</label>
                    <input type="date" id="transaction-date" class="ledger-input" required>
                </div>
                <div class="form-group">
                    <label for="transaction-type" data-en="Transaction Type" data-ur="181410 171410 1914 161119">Transaction Type</label>
                    <select id="transaction-type" class="ledger-select" required>
                        <option value="debit" data-en="Debit (Payment Made / Sale)" data-ur="16141011 (19171918141514 1914 / 1519121612)">Debit (Payment Made / Sale)</option>
                        <option value="credit" data-en="Credit (Payment Received)" data-ur="1919141611 (19171918141514 12131218 1914)">Credit (Payment Received)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transaction-amount" data-en="Amount (Rs)" data-ur="191619 (19121610)">Amount (Rs)</label>
                    <input type="number" id="transaction-amount" class="ledger-input" step="0.01" min="0.01" required>
                </div>
                 <div class="form-group">
                    <label for="transaction-description" data-en="Description" data-ur="1215131418">Description</label>
                    <textarea id="transaction-description" class="ledger-textarea" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" data-en="Save Transaction" data-ur="181410 171410 1915151216 19191416">Save Transaction</button>
            </form>
        </div>
    </div>

    <!-- Sale Form Modal -->
    <div id="sale-form-modal" class="modal">
        <div class="modal-content modal-lg">
            <span class="modal-close" onclick="closeModal('sale-form-modal')">&times;</span>
            <h3 data-en="New Sale / Invoice" data-ur="101814 1519121612 / 191012191811">New Sale / Invoice</h3>
            <form id="sale-form">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="sale-customer" data-en="Customer (Optional)" data-ur="13191915 (19161214191914)">Customer</label>
                        <select id="sale-customer" class="ledger-select"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="sale-date" data-en="Date" data-ur="1219191416">Date</label>
                        <input type="date" id="sale-date" class="ledger-input" required>
                    </div>
                </div>

                <div class="section">
                    <h4 data-en="Add Products" data-ur="19131012171912 12191918 19191416">Add Products</h4>
                    <div class="item-entry-form">
                         <div class="form-group">
                            <label for="sale-product-select" data-en="Product" data-ur="161912161911">Product</label>
                            <select id="sale-product-select" class="ledger-select"></select>
                        </div>
                        <div class="form-group">
                            <label for="sale-item-qty" data-en="Quantity" data-ur="1916171919">Quantity</label>
                            <input type="number" id="sale-item-qty" class="ledger-input" min="1" value="1">
                        </div>
                        <button type="button" id="add-sale-item-btn" class="btn btn-primary" data-en="Add Item" data-ur="14181119 12191918 19191416">Add Item</button>
                    </div>
                    <table class="data-table">
                        <thead><tr><th data-en="Product" data-ur="161912161911">Product</th><th data-en="Qty" data-ur="1916171919">Qty</th><th data-en="Price" data-ur="16141912">Price</th><th data-en="Total" data-ur="1918">Total</th><th></th></tr></thead>
                        <tbody id="sale-items-table-body"></tbody>
                    </table>
                </div>

                <div class="invoice-totals">
                    <span data-en="Total Amount:" data-ur="1918 191619:">Total Amount:</span> <span id="sale-total-amount">Rs 0.00</span>
                </div>

                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="sale-payment-status" data-en="Payment Status" data-ur="19171918141514 1914 1514131412">Payment Status</label>
                        <select id="sale-payment-status" class="ledger-select" required>
                            <option value="paid" data-en="Paid (Cash Sale)" data-ur="191719 121713 (101617 1519121612)">Paid (Cash Sale)</option>
                            <option value="credit" data-en="Credit (Add to Khata)" data-ur="1917101919 (1910191213 191416 12191918 19191416)">Credit (Add to Khata)</option>
                            <option value="partially_paid" data-en="Partially Paid" data-ur="14101214 151219 1619 191719 121713">Partially Paid</option>
                        </select>
                    </div>
                    <div class="form-group" id="sale-amount-paid-div" style="flex: 1; display: none;">
                        <label for="sale-amount-paid" data-en="Amount Paid" data-ur="191719 121713 191619">Amount Paid</label>
                        <input type="number" id="sale-amount-paid" class="ledger-input" min="0" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn btn-success" data-en="Complete Sale" data-ur="1519121612 19191918 19191416">Complete Sale</button>
            </form>
        </div>
    </div>

    <!-- Purchase Form Modal -->
    <div id="purchase-form-modal" class="modal">
         <div class="modal-content modal-lg">
            <span class="modal-close" onclick="closeModal('purchase-form-modal')">&times;</span>
            <h3 data-en="New Purchase" data-ur="101814 16191417191914">New Purchase</h3>
            <form id="purchase-form">
                 <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="purchase-supplier" data-en="Supplier" data-ur="111618191819">Supplier</label>
                        <select id="purchase-supplier" class="ledger-select" required></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="purchase-date" data-en="Date" data-ur="1219191416">Date</label>
                        <input type="date" id="purchase-date" class="ledger-input" required>
                    </div>
                </div>

                <div class="section">
                    <h4 data-en="Add Products" data-ur="19131012171912 12191918 19191416">Add Products</h4>
                     <div class="item-entry-form">
                         <div class="form-group">
                            <label for="purchase-product-select" data-en="Product" data-ur="161912161911">Product</label>
                            <select id="purchase-product-select" class="ledger-select"></select>
                        </div>
                        <div class="form-group">
                            <label for="purchase-item-qty" data-en="Quantity" data-ur="1916171919">Quantity</label>
                            <input type="number" id="purchase-item-qty" class="ledger-input" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="purchase-item-price" data-en="Unit Price" data-ur="1514 14121011 16141912">Unit Price</label>
                            <input type="number" id="purchase-item-price" class="ledger-input" min="0" step="0.01">
                        </div>
                        <button type="button" id="add-purchase-item-btn" class="btn btn-primary" data-en="Add Item" data-ur="14181119 12191918 19191416">Add Item</button>
                    </div>
                     <table class="data-table">
                        <thead><tr><th data-en="Product" data-ur="161912161911">Product</th><th data-en="Qty" data-ur="1916171919">Qty</th><th data-en="Price" data-ur="16141912">Price</th><th data-en="Total" data-ur="1918">Total</th><th></th></tr></thead>
                        <tbody id="purchase-items-table-body"></tbody>
                    </table>
                </div>

                 <div class="invoice-totals">
                    <span data-en="Total Amount:" data-ur="1918 191619:">Total Amount:</span> <span id="purchase-total-amount">Rs 0.00</span>
                </div>

                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1;">
                        <label for="purchase-payment-status" data-en="Payment Status" data-ur="19171918141514 1914 1514131412">Payment Status</label>
                        <select id="purchase-payment-status" class="ledger-select" required>
                            <option value="paid" data-en="Paid" data-ur="191719 121713">Paid</option>
                            <option value="credit" data-en="Credit (Add to Khata)" data-ur="1917101919 (1910191213 191416 12191918 19191416)">Credit (Add to Khata)</option>
                             <option value="partially_paid" data-en="Partially Paid" data-ur="14101214 151219 1619 191719 121713">Partially Paid</option>
                        </select>
                    </div>
                    <div class="form-group" id="purchase-amount-paid-div" style="flex: 1; display: none;">
                        <label for="purchase-amount-paid" data-en="Amount Paid" data-ur="191719 121713 191619">Amount Paid</label>
                        <input type="number" id="purchase-amount-paid" class="ledger-input" min="0" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn btn-success" data-en="Complete Purchase" data-ur="16191417191914 19191918 19191416">Complete Purchase</button>
            </form>
        </div>
    </div>

    <!-- Sale/Purchase Details Modal (Generic) -->
    <div id="transaction-details-modal" class="modal">
        <div class="modal-content modal-lg">
            <span class="modal-close" onclick="closeModal('transaction-details-modal')">&times;</span>
            <h3 id="transaction-details-title">Sale Details</h3>
            <div id="transaction-details-content">
                <p><strong><span data-en="Date:" data-ur="1219191416:">Date:</span></strong> <span id="detail-date"></span></p>
                <p><strong><span data-en="Associated Entity:" data-ur="191217181613 19141011141114:">Associated Entity:</span></strong> <span id="detail-entity"></span></p>
                <p><strong><span data-en="Total Amount:" data-ur="1918 191619:">Total Amount:</span></strong> <span id="detail-total-amount"></span></p>
                <p><strong><span data-en="Payment Status:" data-ur="19171918141514 1914 1514131412:">Payment Status:</span></strong> <span id="detail-payment-status"></span></p>
                <p id="detail-amount-paid-row" style="display: none;"><strong><span data-en="Amount Paid:" data-ur="191719 121713 191619:">Amount Paid:</span></strong> <span id="detail-amount-paid"></span></p>

                <h4 style="margin-top: 20px;" data-en="Items" data-ur="1418111910">Items</h4>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-en="Product" data-ur="161912161911">Product</th>
                                <th data-en="Quantity" data-ur="1916171919">Quantity</th>
                                <th data-en="Unit Price" data-ur="1514 14121011 16141912">Unit Price</th>
                                <th data-en="Item Total" data-ur="14181119 1918">Item Total</th>
                            </tr>
                        </thead>
                        <tbody id="detail-items-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button id="print-bill-btn" class="btn btn-info no-print" data-en="Print Bill" data-ur="1018 16191011 19191416">Print Bill</button>
                <button id="delete-sale-purchase-btn" class="btn btn-danger no-print" data-en="Delete Transaction" data-ur="181410 171410 151815 19191416">Delete Transaction</button>
                <button id="process-return-btn" class="btn btn-warning no-print" data-en="Process Return" data-ur="1219161114 161912111411 19191416" style="display: none;">Process Return</button>
            </div>
        </div>
    </div>


    <!-- Return/Refund Modal -->
    <div id="return-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('return-modal')">&times;</span>
            <h3 id="return-modal-title">Process Return</h3>
            <p><span data-en="Transaction ID:" data-ur="181410 171410 ID:">Transaction ID:</span> <span id="return-transaction-id"></span></p>
            <p><span data-en="Customer/Supplier:" data-ur="13191915/111618191819:">Customer/Supplier:</span> <span id="return-entity-name"></span></p>
            <p><span data-en="Original Amount:" data-ur="191318 191619:">Original Amount:</span> <span id="return-original-amount"></span></p>

            <h4 data-en="Items to Return" data-ur="12191611 19191010 1910 1418111910">Items to Return</h4>
            <table class="data-table">
                <thead><tr><th data-en="Product" data-ur="161912161911">Product</th><th data-en="Max Qty" data-ur="1014191713 1110 1014191713 1916171919">Max Qty</th><th data-en="Return Qty" data-ur="12191611 1914 1916171919">Return Qty</th><th data-en="Price" data-ur="16141912">Price</th></tr></thead>
                <tbody id="return-items-table-body"></tbody>
            </table>

            <div class="form-group" style="margin-top: 15px;">
                <label for="return-refund-amount" data-en="Refund/Credit Amount" data-ur="191619 1914 1219161114/1919141611">Refund/Credit Amount</label>
                <input type="number" id="return-refund-amount" class="ledger-input" step="0.01" min="0" readonly>
            </div>
            <div class="form-group">
                <label for="return-notes" data-en="Return Notes (Optional)" data-ur="1219161114 1910 10121111 (19161214191914)">Return Notes</label>
                <textarea id="return-notes" class="ledger-textarea"></textarea>
            </div>
            <button type="button" id="confirm-return-btn" class="btn btn-success" data-en="Confirm Return" data-ur="1219161114 1914 1213171416 19191416">Confirm Return</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
             <span class="modal-close" onclick="closeModal('alert-modal')">&times;</span>
             <h4 id="alert-title">Alert</h4>
             <p id="alert-message" style="margin: 15px 0;"></p>
             <div id="alert-buttons" style="text-align: right;">
                 <button id="alert-ok-btn" class="btn btn-primary" onclick="closeModal('alert-modal')">OK</button>
                 <button id="alert-confirm-btn" class="btn btn-danger" style="display: none;">Confirm</button>
                 <button id="alert-cancel-btn" class="btn btn-secondary" style="display: none;" onclick="closeModal('alert-modal')">Cancel</button>
             </div>
        </div>
    </div>


    <script>
        // --- Constants and Globals ---
        const DB_NAME = 'ShopManagementDB';
        const DB_VERSION = 3; // Increment for stock adjustment and return transactions
        const STORES = {
            CUSTOMERS: 'customers',
            SUPPLIERS: 'suppliers',
            TRANSACTIONS: 'transactions', // Manual Khata entries
            PRODUCTS: 'products',
            STOCK_ADJUSTMENTS: 'stockAdjustments', // New store for stock changes
            SALES: 'sales',
            SALE_ITEMS: 'saleItems',
            PURCHASES: 'purchases',
            PURCHASE_ITEMS: 'purchaseItems',
            SETTINGS: 'settings' // New store for application settings
        };

        let db;
        let currentViewedId = null; // Customer/Supplier ID for details view
        let currentViewedType = null; // 'customer' or 'supplier'
        let currentLanguage = localStorage.getItem('khataLanguage') || 'en';
        let currentReportData = null; // To hold data for export/print

        // Sale/Purchase Form State
        let saleItems = [];
        let purchaseItems = [];
        let detailModalTransactionType = null; // To track if sale or purchase being viewed for details modal

        // --- IndexedDB Initialization ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => {
                    console.error("Database error:", event.target.errorCode);
                    customAlert(getLang("Error opening database..."), getLang("Database Error"));
                    reject("Error opening database");
                };
                request.onsuccess = (event) => { db = event.target.result; console.log("Database opened successfully"); resolve(db); };
                request.onupgradeneeded = (event) => {
                    db = event.target.result; console.log("Upgrading database..."); const transaction = event.target.transaction;
                    Object.values(STORES).forEach(storeName => {
                        if (!db.objectStoreNames.contains(storeName)) {
                            const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                            if (storeName === STORES.CUSTOMERS || storeName === STORES.SUPPLIERS || storeName === STORES.PRODUCTS) { store.createIndex('name', 'name', { unique: false }); }
                            if (storeName === STORES.TRANSACTIONS) { store.createIndex('entityId_type', ['entityId', 'entityType'], { unique: false }); store.createIndex('date', 'date', { unique: false }); }
                            if (storeName === STORES.SALE_ITEMS) { store.createIndex('saleId', 'saleId', { unique: false }); store.createIndex('productId', 'productId', { unique: false }); }
                            if (storeName === STORES.PURCHASE_ITEMS) { store.createIndex('purchaseId', 'purchaseId', { unique: false }); store.createIndex('productId', 'productId', { unique: false }); }
                            if (storeName === STORES.STOCK_ADJUSTMENTS) { store.createIndex('productId', 'productId', { unique: false }); store.createIndex('date', 'date', { unique: false }); }
                            if (storeName === STORES.SETTINGS) { /* No indexes, typically single record */ }
                        }
                    });
                    console.log("Database upgrade complete");
                };
            });
        }

        // --- Generic DB Operations (CRUD Helpers) ---
        function getStore(storeName, mode, transaction = null) {
            return transaction ? transaction.objectStore(storeName) : db.transaction(storeName, mode).objectStore(storeName);
        }
        function promise(request) {
            return new Promise((resolve, reject) => {
                request.onsuccess = event => resolve(event.target.result);
                request.onerror = event => reject(event.target.error);
            });
        }
        function addObject(storeName, object, transaction = null) { return promise(getStore(storeName, 'readwrite', transaction).add(object)); }
        function getObject(storeName, key, transaction = null) { return promise(getStore(storeName, 'readonly', transaction).get(key)); }
        function updateObject(storeName, object, transaction = null) { return promise(getStore(storeName, 'readwrite', transaction).put(object)); }
        function deleteObject(storeName, key, transaction = null) { return promise(getStore(storeName, 'readwrite', transaction).delete(key)); }
        function getAllObjects(storeName, indexName = null, query = null, transaction = null) { return promise((indexName ? getStore(storeName, 'readonly', transaction).index(indexName) : getStore(storeName, 'readonly', transaction)).getAll(query)); }

        // --- UI Rendering & Formatting ---
        function formatCurrency(amount) {
            const num = parseFloat(amount);
            if (isNaN(num)) return `Rs ---`;
            return `Rs ${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        function formatDate(dateString) {
            if (!dateString) return '';
             const date = new Date(dateString + 'T00:00:00');
             if (isNaN(date.getTime())) return 'Invalid Date';
            const options = { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Karachi' };
            try { return date.toLocaleDateString('en-PK', options); }
            catch (e) { return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); }
        }
        function renderBalance(balance) {
            const amount = parseFloat(balance);
            if (isNaN(amount)) return `<span>Rs ---</span>`;
            const formatted = formatCurrency(Math.abs(amount));
            if (amount > 0.005) { return `<span class="balance-negative">${formatted} (${getLang('Lena Hai')})</span>`; }
            else if (amount < -0.005) { return `<span class="balance-positive">${formatted} (${getLang('Dena Hai')})</span>`; }
            else { return `<span>${formatCurrency(0)} (${getLang('Settled')})</span>`; }
        }

        // --- Core Business Logic: Entities (Customer, Supplier, Product) ---
        async function saveEntity(type, data) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            if (data.id) { const existing = await getObject(storeName, data.id); data.balance = existing.balance; await updateObject(storeName, data); }
            else { data.balance = 0; delete data.id; await addObject(storeName, data); }
            customAlert(getLang(`${type}_saved_successfully`), getLang('Success')); closeModal(`${type}-form-modal`);
            await loadEntities(type); await updateDashboard();
        }
        async function editEntity(type, id) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, id);
            document.getElementById(`${type}-id`).value = entity.id; document.getElementById(`${type}-name`).value = entity.name;
            document.getElementById(`${type}-phone`).value = entity.phone || ''; document.getElementById(`${type}-address`).value = entity.address || '';
            document.getElementById(`${type}-modal-title`).textContent = getLang(`Edit ${type}`); openModal(`${type}-form-modal`);
        }
        async function confirmDeleteEntity(type, id) {
             customConfirm(getLang(`confirm_delete_${type}`),getLang("Confirm Deletion"), async () => {
                    const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
                    await deleteObject(storeName, id);
                    customAlert(getLang(`${type}_deleted_successfully`), getLang("Deleted"));
                    if (currentViewedId === id && currentViewedType === type) showListView(type);
                    await loadEntities(type); await updateDashboard();
                });
        }
        async function loadEntities(type, searchTerm = '') {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entities = await getAllObjects(storeName);
            const tableBody = document.getElementById(`${type}-table-body`); tableBody.innerHTML = '';
            const filtered = entities.filter(e => (e.name?.toLowerCase().includes(searchTerm.toLowerCase()) || e.phone?.includes(searchTerm)));
            if (filtered.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">${getLang(`no_${type}s_found`)}</td></tr>`; return; }
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            filtered.forEach(entity => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td><a href="#" onclick="event.preventDefault(); showDetailsView('${type}', ${entity.id});">${entity.name}</a></td>
                    <td class="hide-mobile">${entity.phone || '-'}</td><td>${renderBalance(entity.balance)}</td>
                    <td class="no-print"><button class="btn btn-warning btn-icon" onclick="editEntity('${type}', ${entity.id})" title="${getLang('Edit')}">7315</button>
                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteEntity('${type}', ${entity.id})" title="${getLang('Delete')}">9915</button></td>`;
            });
        }

        // Product Logic
        async function saveProduct(productData) {
            if (productData.id) { const existing = await getObject(STORES.PRODUCTS, productData.id); productData.quantity = existing.quantity; await updateObject(STORES.PRODUCTS, productData); }
            else { delete productData.id; await addObject(STORES.PRODUCTS, productData); }
            customAlert(getLang('product_saved_successfully'), getLang('Success')); closeModal('product-form-modal');
            await loadProducts(); await updateDashboard();
        }
        async function editProduct(id) {
             const product = await getObject(STORES.PRODUCTS, id);
             document.getElementById('product-id').value = product.id; document.getElementById('product-name').value = product.name;
             document.getElementById('product-category').value = product.category || ''; document.getElementById('product-sku').value = product.sku || '';
             document.getElementById('product-sale-price').value = product.salePrice; document.getElementById('product-purchase-price').value = product.purchasePrice;
             document.getElementById('product-quantity').value = product.quantity; document.getElementById('product-quantity').disabled = true;
             document.getElementById('product-low-stock').value = product.lowStockThreshold;
             document.getElementById('product-modal-title').textContent = getLang('Edit Product'); openModal('product-form-modal');
        }
        async function confirmDeleteProduct(id) {
            customConfirm(getLang('confirm_delete_product'),getLang('Confirm Deletion'), async () => {
                    await deleteObject(STORES.PRODUCTS, id);
                    customAlert(getLang('product_deleted_successfully'), getLang('Deleted'));
                    await loadProducts(); await updateDashboard();
                });
        }
        async function loadProducts(searchTerm = '') {
            const products = await getAllObjects(STORES.PRODUCTS);
            const tableBody = document.getElementById('product-table-body'); tableBody.innerHTML = '';
            const filtered = products.filter(p => p.name?.toLowerCase().includes(searchTerm.toLowerCase()) || p.sku?.toLowerCase().includes(searchTerm.toLowerCase()) || p.category?.toLowerCase().includes(searchTerm.toLowerCase()));
            if (filtered.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">${getLang('no_products_found')}</td></tr>`; return; }
            filtered.sort((a,b) => a.name.localeCompare(b.name));
            filtered.forEach(p => {
                let status = `<span class="stock-ok">${getLang('In Stock')}</span>`;
                if (p.quantity <= 0) { status = `<span class="stock-out">${getLang('Out of Stock')}</span>`; }
                else if (p.quantity <= p.lowStockThreshold) { status = `<span class="stock-low">${getLang('Low Stock')}</span>`; }
                const row = tableBody.insertRow();
                row.className = p.quantity <= 0 ? 'stock-out-row' : (p.quantity <= p.lowStockThreshold ? 'stock-low-row' : '');
                row.innerHTML = `<td>${p.name}</td><td>${p.category || '-'}</td><td>${p.sku || '-'}</td><td>${formatCurrency(p.salePrice)}</td>
                    <td class="hide-mobile">${formatCurrency(p.purchasePrice)}</td><td>${p.quantity}</td><td>${status}</td>
                    <td class="no-print"><button class="btn btn-warning btn-icon" onclick="editProduct(${p.id})">7315</button>
                    <button class="btn btn-info btn-icon" onclick="openStockAdjustmentModal(${p.id})">94</button>
                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteProduct(${p.id})">9915</button></td>`;
            });
        }
        async function openStockAdjustmentModal(productId) {
            const product = await getObject(STORES.PRODUCTS, productId);
            if (!product) { customAlert("Product not found.", "Error"); return; }
            document.getElementById('stock-adjustment-form').reset();
            document.getElementById('adj-product-id').value = product.id;
            document.getElementById('adj-product-name').textContent = product.name;
            document.getElementById('adj-current-stock').value = product.quantity;
            openModal('stock-adjustment-modal');
        }
        async function applyStockAdjustment(e) {
            e.preventDefault();
            const productId = parseInt(document.getElementById('adj-product-id').value);
            const type = document.getElementById('adj-type').value;
            const quantity = parseInt(document.getElementById('adj-quantity').value);
            const reason = document.getElementById('adj-reason').value.trim();
            if (!quantity || quantity <= 0) { customAlert("Quantity must be positive.", "Error"); return; }
            if (!reason) { customAlert("Reason is required.", "Error"); return; }

            const transaction = db.transaction([STORES.PRODUCTS, STORES.STOCK_ADJUSTMENTS], 'readwrite');
            try {
                const product = await getObject(STORES.PRODUCTS, productId, transaction);
                if (type === 'add') { product.quantity += quantity; }
                else if (type === 'deduct') {
                    if (product.quantity < quantity) { throw new Error("Cannot deduct more than current stock."); }
                    product.quantity -= quantity;
                }
                await updateObject(STORES.PRODUCTS, product, transaction);
                await addObject(STORES.STOCK_ADJUSTMENTS, { productId, date: new Date().toISOString().split('T')[0], type, quantity, reason, newStock: product.quantity }, transaction);
                await promise(transaction.done);
                customAlert("Stock adjusted successfully.", "Success");
                closeModal('stock-adjustment-modal');
                await loadProducts(); await updateDashboard();
            } catch (err) {
                transaction.abort(); customAlert(`Stock adjustment failed: ${err.message}`, "Error");
            }
        }


        // --- Core Business Logic: Transactions & Balances ---
        async function addTransaction(data, transaction) {
             await addObject(STORES.TRANSACTIONS, data, transaction);
             await updateEntityBalance(data.entityId, data.entityType, transaction);
        }
        async function updateEntityBalance(entityId, entityType, transaction) {
            const allTransactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]), transaction);
            const totalBalance = allTransactions.reduce((bal, tx) => bal + (tx.type === 'debit' ? tx.amount : -tx.amount), 0);
            const storeName = entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, entityId, transaction);
            if (entity) { entity.balance = totalBalance; await updateObject(storeName, entity, transaction); }
        }
        async function getTransactionsForEntity(entityId, entityType, startDate = null, endDate = null) {
            let transactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]));
            
            if (startDate) transactions = transactions.filter(t => t.date >= startDate);
            if (endDate) transactions = transactions.filter(t => t.date <= endDate);

            transactions.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime() || a.id - b.id);
            let runningBalance = 0;
            // Calculate opening balance for the filtered period
            if (startDate) {
                const prePeriodTransactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, entityType]));
                runningBalance = prePeriodTransactions.filter(t => t.date < startDate).reduce((bal, tx) => bal + (tx.type === 'debit' ? tx.amount : -tx.amount), 0);
            }
            return transactions.map(tx => {
                const amount = parseFloat(tx.amount);
                runningBalance += (tx.type === 'debit' ? amount : -amount);
                return { ...tx, balanceAfter: runningBalance };
            });
        }

        // --- UI Navigation & View Management ---
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`.nav-tab[data-page="${pageId}"]`).classList.add('active');
            const pageActions = {
                'dashboard-page': updateDashboard, 'customers-page': () => loadEntities('customer'),
                'suppliers-page': () => loadEntities('supplier'), 'inventory-page': loadProducts,
                'sales-page': loadSales, 'purchases-page': loadPurchases, 'reports-page': handleReportTypeChange,
                'settings-page': loadSettings
            };
            if(pageActions[pageId]) pageActions[pageId]();
        }
        function showListView(type) {
            document.getElementById(`${type}-details-view`).style.display = 'none'; document.getElementById(`${type}-list-view`).style.display = 'block';
            currentViewedId = null; currentViewedType = null; loadEntities(type);
        }
        async function showDetailsView(type, id) {
             currentViewedId = id; currentViewedType = type;
             const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
             const entity = await getObject(storeName, id);
             if (!entity) { customAlert(getLang(`${type}_not_found`), getLang("Error")); showListView(type); return; }
             document.getElementById(`details-${type}-name`).textContent = entity.name;
             document.getElementById(`${type}-info`).innerHTML = `
                <p><strong>${getLang('Phone')}:</strong> ${entity.phone || '-'} | <strong>${getLang('Address')}:</strong> ${entity.address || '-'}</p>
                <p><strong>${getLang('Current Balance')}:</strong> <span id="details-current-balance-${type}-header">${renderBalance(entity.balance)}</span></p>`;
             
             // Reset ledger filters when opening details view
             document.getElementById(`${type}-ledger-start-date`).value = '';
             document.getElementById(`${type}-ledger-end-date`).value = '';

             await loadTransactionsForView(type, id);
             document.getElementById(`${type}-list-view`).style.display = 'none'; document.getElementById(`${type}-details-view`).style.display = 'block';
        }
        async function loadTransactionsForView(type, id) {
            const startDate = document.getElementById(`${type}-ledger-start-date`)?.value || null;
            const endDate = document.getElementById(`${type}-ledger-end-date`)?.value || null;

            const transactions = (await getTransactionsForEntity(id, type, startDate, endDate)).reverse();
            const table = document.getElementById(`transaction-table-${type}`);
            const balanceSummary = document.getElementById(`details-current-balance-${type}`);
            const entity = await getObject(type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, id);

            table.innerHTML = `<thead><tr><th>${getLang("Date")}</th><th>${getLang("Description")}</th><th>${getLang("Debit")}</th><th>${getLang("Credit")}</th><th>${getLang("Balance")}</th><th>${getLang("Actions")}</th></tr></thead>
                <tbody>${transactions.map(tx => `<tr><td>${formatDate(tx.date)}</td><td>${tx.description || '-'}</td>
                    <td>${tx.type === 'debit' ? formatCurrency(tx.amount) : '-'}</td><td>${tx.type === 'credit' ? formatCurrency(tx.amount) : '-'}</td>
                    <td>${renderBalance(tx.balanceAfter)}</td>
                    <td><button class="btn btn-warning btn-icon" onclick="editManualTransaction(${tx.id})">7315</button>
                    <button class="btn btn-danger btn-icon" onclick="confirmDeleteManualTransaction(${tx.id})">9915</button></td></tr>`).join('')}</tbody>`;
             if (transactions.length === 0) { table.querySelector('tbody').innerHTML = `<tr><td colspan="6" style="text-align:center;">${getLang('no_transactions_found')}</td></tr>`; }
             balanceSummary.innerHTML = renderBalance(entity.balance);
             document.getElementById(`details-current-balance-${type}-header`).innerHTML = renderBalance(entity.balance);
        }

        async function editManualTransaction(transactionId) {
            const tx = await getObject(STORES.TRANSACTIONS, transactionId);
            if (!tx) { customAlert("Transaction not found.", "Error"); return; }
            document.getElementById('transaction-id').value = tx.id;
            document.getElementById('transaction-entity-id').value = tx.entityId;
            document.getElementById('transaction-entity-type').value = tx.entityType;
            document.getElementById('transaction-modal-entity-name').textContent = (await getObject(tx.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, tx.entityId))?.name || 'N/A';
            document.getElementById('transaction-date').value = tx.date;
            document.getElementById('transaction-type').value = tx.type;
            document.getElementById('transaction-amount').value = tx.amount;
            document.getElementById('transaction-description').value = tx.description;
            openModal('transaction-form-modal');
        }

        async function confirmDeleteManualTransaction(transactionId) {
            customConfirm(getLang("Are you sure you want to delete this manual transaction?"), getLang("Confirm Deletion"), async () => {
                const tx = await getObject(STORES.TRANSACTIONS, transactionId);
                if (!tx) { customAlert("Transaction not found.", "Error"); return; }
                const transaction = db.transaction([STORES.TRANSACTIONS, STORES.CUSTOMERS, STORES.SUPPLIERS], 'readwrite');
                try {
                    await deleteObject(STORES.TRANSACTIONS, transactionId, transaction);
                    await updateEntityBalance(tx.entityId, tx.entityType, transaction);
                    await promise(transaction.done);
                    customAlert("Manual transaction deleted successfully.", "Success");
                    await loadTransactionsForView(tx.entityType, tx.entityId);
                } catch (err) {
                    transaction.abort(); customAlert(`Deletion failed: ${err.message}`, "Error");
                }
            });
        }


        // --- Event Listener Setup ---
        function setupEventListeners() {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => switchPage(tab.dataset.page)));
            document.getElementById('add-customer-btn').addEventListener('click', () => {
                document.getElementById('customer-form').reset(); document.getElementById('customer-id').value = '';
                document.getElementById('customer-modal-title').textContent = getLang('Add New Customer'); openModal('customer-form-modal');
            });
            document.getElementById('customer-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveEntity('customer', { id: parseInt(document.getElementById('customer-id').value) || null, name: document.getElementById('customer-name').value.trim(), phone: document.getElementById('customer-phone').value.trim(), address: document.getElementById('customer-address').value.trim(), });
            });
            document.getElementById('customer-search').addEventListener('input', (e) => loadEntities('customer', e.target.value));
            document.getElementById('back-to-list-btn-customer').addEventListener('click', () => showListView('customer'));
            document.getElementById('add-manual-transaction-btn-customer').addEventListener('click', () => openManualTransactionModal('customer', currentViewedId));
            document.getElementById('customer-ledger-filter-btn').addEventListener('click', () => loadTransactionsForView('customer', currentViewedId));
            document.getElementById('customer-ledger-clear-filter-btn').addEventListener('click', () => { document.getElementById('customer-ledger-start-date').value = ''; document.getElementById('customer-ledger-end-date').value = ''; loadTransactionsForView('customer', currentViewedId); });

            document.getElementById('add-supplier-btn').addEventListener('click', () => {
                document.getElementById('supplier-form').reset(); document.getElementById('supplier-id').value = '';
                document.getElementById('supplier-modal-title').textContent = getLang('Add New Supplier'); openModal('supplier-form-modal');
            });
            document.getElementById('supplier-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveEntity('supplier', { id: parseInt(document.getElementById('supplier-id').value) || null, name: document.getElementById('supplier-name').value.trim(), phone: document.getElementById('supplier-phone').value.trim(), address: document.getElementById('supplier-address').value.trim(), });
            });
            document.getElementById('supplier-search').addEventListener('input', (e) => loadEntities('supplier', e.target.value));
            document.getElementById('back-to-list-btn-supplier').addEventListener('click', () => showListView('supplier'));
            document.getElementById('add-manual-transaction-btn-supplier').addEventListener('click', () => openManualTransactionModal('supplier', currentViewedId));
            document.getElementById('supplier-ledger-filter-btn').addEventListener('click', () => loadTransactionsForView('supplier', currentViewedId));
            document.getElementById('supplier-ledger-clear-filter-btn').addEventListener('click', () => { document.getElementById('supplier-ledger-start-date').value = ''; document.getElementById('supplier-ledger-end-date').value = ''; loadTransactionsForView('supplier', currentViewedId); });


            document.getElementById('add-product-btn').addEventListener('click', () => {
                document.getElementById('product-form').reset(); document.getElementById('product-id').value = '';
                document.getElementById('product-quantity').disabled = false;
                document.getElementById('product-modal-title').textContent = getLang('Add New Product'); openModal('product-form-modal');
            });
            document.getElementById('product-form').addEventListener('submit', (e) => {
                e.preventDefault(); saveProduct({ id: parseInt(document.getElementById('product-id').value) || null, name: document.getElementById('product-name').value.trim(), category: document.getElementById('product-category').value.trim(), sku: document.getElementById('product-sku').value.trim(), salePrice: parseFloat(document.getElementById('product-sale-price').value), purchasePrice: parseFloat(document.getElementById('product-purchase-price').value), quantity: parseInt(document.getElementById('product-quantity').value), lowStockThreshold: parseInt(document.getElementById('product-low-stock').value) });
            });
            document.getElementById('product-search').addEventListener('input', (e) => loadProducts(e.target.value));
            document.getElementById('adjust-stock-btn').addEventListener('click', () => { customAlert("Select a product from the table first, then click the '94' icon to adjust its stock.", "Info"); });
            document.getElementById('stock-adjustment-form').addEventListener('submit', applyStockAdjustment);


            document.getElementById('transaction-form').addEventListener('submit', async e => {
                e.preventDefault(); 
                const transaction = db.transaction([STORES.TRANSACTIONS, STORES.CUSTOMERS, STORES.SUPPLIERS], 'readwrite');
                const data = { id: parseInt(document.getElementById('transaction-id').value) || null, entityId: parseInt(document.getElementById('transaction-entity-id').value), entityType: document.getElementById('transaction-entity-type').value, date: document.getElementById('transaction-date').value, type: document.getElementById('transaction-type').value, amount: parseFloat(document.getElementById('transaction-amount').value), description: document.getElementById('transaction-description').value.trim() };
                
                if (data.id) { // Editing existing manual transaction
                    const oldTx = await getObject(STORES.TRANSACTIONS, data.id, transaction);
                    // Temporarily revert old transaction's impact to re-apply new one
                    const tempEntity = await getObject(oldTx.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, oldTx.entityId, transaction);
                    tempEntity.balance -= (oldTx.type === 'debit' ? oldTx.amount : -oldTx.amount);
                    await updateObject(tempEntity.entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS, tempEntity, transaction);
                    
                    await updateObject(STORES.TRANSACTIONS, data, transaction);
                } else { // Adding new manual transaction
                    await addObject(STORES.TRANSACTIONS, data, transaction);
                }
                await updateEntityBalance(data.entityId, data.entityType, transaction);

                await promise(transaction.done);
                customAlert(getLang('transaction_saved_successfully'), getLang('Success')); closeModal('transaction-form-modal');
                await loadTransactionsForView(data.entityType, data.entityId);
            });


             document.getElementById('add-sale-btn').addEventListener('click', openSaleModal);
             document.getElementById('sale-form').addEventListener('submit', completeSale);
             document.getElementById('add-sale-item-btn').addEventListener('click', addSaleItem);
             document.getElementById('sale-payment-status').addEventListener('change', (e) => { document.getElementById('sale-amount-paid-div').style.display = e.target.value === 'partially_paid' ? 'block' : 'none'; });
             document.getElementById('sale-product-select').addEventListener('change', (e) => {}); // No action needed here, already handled by addSaleItem button

             document.getElementById('add-purchase-btn').addEventListener('click', openPurchaseModal);
             document.getElementById('purchase-form').addEventListener('submit', completePurchase);
             document.getElementById('add-purchase-item-btn').addEventListener('click', addPurchaseItem);
             document.getElementById('purchase-payment-status').addEventListener('change', (e) => { document.getElementById('purchase-amount-paid-div').style.display = e.target.value === 'partially_paid' ? 'block' : 'none'; });
             document.getElementById('purchase-product-select').addEventListener('change', async (e) => {
                 const selectedProductId = parseInt(e.target.value);
                 if (selectedProductId) { const product = await getObject(STORES.PRODUCTS, selectedProductId); document.getElementById('purchase-item-price').value = product.purchasePrice || 0; }
                 else { document.getElementById('purchase-item-price').value = ''; }
             });

             // Sale/Purchase Details Modal buttons
             document.getElementById('print-bill-btn').addEventListener('click', printCurrentBillInvoice);
             document.getElementById('delete-sale-purchase-btn').addEventListener('click', confirmDeleteSaleOrPurchase);
             document.getElementById('process-return-btn').addEventListener('click', openReturnModal);


             document.getElementById('backup-btn').addEventListener('click', backupData);
             document.getElementById('restore-file').addEventListener('change', handleRestoreFile);
             document.getElementById('language-switch').addEventListener('change', (e) => setLanguage(e.target.value));
             document.getElementById('generate-report-btn').addEventListener('click', generateReport);
             document.getElementById('print-report-btn').addEventListener('click', printReport);
             document.getElementById('export-csv-btn').addEventListener('click', exportReportToCSV);
             document.getElementById('report-type-select').addEventListener('change', handleReportTypeChange);

             // Settings page
             document.getElementById('settings-form').addEventListener('submit', saveSettings);
             document.getElementById('export-customers-btn').addEventListener('click', () => exportDataToCSV(STORES.CUSTOMERS));
             document.getElementById('export-products-btn').addEventListener('click', () => exportDataToCSV(STORES.PRODUCTS));
             document.getElementById('export-transactions-btn').addEventListener('click', () => exportDataToCSV(STORES.TRANSACTIONS));

             // Return modal
             document.getElementById('confirm-return-btn').addEventListener('click', confirmProcessReturn);
        }

        async function openManualTransactionModal(type, id) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, id);
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = ''; // Ensure no ID for new transaction
            document.getElementById('transaction-entity-id').value = id;
            document.getElementById('transaction-entity-type').value = type;
            document.getElementById('transaction-modal-entity-name').textContent = entity.name;
            document.getElementById('transaction-date').valueAsDate = new Date();
            openModal('transaction-form-modal');
        }

        // --- MODAL, ALERT, CONFIRM, and LANGUAGE functions ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) { closeModal(event.target.id); } });

        function customAlert(message, titleKey = "Alert") {
            document.getElementById('alert-title').textContent = getLang(titleKey);
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-confirm-btn').style.display = 'none';
            document.getElementById('alert-cancel-btn').style.display = 'none';
            document.getElementById('alert-ok-btn').style.display = 'inline-block';
            document.getElementById('alert-ok-btn').textContent = getLang("OK");
            openModal('alert-modal');
        }

        function customConfirm(message, titleKey = "Confirm", onConfirm, onCancel = null) {
            document.getElementById('alert-title').textContent = getLang(titleKey);
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-ok-btn').style.display = 'none';
            document.getElementById('alert-confirm-btn').style.display = 'inline-block';
            document.getElementById('alert-cancel-btn').style.display = 'inline-block';
            document.getElementById('alert-confirm-btn').textContent = getLang("Confirm");
            document.getElementById('alert-cancel-btn').textContent = getLang("Cancel");
            const confirmBtn = document.getElementById('alert-confirm-btn');
            confirmBtn.onclick = () => { closeModal('alert-modal'); if (onConfirm) onConfirm(); };
             document.getElementById('alert-cancel-btn').onclick = () => { closeModal('alert-modal'); if (onCancel) onCancel(); };
            openModal('alert-modal');
        }

        const translations = {
            en: {"Shop Management System":"Shop Management System","Dashboard":"Dashboard","Sales":"Sales","Purchases":"Purchases","Customers":"Customers","Suppliers":"Suppliers","Inventory":"Inventory","Reports":"Reports","Settings":"Settings","Total Customers":"Total Customers","Receivables (Lena Hai)":"Receivables (Lena Hai)","Payables (Dena Hai)":"Payables (Dena Hai)","Low Stock Items":"Low Stock Items","Total Inventory Value":"Total Inventory Value","Backup & Restore":"Backup & Restore","Backup Data (JSON)":"Backup Data (JSON)","Restore Data (JSON)":"Restore Data (JSON)","Sales History":"Sales History","New Sale":"New Sale","Date":"Date","Customer":"Customer","Amount":"Amount","Status":"Status","Actions":"Actions","Purchase History":"Purchase History","New Purchase":"New Purchase","Supplier":"Supplier","Add New Customer":"Add New Customer","Search Customers...":"Search Customers...","Name":"Name","Phone":"Phone","Balance":"Balance","no_customers_found":"No customers found.","Edit":"Edit","Delete":"Delete","Customer Details":"Customer Details","Back to List":"Back to List","Address":"Address","Current Balance:":"Current Balance:","Transactions":"Transactions","Add Manual Transaction":"Add Manual Transaction","no_transactions_found":"No transactions found.","Add New Supplier":"Add New Supplier","Search Suppliers...":"Search Suppliers...","no_suppliers_found":"No suppliers found.","Supplier Details":"Supplier Details","Product Inventory":"Product Inventory","Add New Product":"Add New Product","Search Products...":"Search Products...","Product Name":"Product Name","Category":"Category","SKU":"SKU","Sale Price":"Sale Price","Purchase Price":"Purchase Price","Stock":"Stock","no_products_found":"No products found.","Adjust Stock":"Adjust Stock","Report Type":"Report Type","Sales Report":"Sales Report","Purchase Report":"Purchase Report","Profit & Loss Report":"Profit & Loss Report","Inventory Report":"Inventory Report","Customer Ledger":"Customer Ledger","Supplier Ledger":"Supplier Ledger","Start Date":"Start Date","End Date":"End Date","Select Entity":"Select Entity","Generate Report":"Generate Report","Print / PDF":"Print / PDF","Export to Excel (CSV)":"Export to Excel (CSV)","Select a report type and date range, then click 'Generate Report'.":"Select a report type and date range, then click 'Generate Report'.","Shop Name":"Shop Name","Shop Phone":"Shop Phone","Shop Address":"Shop Address","Save Settings":"Save Settings","Data Import/Export":"Data Import/Export","Export Customers":"Export Customers","Export Products":"Export Products","Export All Transactions":"Export All Transactions","Phone (Optional)":"Phone (Optional)","Address (Optional)":"Address (Optional)","Save Customer":"Save Customer","customer_saved_successfully":"Customer saved successfully.","confirm_delete_customer":"Are you sure you want to delete this customer? Their transaction history will remain for reporting.","customer_deleted_successfully":"Customer deleted successfully.","customer_not_found":"Customer not found.","Save Supplier":"Save Supplier","supplier_saved_successfully":"Supplier saved successfully.","confirm_delete_supplier":"Are you sure you want to delete this supplier? Their transaction history will remain for reporting.","supplier_deleted_successfully":"Supplier deleted successfully.","supplier_not_found":"Supplier not found.","Category (Optional)":"Category (Optional)","SKU / Barcode (Optional)":"SKU / Barcode (Optional)","Sale Price (Rs)":"Sale Price (Rs)","Purchase Price (Rs)":"Purchase Price (Rs)","Initial Stock Quantity":"Initial Stock Quantity","Low Stock Alert Level":"Low Stock Alert Level","Save Product":"Save Product","product_saved_successfully":"Product saved successfully.","confirm_delete_product":"Are you sure you want to delete this product?","product_deleted_successfully":"Product deleted successfully.","Edit Product":"Edit Product","In Stock":"In Stock","Out of Stock":"Out of Stock","Low Stock":"Low Stock","Adjust Stock for":"Adjust Stock for","Current Stock":"Current Stock","Adjustment Type":"Adjustment Type","Add Stock":"Add Stock","Deduct Stock":"Deduct Stock","Quantity to Adjust":"Quantity to Adjust","Reason (e.g., Damage, Theft)":"Reason (e.g., Damage, Theft)","Apply Adjustment":"Apply Adjustment","Stock adjusted successfully.":"Stock adjusted successfully.","Quantity must be positive.":"Quantity must be positive.","Reason is required.":"Reason is required.","Cannot deduct more than current stock.":"Cannot deduct more than current stock.","Stock adjustment failed:":"Stock adjustment failed:","Add Manual Transaction for":"Add Manual Transaction for","Transaction Type":"Transaction Type","Debit (Payment Made / Sale)":"Debit (Payment Made / Sale)","Credit (Payment Received)":"Credit (Payment Received)","Amount (Rs)":"Amount (Rs)","Description":"Description","Save Transaction":"Save Transaction","transaction_saved_successfully":"Transaction saved successfully.","Are you sure you want to delete this manual transaction?":"Are you sure you want to delete this manual transaction?","Manual transaction deleted successfully.":"Manual transaction deleted successfully.","New Sale / Invoice":"New Sale / Invoice","Customer (Optional)":"Customer (Optional)","Add Products":"Add Products","Product":"Product","Quantity":"Quantity","Add Item":"Add Item","Qty":"Qty","Price":"Price","Total":"Total","Total Amount:":"Total Amount:","Payment Status":"Payment Status","Paid (Cash Sale)":"Paid (Cash Sale)","Credit (Add to Khata)":"Credit (Add to Khata)","Partially Paid":"Partially Paid","Amount Paid":"Amount Paid","Complete Sale":"Complete Sale","Please add items to the sale.":"Please add items to the sale.","Selected customer is required for credit sales.":"Selected customer is required for credit sales.","Selected customer is required for partial sales.":"Selected customer is required for partial sales.","Amount paid cannot be equal to or greater than total for a partial payment.":"Amount paid cannot be equal to or greater than total for a partial payment.","Amount paid must be greater than zero for a partial payment.":"Amount paid must be greater than zero for a partial payment.","Sale completed successfully.":"Sale completed successfully.","Sale failed:":"Sale failed:","New Purchase":"New Purchase","Unit Price":"Unit Price","Paid":"Paid","Complete Purchase":"Complete Purchase","Please add items to the purchase.":"Please add items to the purchase.","Purchase completed successfully.":"Purchase completed successfully.","Purchase failed:":"Purchase failed:","Alert":"Alert","OK":"OK","Confirm":"Confirm","Success":"Success","Error":"Error","Deleted":"Deleted","Lena Hai":"Receivable","Dena Hai":"Payable","Settled":"Settled","Language":"Language","Error opening database...":"Error opening database. Please check browser permissions and disable private mode.","Database Error":"Database Error", "Item Total": "Item Total", "Associated Entity:": "Associated Entity:", "Sale Details": "Sale Details", "Purchase Details": "Purchase Details", "Items": "Items", "Print Bill": "Print Bill", "Delete Transaction": "Delete Transaction", "Process Return": "Process Return", "Return Notes (Optional)": "Return Notes (Optional)", "Confirm Return": "Confirm Return", "Transaction ID:": "Transaction ID:", "Customer/Supplier:": "Customer/Supplier:", "Original Amount:": "Original Amount:", "Items to Return": "Items to Return", "Max Qty": "Max Qty", "Return Qty": "Return Qty", "Refund/Credit Amount": "Refund/Credit Amount", "Return processed successfully.":"Return processed successfully.", "Return failed:":"Return failed:", "Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries.":"Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries.", "Sale/Purchase deleted successfully.":"Sale/Purchase deleted successfully.", "Cannot return more than original quantity.":"Cannot return more than original quantity.", "Invalid return quantity.":"Invalid return quantity.", "Please enter a reason for the return.":"Please enter a reason for the return.", "Cannot process return for zero quantity.":"Cannot process return for zero quantity.", "Refund/Return": "Refund/Return", "Supplier Return": "Supplier Return", "Grand Total:": "Grand Total:", "Balance Due:": "Balance Due:", "Thank you for your business!": "Thank you for your business!", "Bill/Invoice": "Bill/Invoice", "Bill": "Bill", "Invoice": "Invoice", "Info": "Info", "Select a product from the table first, then click the '94' icon to adjust its stock.": "Select a product from the table first, then click the '94' icon to adjust its stock.", "Settings saved successfully.": "Settings saved successfully."
            },
            ur: {"Shop Management System":"121916 19141014191011 11111119","Dashboard":"161412 10121916","Sales":"1519121612","Purchases":"16191417191914","Customers":"131919151410","Suppliers":"11161819181910","Inventory":"1910121410111914","Reports":"191612191111","Settings":"111411101510","Total Customers":"1918 131919151410","Receivables (Lena Hai)":"121914101912 (18141019 1310)","Payables (Dena Hai)":"12191410 1918191719 (17141019 1310)","Low Stock Items":"1919 1911111919 1418111910","Total Inventory Value":"1918 1910121410111914 1919181412","Backup & Restore":"101419 1916 191219 10151918 19191416","Backup Data (JSON)":"16141119 101419 1916 (JSON)","Restore Data (JSON)":"16141119 10151918 19191416 (JSON)","Sales History":"1519121612 1914 111915101212","New Sale":"101814 1519121612","Date":"1219191416","Customer":"13191915","Amount":"191619","Status":"1514131412","Actions":"191919121918141916","Purchase History":"16191417191914 1914 111915101212","New Purchase":"101814 16191417191914","Supplier":"111618191819","Add New Customer":"101419 13191915 12191918 19191416","Search Customers...":"131919151410 12181912 19191416...","Name":"101919","Phone":"151210","Balance":"1014181011","no_customers_found":"19121814 13191915 10131416 19181912","Edit":"1219191419","Delete":"151815 19191416","Customer Details":"13191915 1914 12151314181912","Back to List":"1513191112 1619 12191611","Address":"161213","Current Balance:":"191214121713 1014181011:","Transactions":"181410 171410","Add Manual Transaction":"17111214 181410 171410 12191918 19191416","no_transactions_found":"19121814 181410 171410 10131416 19181912","Add New Supplier":"101419 111618191819 12191918 19191416","Search Suppliers...":"11161819181910 12181912 19191416...","no_suppliers_found":"19121814 111618191819 10131416 19181912","Supplier Details":"111618191819 1914 12151314181912","Product Inventory":"19131012171912 1914 1910121410111914","Add New Product":"101814 161912161911 12191918 19191416","Search Products...":"16191216191111 12181912 19191416...","Product Name":"161912161911 1919 101919","Category":"10191913","SKU":"191411 1910 1412","Sale Price":"1519121612 1914 16141912","Purchase Price":"16191417191914 1914 16141912","Stock":"1911111919","no_products_found":"19121814 161912161911 10131416 19181412","Adjust Stock":"1911111919 191416141111 19191416","Report Type":"1916121911 1914 161119","Sales Report":"11141810 1916121911","Purchase Report":"1619141410 1916121911","Profit & Loss Report":"101517 12 1016131910 1914 1916121911","Inventory Report":"1910121410111914 1916121911","Customer Ledger":"1911111919 18141419","Supplier Ledger":"111618191819 18141419","Start Date":"12191217191214 1219191416","End Date":"19161212191914 1219191416","Select Entity":"19141011141114 1910121610 19191416","Generate Report":"1916121911 101019181416","Print / PDF":"16191011 / 1614 1614 191415","Export to Excel (CSV)":"1914191118 191416 1914191116121911","Select a report type and date range, then click 'Generate Report'.":"1916121911 1914 161119 191219 1219191416 1914 1517 1910121610 1919141612 161019 '1916121911 101019181416' 1619 191819 1919141612","Shop Name":"17191910 1919 101919","Shop Phone":"17191910 1919 151210","Shop Address":"17191910 1919 161213","Save Settings":"111411101510 1915151216 19191416","Data Import/Export":"16141119 1719141917/1019141917","Export Customers":"131919151410 1019141917 19191416","Export Products":"19131012171912 1019141917 19191416","Export All Transactions":"12191919 181410 171410 1019141917 19191416","Phone (Optional)":"151210 (19161214191914)","Address (Optional)":"161213 (19161214191914)","Save Customer":"13191915 1915151216 19191416","customer_saved_successfully":"13191915 19191914191014 1110 1915151216 1312 15141912","confirm_delete_customer":"191419 1416 1219161714 1911 13191915 1912 151815 19191019 1419131210 13141611 1910 1914 181410 171410 1914 1219191416 19161219111015 1910 181410 10191614 191310 151412","customer_deleted_successfully":"13191915 19191914191014 1110 151815 1312 15141912","customer_not_found":"13191915 10131416 19181912","Save Supplier":"111618191819 1915151216 19191416","supplier_saved_successfully":"111618191819 19191914191014 1110 1915151216 1312 15141912","confirm_delete_supplier":"191419 1416 1219161714 1911 111618191819 1912 151815 19191019 1419131210 13141611 1910 1914 181410 171410 1914 1219191416 19161219111015 1910 181410 10191614 191310 151412","supplier_deleted_successfully":"111618191819 19191914191014 1110 151815 1312 15141912","supplier_not_found":"111618191819 10131416 19181912","Category (Optional)":"10191913 (19161214191914)","SKU / Barcode (Optional)":"191411 1910 1412 / 101919 191216 (19161214191914)","Sale Price (Rs)":"1519121612 1914 16141912 (19121610)","Purchase Price (Rs)":"16191417191914 1914 16141912 (19121610)","Initial Stock Quantity":"19101217191814 1911111919 1916171919","Low Stock Alert Level":"1919 1911111919 19181911 18141218","Save Product":"161912161911 1915151216 19191416","product_saved_successfully":"161912161911 19191914191014 1110 1915151216 1312 15141912","confirm_delete_product":"191419 1416 1219161714 1911 161912161911 1912 151815 19191019 1419131210 13141611","product_deleted_successfully":"161912161911 19191914191014 1110 151815 1312 15181412","Edit Product":"161912161911 191416 1219191419 19191416","In Stock":"1911111919 191416 1310","Out of Stock":"1911111919 161219","Low Stock":"1919 1911111919","Adjust Stock for":"1911111919 191416141111 19191416","Current Stock":"191214121713 1911111919","Adjustment Type":"191416141111191011 1914 161119","Add Stock":"1911111919 12191918 19191416","Deduct Stock":"1911111919 1919 19191416","Quantity to Adjust":"191416141111 19191010 1914 1916171919","Reason (e.g., Damage, Theft)":"121413 (191318191512 101613191012 14121914)","Apply Adjustment":"191416141111191011 18191512 19191416","Stock adjusted successfully.":"1911111919 19191914191014 1110 191416141111 1312 15141912","Quantity must be positive.":"1916171919 19131012 13121014 141913141012","Reason is required.":"121413 1719191919 131012","Cannot deduct more than current stock.":"191214121713 1911111919 1110 1014191713 1919 10131416 191419 1419 1119121912","Stock adjustment failed:":"1911111919 191416141111191011 1019191919:","Add Manual Transaction for":"1910 181410 17111214 181410 171410 12191918 19191416","Transaction Type":"181410 171410 1914 161119","Debit (Payment Made / Sale)":"16141011 (19171918141514 1914 / 1519121612)","Credit (Payment Received)":"1919141611 (19171918141514 12131218 1914)","Amount (Rs)":"191619 (19121610)","Description":"1215131418","Save Transaction":"181410 171410 1915151216 19191416","transaction_saved_successfully":"181410 171410 19191914191014 1110 1915151216 1312 15141912","Are you sure you want to delete this manual transaction?":"191419 1416 1219161714 1911 17111214 181410 171410 1912 151815 19191019 1419131210 13141611","Manual transaction deleted successfully.":"17111214 181410 171410 19191914191014 1110 151815 1312 15141912","New Sale / Invoice":"101814 1519121612 / 191012191811","Customer (Optional)":"13191915 (19161214191914)","Add Products":"19131012171912 12191918 19191416","Product":"161912161911","Quantity":"1916171919","Add Item":"14181119 12191918 19191416","Qty":"1916171919","Price":"16141912","Total":"1918","Total Amount:":"1918 191619:","Payment Status":"19171918141514 1914 1514131412","Paid (Cash Sale)":"191719 121713 (101617 1519121612)","Credit (Add to Khata)":"1917101919 (1910191213 191416 12191918 19191416)","Partially Paid":"14101214 151219 1619 191719 121713","Amount Paid":"191719 121713 191619","Complete Sale":"1519121612 19191918 19191416","Please add items to the sale.":"10191913 191919 1519121612 191416 1418111910 12191918 1919141612","Selected customer is required for credit sales.":"1917101919 1519121612 1910 181410 13191915 1919 191012161910 1419121914 131012","Selected customer is required for partial sales.":"14101214 1519121612 1910 181410 13191915 1919 191012161910 1419121914 131012","Amount paid cannot be equal to or greater than total for a partial payment.":"14101214 19171918141514 1910 181410 191719 121713 191619 1918 191619 1910 1019191019 1419 1911 1110 1014191713 10131416 1312 1119121412","Amount paid must be greater than zero for a partial payment.":"14101214 19171918141514 1910 181410 191719 121713 191619 131519 1110 1014191713 13121014 141913141012","Sale completed successfully.":"1519121612 19191914191014 1110 19191918 1312181412","Sale failed:":"1519121612 1019191919:","New Purchase":"101814 16191417191914","Unit Price":"1514 14121011 16141912","Paid":"191719 121713","Complete Purchase":"16191417191914 19191918 19191416","Please add items to the purchase.":"10191913 191919 16191417191914 191416 1418111910 12191918 1919141612","Purchase completed successfully.":"16191417191914 19191914191014 1110 19191918 1312181412","Purchase failed:":"16191417191914 1019191919:","Alert":"191012101913","OK":"11101419 1310","Confirm":"1213171416 19191416","Success":"19191914191014","Error":"1619191014","Deleted":"151815 1919 171419 15141912","Lena Hai":"18141019 1310","Dena Hai":"17141019 1310","Settled":"15111910 1019191019","Language":"10101910","Error opening database...":"16141119 101411 191012181010 191416 161919101412 10191913 191919 101919161019 1914 1914191012 1912 141419 19191416 191219 101414 191216 1912 181419 15171918 1919141612","Database Error":"16141119 101411 1914 1619191014", "Item Total": "14181119 1918", "Associated Entity:": "191217181613 19141011141114:", "Sale Details": "1519121612 1914 12151314181912", "Purchase Details": "16191417191914 1914 12151314181912", "Items": "1418111910", "Print Bill": "1018 16191011 19191416", "Delete Transaction": "181410 171410 151815 19191416", "Process Return": "1219161114 161912111411 19191416", "Return Notes (Optional)": "1219161114 1910 10121111 (19161214191914)", "Confirm Return": "1219161114 1914 1213171416 19191416", "Transaction ID:": "181410 171410 ID:", "Customer/Supplier:": "13191915/111618191819:", "Original Amount:": "191318 191619:", "Items to Return": "12191611 19191010 1910 1418111910", "Max Qty": "1014191713 1110 1014191713 1916171919", "Return Qty": "12191611 1914 1916171919", "Refund/Credit Amount": "191619 1914 1219161114/1919141611", "Return processed successfully.":"1219161114 19191914191014 1110 161912111411 1312 15181412", "Return failed:":"1219161114 1019191919:", "Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries.":"191419 1416 1219161714 1911 1519121612/16191417191914 1912 151815 19191019 1419131210 13141611 1413 1911111919 191219 1910191213 1910 1910171919141912 1912 12191611 1919 1710 151912", "Sale/Purchase deleted successfully.":"1519121612/16191417191914 19191914191014 1110 151815 1312 15181412", "Cannot return more than original quantity.":"191318 1916171919 1110 1014191713 12191611 10131416 191419 1419 1119121912", "Invalid return quantity.":"181815 1219161114 191617191912", "Please enter a reason for the return.":"10191913 191919 1219161114 1914 121413 171914 1919141612", "Cannot process return for zero quantity.":"131519 1916171919 1910 181410 1219161114 161912111411 10131416 1914 1419 1119121412", "Refund/Return": "191619 1914 1219161114/1219161114", "Supplier Return": "111618191819 1219161114", "Grand Total:": "1918 191619:", "Balance Due:": "1016191419 191619:", "Thank you for your business!": "1416 1910 19191912101919 1919 1219191413!", "Bill/Invoice": "1018/191012191811", "Bill": "1018", "Invoice": "191012191811", "Info": "19171812191912", "Select a product from the table first, then click the '94' icon to adjust its stock.": "10191913 191919 16131810 11141018 1110 191419 161912161911 1910121610 1919141612 161019 1911 1919 1911111919 191416141111 19191010 1910 181410 '94' 1418141910 1619 191819 1919141612", "Settings saved successfully.": "111411101510 19191914191014 1110 1915151216 1312 1518141612"
            }
        };

        function getLang(key) {
            return translations[currentLanguage]?.[key] || translations['en']?.[key] || key;
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('khataLanguage', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ur' ? 'rtl' : 'ltr';

            document.querySelectorAll('[data-en]').forEach(el => {
                const key = el.dataset.en;
                if (el.matches('input[placeholder], textarea[placeholder]')) el.placeholder = getLang(key);
                else if (el.tagName === 'OPTION') {
                    const optKey = el.dataset.en || el.value;
                    el.textContent = getLang(optKey);
                }
                else el.textContent = getLang(key);
            });
            const activePage = document.querySelector('.page.active')?.id || 'dashboard-page';
            switchPage(activePage);
        }

        async function updateDashboard() {
            const customers = await getAllObjects(STORES.CUSTOMERS);
            const suppliers = await getAllObjects(STORES.SUPPLIERS);
            const products = await getAllObjects(STORES.PRODUCTS);

            document.getElementById('total-customers').textContent = customers.length;

            let totalReceivables = customers.reduce((sum, c) => sum + (c.balance > 0 ? c.balance : 0), 0);
            let totalPayables = suppliers.reduce((sum, s) => sum + (s.balance < 0 ? Math.abs(s.balance) : 0), 0);

            document.getElementById('total-receivables').textContent = formatCurrency(totalReceivables);
            document.getElementById('total-payables').textContent = formatCurrency(totalPayables);

            const lowStockCount = products.filter(p => p.quantity > 0 && p.quantity <= p.lowStockThreshold).length;
            document.getElementById('low-stock-items').textContent = lowStockCount;

            const inventoryValue = products.reduce((sum, p) => sum + (p.purchasePrice * p.quantity), 0);
            document.getElementById('inventory-value').textContent = formatCurrency(inventoryValue);
        }

        // --- SALE & PURCHASE LOGIC ---
        // Sale Functions
        async function openSaleModal() {
            saleItems = [];
            document.getElementById('sale-form').reset();
            const customerSelect = document.getElementById('sale-customer');
            customerSelect.innerHTML = `<option value="">${getLang('Paid (Cash Sale)')}</option>`;
            const customers = await getAllObjects(STORES.CUSTOMERS);
            customers.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            
            const productSelect = document.getElementById('sale-product-select');
            productSelect.innerHTML = `<option value="">Select a Product</option>`;
            const products = await getAllObjects(STORES.PRODUCTS);
            products.filter(p => p.quantity > 0).sort((a,b) => a.name.localeCompare(b.name)).forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.quantity})</option>`);
            
            document.getElementById('sale-date').valueAsDate = new Date();
            document.getElementById('sale-amount-paid-div').style.display = 'none';
            renderSaleItems();
            openModal('sale-form-modal');
        }

        async function addSaleItem() {
            const productId = parseInt(document.getElementById('sale-product-select').value);
            if (!productId) { customAlert('Please select a product.'); return; }
            const product = await getObject(STORES.PRODUCTS, productId);
            const qty = parseInt(document.getElementById('sale-item-qty').value);
            if (!qty || qty <= 0) { customAlert('Invalid quantity.'); return; }
            
            const existingItem = saleItems.find(item => item.productId === product.id);
            const currentStock = product.quantity;
            const quantityInCart = existingItem ? existingItem.quantity : 0;
            if (quantityInCart + qty > currentStock) {
                customAlert(`Not enough stock. Only ${currentStock - quantityInCart} more available.`); return;
            }

            if(existingItem) {
                existingItem.quantity += qty;
            } else {
                 saleItems.push({ productId: product.id, name: product.name, quantity: qty, price: product.salePrice });
            }
            renderSaleItems();
            document.getElementById('sale-product-select').value = '';
            document.getElementById('sale-item-qty').value = 1;
        }

        function renderSaleItems() {
            const body = document.getElementById('sale-items-table-body');
            let total = saleItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            body.innerHTML = saleItems.map((item, index) => {
                return `<tr>
                    <td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(item.quantity * item.price)}</td>
                    <td><button type="button" class="btn btn-danger btn-icon" onclick="removeSaleItem(${index})">X</button></td>
                </tr>`;
            }).join('');
            document.getElementById('sale-total-amount').textContent = formatCurrency(total);
        }

        function removeSaleItem(index) {
            saleItems.splice(index, 1);
            renderSaleItems();
        }

        async function completeSale(e) {
            e.preventDefault();
            if (saleItems.length === 0) { customAlert(getLang("Please add items to the sale.")); return; }
            const customerId = parseInt(document.getElementById('sale-customer').value) || null;
            const paymentStatus = document.getElementById('sale-payment-status').value;
            const amountPaid = parseFloat(document.getElementById('sale-amount-paid').value) || 0;
            const totalAmount = saleItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            if (paymentStatus === 'credit' && !customerId) { customAlert(getLang("Selected customer is required for credit sales.")); return; }
            if (paymentStatus === 'partially_paid' && !customerId) { customAlert(getLang("Selected customer is required for partial sales.")); return; }
            if (paymentStatus === 'partially_paid' && amountPaid >= totalAmount) { customAlert("Amount paid cannot be equal to or greater than total for a partial payment."); return;}
            if (paymentStatus === 'partially_paid' && amountPaid <= 0) { customAlert("Amount paid must be greater than zero for a partial payment."); return;}

            const allStoreNames = Object.values(STORES);
            const transaction = db.transaction(allStoreNames, 'readwrite');
            try {
                const saleData = { customerId, date: document.getElementById('sale-date').value, totalAmount, paymentStatus, amountPaid };
                const saleId = await addObject(STORES.SALES, saleData, transaction);
                
                for (const item of saleItems) {
                    await addObject(STORES.SALE_ITEMS, { saleId, productId: item.productId, quantity: item.quantity, unitPrice: item.price }, transaction);
                    const product = await getObject(STORES.PRODUCTS, item.productId, transaction);
                    product.quantity -= item.quantity;
                    await updateObject(STORES.PRODUCTS, product, transaction);
                }
                
                let creditAmount = 0;
                if (paymentStatus === 'credit') { creditAmount = totalAmount; }
                else if (paymentStatus === 'partially_paid') { creditAmount = totalAmount - amountPaid; }
                
                if (creditAmount > 0) {
                    await addObject(STORES.TRANSACTIONS, { entityId: customerId, entityType: 'customer', date: document.getElementById('sale-date').value, type: 'debit', amount: creditAmount, description: `Sale Invoice #${saleId}` }, transaction);
                    await updateEntityBalance(customerId, 'customer', transaction);
                }

                await promise(transaction.done);
                customAlert(getLang("Sale completed successfully."), getLang("Success"));
                closeModal('sale-form-modal');
                await loadSales(); await updateDashboard(); await loadProducts();
            } catch(err) {
                transaction.abort(); console.error(err); customAlert(`Sale failed: ${err.message}`, 'Error');
            }
        }

        async function loadSales() {
             const sales = await getAllObjects(STORES.SALES);
             sales.sort((a,b) => new Date(b.date) - new Date(a.date));
             const body = document.getElementById('sales-table-body');
             body.innerHTML = '';
             for(const sale of sales) {
                 let customerName = getLang('Paid (Cash Sale)');
                 if(sale.customerId) {
                     const customer = await getObject(STORES.CUSTOMERS, sale.customerId);
                     customerName = customer ? customer.name : 'Deleted Customer';
                 }
                 let statusText = getLang(sale.paymentStatus);
                 if (sale.paymentStatus === 'partially_paid') {
                     statusText += ` (${formatCurrency(sale.amountPaid)} Paid)`;
                 }
                 body.insertRow().innerHTML = `
                    <td>${formatDate(sale.date)}</td> <td>${customerName}</td> <td>${formatCurrency(sale.totalAmount)}</td>
                    <td>${statusText}</td>
                    <td class="no-print"><button class="btn btn-info btn-icon" onclick="showTransactionDetails('sale', ${sale.id})">90</button></td>`;
             }
        }

        // Purchase Functions
        async function openPurchaseModal() {
            purchaseItems = [];
            document.getElementById('purchase-form').reset();
            const supplierSelect = document.getElementById('purchase-supplier');
            supplierSelect.innerHTML = `<option value="">Select a Supplier</option>`;
            const suppliers = await getAllObjects(STORES.SUPPLIERS);
            suppliers.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            
            const productSelect = document.getElementById('purchase-product-select');
            productSelect.innerHTML = `<option value="">Select a Product</option>`;
            const products = await getAllObjects(STORES.PRODUCTS);
            products.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`);

            document.getElementById('purchase-date').valueAsDate = new Date();
            document.getElementById('purchase-amount-paid-div').style.display = 'none';
            renderPurchaseItems();
            openModal('purchase-form-modal');
        }

        async function addPurchaseItem() {
            const productId = parseInt(document.getElementById('purchase-product-select').value);
            if (!productId) { customAlert('Please select a product.'); return; }
            const product = await getObject(STORES.PRODUCTS, productId);

            const qty = parseInt(document.getElementById('purchase-item-qty').value);
            let price = parseFloat(document.getElementById('purchase-item-price').value);
            
            if (!qty || qty <= 0) { customAlert('Invalid quantity.'); return; }
            if (isNaN(price) || price < 0) {
                price = product.purchasePrice || 0;
                document.getElementById('purchase-item-price').value = price;
            }

            const existingItem = purchaseItems.find(item => item.productId === product.id);
            if(existingItem) existingItem.quantity += qty;
            else purchaseItems.push({ productId: product.id, name: product.name, quantity: qty, price });
            
            renderPurchaseItems();
            document.getElementById('purchase-product-select').value = '';
            document.getElementById('purchase-item-qty').value = 1;
            document.getElementById('purchase-item-price').value = '';
        }

        function renderPurchaseItems() {
             const body = document.getElementById('purchase-items-table-body');
            let total = purchaseItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            body.innerHTML = purchaseItems.map((item, index) => {
                return `<tr>
                    <td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(item.quantity * item.price)}</td>
                    <td><button type="button" class="btn btn-danger btn-icon" onclick="removePurchaseItem(${index})">X</button></td>
                </tr>`;
            }).join('');
            document.getElementById('purchase-total-amount').textContent = formatCurrency(total);
        }

        function removePurchaseItem(index) {
             purchaseItems.splice(index, 1);
            renderPurchaseItems();
        }

        async function completePurchase(e) {
            e.preventDefault();
            if (purchaseItems.length === 0) { customAlert(getLang("Please add items to the purchase.")); return; }
            const supplierId = parseInt(document.getElementById('purchase-supplier').value);
            if(!supplierId) { customAlert("Please select a supplier."); return; }
            const paymentStatus = document.getElementById('purchase-payment-status').value;
            const amountPaid = parseFloat(document.getElementById('purchase-amount-paid').value) || 0;
            const totalAmount = purchaseItems.reduce((sum, item) => sum + (item.quantity * item.price), 0);

            if (paymentStatus === 'partially_paid' && amountPaid >= totalAmount) { customAlert("Amount paid cannot be equal to or greater than total for a partial payment."); return;}
            if (paymentStatus === 'partially_paid' && amountPaid <= 0) { customAlert("Amount paid must be greater than zero for a partial payment."); return;}

            const allStoreNames = Object.values(STORES);
            const transaction = db.transaction(allStoreNames, 'readwrite');
             try {
                const purchaseData = { supplierId, date: document.getElementById('purchase-date').value, totalAmount, paymentStatus, amountPaid };
                const purchaseId = await addObject(STORES.PURCHASES, purchaseData, transaction);
                
                for (const item of purchaseItems) {
                    await addObject(STORES.PURCHASE_ITEMS, { purchaseId, productId: item.productId, quantity: item.quantity, unitPrice: item.price }, transaction);
                    const product = await getObject(STORES.PRODUCTS, item.productId, transaction);
                    product.quantity += item.quantity;
                    product.purchasePrice = item.price;
                    await updateObject(STORES.PRODUCTS, product, transaction);
                }

                let creditAmount = 0;
                if (paymentStatus === 'credit') { creditAmount = totalAmount; }
                else if (paymentStatus === 'partially_paid') { creditAmount = totalAmount - amountPaid; }

                if (creditAmount > 0) {
                    await addObject(STORES.TRANSACTIONS, { entityId: supplierId, entityType: 'supplier', date: document.getElementById('purchase-date').value, type: 'credit', amount: creditAmount, description: `Purchase #${purchaseId}`}, transaction);
                    await updateEntityBalance(supplierId, 'supplier', transaction);
                }
                
                await promise(transaction.done);
                customAlert(getLang("Purchase completed successfully."), getLang("Success"));
                closeModal('purchase-form-modal');
                await loadPurchases(); await updateDashboard(); await loadProducts();
            } catch(err) {
                transaction.abort(); console.error(err); customAlert(`Purchase failed: ${err.message}`, 'Error');
            }
        }

        async function loadPurchases() {
             const purchases = await getAllObjects(STORES.PURCHASES);
             purchases.sort((a,b) => new Date(b.date) - new Date(a.date));
             const body = document.getElementById('purchases-table-body');
             body.innerHTML = '';
             for(const purchase of purchases) {
                 const supplier = await getObject(STORES.SUPPLIERS, purchase.supplierId);
                 const supplierName = supplier ? supplier.name : 'Deleted Supplier';
                 let statusText = getLang(purchase.paymentStatus);
                 if (purchase.paymentStatus === 'partially_paid') {
                     statusText += ` (${formatCurrency(purchase.amountPaid)} Paid)`;
                 }
                 body.insertRow().innerHTML = `
                    <td>${formatDate(purchase.date)}</td><td>${supplierName}</td><td>${formatCurrency(purchase.totalAmount)}</td>
                    <td>${statusText}</td>
                    <td class="no-print"><button class="btn btn-info btn-icon" onclick="showTransactionDetails('purchase', ${purchase.id})">90</button></td>`;
             }
        }

        async function showTransactionDetails(type, id) {
            detailModalTransactionType = type; // Store type for print/delete buttons
            const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
            const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
            const transaction = await getObject(storeName, id);
            if (!transaction) { customAlert(`${type} not found.`, "Error"); return; }

            const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entityIdField = type === 'sale' ? 'customerId' : 'supplierId';
            const entity = transaction[entityIdField] ? await getObject(entityStoreName, transaction[entityIdField]) : null;
            const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});

            document.getElementById('transaction-details-title').textContent = getLang(`${type === 'sale' ? 'Sale' : 'Purchase'} Details`);
            document.getElementById('detail-date').textContent = formatDate(transaction.date);
            document.getElementById('detail-entity').textContent = entity ? entity.name : (type === 'sale' ? getLang('Cash Sale') : 'N/A');
            document.getElementById('detail-total-amount').textContent = formatCurrency(transaction.totalAmount);
            document.getElementById('detail-payment-status').textContent = getLang(transaction.paymentStatus);

            const amountPaidRow = document.getElementById('detail-amount-paid-row');
            const balanceDueLine = document.getElementById('print-balance-due-line'); // This is also used in the modal for consistency
            if (transaction.paymentStatus === 'partially_paid') {
                amountPaidRow.style.display = 'block';
                document.getElementById('detail-amount-paid').textContent = formatCurrency(transaction.amountPaid);
                // In modal, show balance due as well
                const balanceDue = transaction.totalAmount - transaction.amountPaid;
                balanceDueLine.style.display = 'block';
                document.getElementById('print-balance-due').textContent = formatCurrency(balanceDue);
            } else {
                amountPaidRow.style.display = 'none';
                balanceDueLine.style.display = 'none';
            }

            const itemsTableBody = document.getElementById('detail-items-table-body');
            itemsTableBody.innerHTML = items.map(item => `
                <tr>
                    <td>${products[item.productId]?.name || 'Deleted Product'}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.quantity * item.unitPrice)}</td>
                </tr>
            `).join('');

            // Set data for delete/return buttons on the modal
            document.getElementById('delete-sale-purchase-btn').onclick = () => confirmDeleteSaleOrPurchase(type, id);
            const processReturnBtn = document.getElementById('process-return-btn');
            processReturnBtn.style.display = (type === 'sale' || type === 'purchase') ? 'inline-block' : 'none'; // Only show for sale/purchase
            processReturnBtn.onclick = () => openReturnModal(type, id);

            openModal('transaction-details-modal');
        }

        async function confirmDeleteSaleOrPurchase(type, id) {
            customConfirm(getLang("Are you sure you want to delete this sale/purchase? This will revert stock and Khata entries."), getLang("Confirm Deletion"), async () => {
                const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
                const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
                const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
                const transactionData = await getObject(storeName, id);
                if (!transactionData) { customAlert(`${type} not found.`, "Error"); return; }
                const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);

                const allStoreNames = Object.values(STORES); // All relevant stores for a single transaction
                const dbTx = db.transaction(allStoreNames, 'readwrite');
                try {
                    // 1. Revert stock
                    for (const item of items) {
                        const product = await getObject(STORES.PRODUCTS, item.productId, dbTx);
                        if (!product) { console.warn(`Product ID ${item.productId} not found for item in ${type} ${id}. Skipping stock revert.`); continue; }
                        if (type === 'sale') { product.quantity += item.quantity; } // Sale: increase stock
                        else if (type === 'purchase') { product.quantity -= item.quantity; } // Purchase: decrease stock
                        await updateObject(STORES.PRODUCTS, product, dbTx);
                    }

                    // 2. Revert Khata entry (if applicable)
                    let associatedTransaction = null;
                    if (transactionData.paymentStatus === 'credit' || transactionData.paymentStatus === 'partially_paid') {
                        const entityId = type === 'sale' ? transactionData.customerId : transactionData.supplierId;
                        const expectedDescription = (type === 'sale' ? `Sale Invoice #${id}` : `Purchase #${id}`);
                        const entityTransactions = await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, type === 'sale' ? 'customer' : 'supplier']), dbTx);
                        // Find the specific transaction record that corresponds to this sale/purchase
                        associatedTransaction = entityTransactions.find(tx => tx.description === expectedDescription && tx.amount === (transactionData.totalAmount - (transactionData.amountPaid || 0)));
                        if (associatedTransaction) {
                            await deleteObject(STORES.TRANSACTIONS, associatedTransaction.id, dbTx);
                            await updateEntityBalance(entityId, type === 'sale' ? 'customer' : 'supplier', dbTx);
                        } else {
                            console.warn(`Associated Khata transaction not found for ${type} ${id}. Khata balance might need manual adjustment.`);
                        }
                    }

                    // 3. Delete sale/purchase items
                    for (const item of items) {
                        await deleteObject(itemStoreName, item.id, dbTx);
                    }

                    // 4. Delete sale/purchase record itself
                    await deleteObject(storeName, id, dbTx);

                    await promise(dbTx.done);
                    customAlert(getLang("Sale/Purchase deleted successfully."), getLang("Deleted"));
                    closeModal('transaction-details-modal');
                    if (type === 'sale') await loadSales();
                    else await loadPurchases();
                    await updateDashboard(); await loadProducts(); // Refresh dashboard and product list
                } catch (err) {
                    dbTx.abort(); customAlert(`Deletion failed: ${err.message}`, "Error");
                }
            });
        }

        async function openReturnModal(type, id) {
            const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
            const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
            const transaction = await getObject(storeName, id);
            if (!transaction) { customAlert(`${type} not found.`, "Error"); return; }
            
            // Set global data for processing return
            window._returnTransaction = transaction; // Store the full transaction object
            window._returnType = type; // 'sale' or 'purchase'

            const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entityIdField = type === 'sale' ? 'customerId' : 'supplierId';
            const entity = transaction[entityIdField] ? await getObject(entityStoreName, transaction[entityIdField]) : null;
            const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});

            document.getElementById('return-modal-title').textContent = getLang(type === 'sale' ? 'Refund/Return' : 'Supplier Return');
            document.getElementById('return-transaction-id').textContent = id;
            document.getElementById('return-entity-name').textContent = entity ? entity.name : (type === 'sale' ? getLang('Cash Sale') : 'N/A');
            document.getElementById('return-original-amount').textContent = formatCurrency(transaction.totalAmount);
            document.getElementById('return-refund-amount').value = '0.00';
            document.getElementById('return-notes').value = '';

            const returnItemsTableBody = document.getElementById('return-items-table-body');
            returnItemsTableBody.innerHTML = items.map(item => `
                <tr>
                    <td>${products[item.productId]?.name || 'Deleted Product'}</td>
                    <td>${item.quantity}</td>
                    <td><input type="number" data-product-id="${item.productId}" data-original-price="${item.unitPrice}" data-max-qty="${item.quantity}" class="ledger-input return-qty-input" value="0" min="0" max="${item.quantity}" style="width: 80px;"></td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                </tr>
            `).join('');

            // Add event listeners for quantity inputs to update refund amount
            returnItemsTableBody.querySelectorAll('.return-qty-input').forEach(input => {
                input.addEventListener('input', calculateReturnRefundAmount);
            });
            calculateReturnRefundAmount(); // Initial calculation

            openModal('return-modal');
        }

        function calculateReturnRefundAmount() {
            let refundAmount = 0;
            document.querySelectorAll('#return-items-table-body .return-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.originalPrice) || 0;
                const maxQty = parseInt(input.dataset.maxQty) || 0;

                if (qty > maxQty) {
                    input.value = maxQty; // Cap at max quantity
                    refundAmount += maxQty * price;
                } else {
                    refundAmount += qty * price;
                }
            });
            document.getElementById('return-refund-amount').value = refundAmount.toFixed(2);
        }

        async function confirmProcessReturn() {
            const transaction = window._returnTransaction; // Original sale/purchase object
            const type = window._returnType; // 'sale' or 'purchase'
            const returnNotes = document.getElementById('return-notes').value.trim();
            const refundAmount = parseFloat(document.getElementById('return-refund-amount').value);

            if (!returnNotes) { customAlert(getLang("Please enter a reason for the return."), "Error"); return; }
            if (refundAmount <= 0) { customAlert(getLang("Cannot process return for zero quantity."), "Error"); return; }

            const itemsToReturn = [];
            document.querySelectorAll('#return-items-table-body .return-qty-input').forEach(input => {
                const productId = parseInt(input.dataset.productId);
                const qty = parseInt(input.value) || 0;
                const originalPrice = parseFloat(input.dataset.originalPrice) || 0;
                if (qty > 0) {
                    itemsToReturn.push({ productId, quantity: qty, unitPrice: originalPrice });
                }
            });

            if (itemsToReturn.length === 0) { customAlert(getLang("Please select at least one item to return."), "Error"); return; }


            const allStoreNames = Object.values(STORES);
            const dbTx = db.transaction(allStoreNames, 'readwrite');
            try {
                // 1. Update stock
                for (const item of itemsToReturn) {
                    const product = await getObject(STORES.PRODUCTS, item.productId, dbTx);
                    if (!product) { console.warn(`Product ID ${item.productId} not found for return. Skipping stock update.`); continue; }
                    if (type === 'sale') { product.quantity += item.quantity; } // Sale return: increase stock
                    else if (type === 'purchase') { product.quantity -= item.quantity; } // Purchase return: decrease stock
                    await updateObject(STORES.PRODUCTS, product, dbTx);
                }

                // 2. Create a new Khata transaction for the return
                const entityId = type === 'sale' ? transaction.customerId : transaction.supplierId;
                const entityType = type === 'sale' ? 'customer' : 'supplier';
                const khataTxType = type === 'sale' ? 'credit' : 'debit'; // Sale refund is a credit to customer; Purchase return is a debit to supplier

                await addObject(STORES.TRANSACTIONS, {
                    entityId, entityType, date: new Date().toISOString().split('T')[0], type: khataTxType,
                    amount: refundAmount, description: `${getLang(type === 'sale' ? 'Refund/Return' : 'Supplier Return')} for ${type} #${transaction.id}: ${returnNotes}`
                }, dbTx);
                await updateEntityBalance(entityId, entityType, dbTx);

                // No need to modify the original sale/purchase record, as this is a separate return transaction.
                // You could add a 'returns' array to the original record if you wanted to track them explicitly on the original.
                
                await promise(dbTx.done);
                customAlert(getLang("Return processed successfully."), getLang("Success"));
                closeModal('return-modal');
                closeModal('transaction-details-modal'); // Close original details modal
                // Refresh relevant lists
                if (type === 'sale') await loadSales();
                else await loadPurchases();
                await updateDashboard(); await loadProducts(); // Refresh dashboard and product list
            } catch (err) {
                dbTx.abort(); customAlert(`Return failed: ${err.message}`, "Error");
            }
        }


        // --- Backup & Restore ---
        async function backupData() {
            customAlert(getLang("Generating backup..."), "In Progress");
            try {
                const backup = { version: DB_VERSION, backupDate: new Date().toISOString() };
                for (const storeName of Object.values(STORES)) {
                    backup[storeName] = await getAllObjects(storeName);
                }

                const jsonString = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ShopBackup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                closeModal('alert-modal');
                customAlert('Backup successful!', 'Success');
            } catch (error) {
                 closeModal('alert-modal'); customAlert(`Backup failed: ${error.message}`, 'Error');
            }
        }

        function handleRestoreFile(event) {
             const file = event.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!backupData.version || !backupData.customers) throw new Error("Invalid backup file format.");
                    customConfirm("This will overwrite ALL existing data. Are you sure?", "Confirm Restore",
                        () => restoreData(backupData),
                        () => event.target.value = ''
                    );
                } catch(err) { customAlert(`Error reading file: ${err.message}`, 'Error'); }
             };
             reader.readAsText(file);
        }

        async function restoreData(backupData) {
            customAlert("Restoring... please wait.", "In Progress");
            const transaction = db.transaction(Object.values(STORES), 'readwrite');
            try {
                for (const storeName of Object.values(STORES)) {
                    await promise(transaction.objectStore(storeName).clear());
                    if (backupData[storeName]) {
                        for (const obj of backupData[storeName]) {
                            await promise(transaction.objectStore(storeName).add(obj));
                        }
                    }
                }
                await promise(transaction.done);
                closeModal('alert-modal');
                customAlert("Restore complete! The page will now reload.", "Success");
                setTimeout(() => window.location.reload(), 1500);
            } catch(error) {
                transaction.abort(); closeModal('alert-modal'); customAlert(`Restore failed: ${error.message}`, 'Error');
            }
        }

        // --- Reports Module ---
        async function handleReportTypeChange() {
            const reportType = document.getElementById('report-type-select').value;
            const entitySelectorDiv = document.getElementById('report-entity-selector-div');
            const entitySelect = document.getElementById('report-entity-select');
            
            if (reportType === 'customer_ledger' || reportType === 'supplier_ledger') {
                const entityType = reportType.split('_')[0]; // 'customer' or 'supplier'
                const storeName = entityType === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
                const entities = await getAllObjects(storeName);
                entitySelect.innerHTML = `<option value="">Select a ${entityType}</option>`;
                entities.sort((a, b) => a.name.localeCompare(b.name)).forEach(e => {
                    entitySelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
                });
                entitySelectorDiv.style.display = 'block';
            } else {
                entitySelectorDiv.style.display = 'none';
            }
        }

        async function generateReport() {
            const reportType = document.getElementById('report-type-select').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const outputDiv = document.getElementById('report-output');
            outputDiv.innerHTML = '<em>Generating...</em>';
            
            let reportData;
            try {
                switch(reportType) {
                    case 'sales': reportData = await generateSalesReport(startDate, endDate); break;
                    case 'purchases': reportData = await generatePurchaseReport(startDate, endDate); break;
                    case 'profit_loss': reportData = await generateProfitLossReport(startDate, endDate); break;
                    case 'inventory': reportData = await generateInventoryReport(); break;
                    case 'customer_ledger': 
                    case 'supplier_ledger': 
                        const entityId = parseInt(document.getElementById('report-entity-select').value);
                        if (!entityId) { throw new Error('Please select an entity.'); }
                        reportData = await generateEntityLedger(reportType.split('_')[0], entityId, startDate, endDate); 
                        break;
                    default: throw new Error("Unknown report type.");
                }
                
                displayReport(reportData);
                currentReportData = reportData; // Save for export/print
                document.getElementById('print-report-btn').disabled = false;
                document.getElementById('export-csv-btn').disabled = false;

            } catch(err) {
                outputDiv.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
                document.getElementById('print-report-btn').disabled = true;
                document.getElementById('export-csv-btn').disabled = true;
            }
        }

        function displayReport(data) {
            const outputDiv = document.getElementById('report-output');
            let tableHTML = `<h3 data-en="${data.title}">${getLang(data.title)}</h3>`;
            if (data.period) {
                tableHTML += `<p style="text-align:center;">${data.period}</p>`;
            }
            tableHTML += `<table class="data-table"><thead><tr>${data.headers.map(h => `<th>${getLang(h)}</th>`).join('')}</tr></thead><tbody>`;
            tableHTML += data.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
            tableHTML += `</tbody></table>`;
            if(data.summary) {
                tableHTML += `<div style="text-align:right; margin-top:15px; font-weight:bold;">${data.summary}</div>`;
            }
            outputDiv.innerHTML = tableHTML;
        }

        function printReport() {
            if (!currentReportData) return;
            document.getElementById('printable-report-title').textContent = getLang(currentReportData.title);
            document.getElementById('printable-report-period').textContent = currentReportData.period || '';
            const tableClone = document.getElementById('report-output').querySelector('.data-table').cloneNode(true);
            const summaryClone = document.getElementById('report-output').querySelector('div[style*="text-align:right"]')?.cloneNode(true);
            
            const printableTableDiv = document.getElementById('printable-report-table');
            printableTableDiv.innerHTML = '';
            printableTableDiv.appendChild(tableClone);
            
            const printableSummaryDiv = document.getElementById('printable-report-summary');
            printableSummaryDiv.innerHTML = '';
            if (summaryClone) printableSummaryDiv.appendChild(summaryClone);

            const mainAppContainer = document.querySelector('.container');
            mainAppContainer.style.display = 'none';
            document.getElementById('printable-report-content').style.display = 'block';
            window.print();
            mainAppContainer.style.display = 'flex';
            document.getElementById('printable-report-content').style.display = 'none';
        }

        function exportReportToCSV() {
            if (!currentReportData) return;
            const { headers, rows, title } = currentReportData;
            let csvContent = '\uFEFF'; // BOM for Excel
            csvContent += headers.map(h => `"${getLang(h).replace(/"/g, '""')}"`).join(',') + '\r\n';
            rows.forEach(row => {
                const cleanRow = row.map(cell => `"${String(cell).replace(/<[^>]*>/g, '').replace(/"/g, '""')}"`);
                csvContent += cleanRow.join(',') + '\r\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const filename = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generateSalesReport(startDate, endDate) {
            let sales = await getAllObjects(STORES.SALES);
            if(startDate) sales = sales.filter(s => s.date >= startDate);
            if(endDate) sales = sales.filter(s => s.date <= endDate);
            sales.sort((a,b) => new Date(a.date) - new Date(b.date));

            const customers = (await getAllObjects(STORES.CUSTOMERS)).reduce((map, c) => (map[c.id] = c.name, map), {});
            let total = 0;
            const rows = sales.map(s => {
                total += s.totalAmount;
                return [ formatDate(s.date), s.customerId ? customers[s.customerId] || 'Deleted' : getLang('Paid (Cash Sale)'),
                    formatCurrency(s.totalAmount), getLang(s.paymentStatus) ];
            });
            return { title: 'Sales Report', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Customer', 'Amount', 'Status'], rows: rows, summary: `<strong>Total Sales:</strong> ${formatCurrency(total)}` };
        }

        async function generatePurchaseReport(startDate, endDate) {
            let purchases = await getAllObjects(STORES.PURCHASES);
            if(startDate) purchases = purchases.filter(p => p.date >= startDate);
            if(endDate) purchases = purchases.filter(p => p.date <= endDate);
            purchases.sort((a,b) => new Date(a.date) - new Date(b.date));

            const suppliers = (await getAllObjects(STORES.SUPPLIERS)).reduce((map, s) => (map[s.id] = s.name, map), {});
            let total = 0;
            const rows = purchases.map(p => {
                total += p.totalAmount;
                return [ formatDate(p.date), suppliers[p.supplierId] || 'Deleted', formatCurrency(p.totalAmount), getLang(p.paymentStatus) ];
            });
            return { title: 'Purchase Report', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Supplier', 'Amount', 'Status'], rows: rows, summary: `<strong>Total Purchases:</strong> ${formatCurrency(total)}` };
        }
        
        async function generateProfitLossReport(startDate, endDate) {
            let sales = await getAllObjects(STORES.SALES);
            if(startDate) sales = sales.filter(s => s.date >= startDate);
            if(endDate) sales = sales.filter(s => s.date <= endDate);

            let totalRevenue = 0, totalCost = 0;
            const rows = [];
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});

            for (const sale of sales) {
                const saleItems = await getAllObjects(STORES.SALE_ITEMS, 'saleId', sale.id);
                for(const item of saleItems) {
                    const product = products[item.productId];
                    const cost = (product ? product.purchasePrice : 0) * item.quantity;
                    const revenue = item.unitPrice * item.quantity;
                    const profit = revenue - cost;
                    totalRevenue += revenue; totalCost += cost;
                    rows.push([ formatDate(sale.date), product ? product.name : 'Deleted Product', item.quantity,
                        formatCurrency(revenue), formatCurrency(cost), formatCurrency(profit) ]);
                }
            }
            return { title: 'Profit & Loss Report', period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Product', 'Qty Sold', 'Revenue', 'Cost', 'Profit'], rows: rows,
                summary: `<strong>Total Revenue:</strong> ${formatCurrency(totalRevenue)} | <strong>Total Cost:</strong> ${formatCurrency(totalCost)} | <strong>Total Profit:</strong> ${formatCurrency(totalRevenue - totalCost)}` };
        }

        async function generateInventoryReport() {
            const products = await getAllObjects(STORES.PRODUCTS);
            let totalValue = 0;
            const rows = products.sort((a,b) => a.name.localeCompare(b.name)).map(p => {
                const value = p.purchasePrice * p.quantity; totalValue += value;
                let status = getLang('In Stock');
                if (p.quantity <= 0) status = getLang('Out of Stock');
                else if (p.quantity <= p.lowStockThreshold) status = getLang('Low Stock');
                return [p.name, p.quantity, formatCurrency(p.purchasePrice), formatCurrency(p.salePrice), formatCurrency(value), status];
            });
            return { title: 'Inventory Report', headers: ['Product Name', 'Stock', 'Purchase Price', 'Sale Price', 'Stock Value', 'Status'],
                rows: rows, summary: `<strong>Total Inventory Value:</strong> ${formatCurrency(totalValue)}` }
        }

        async function generateEntityLedger(type, entityId, startDate, endDate) {
            const storeName = type === 'customer' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entity = await getObject(storeName, entityId);
            let allTransactions = await getTransactionsForEntity(entityId, type, startDate, endDate); // Fetch already filtered by date

            let openingBalance = 0;
            // Calculate opening balance for the filtered period by summing transactions BEFORE startDate
            if (startDate) {
                const transactionsBeforePeriod = (await getAllObjects(STORES.TRANSACTIONS, 'entityId_type', IDBKeyRange.only([entityId, type]))).filter(t => t.date < startDate);
                openingBalance = transactionsBeforePeriod.reduce((bal, tx) => bal + (tx.type === 'debit' ? tx.amount : -tx.amount), 0);
            }
            
            let currentBalance = openingBalance;
            const rows = allTransactions.map(tx => {
                const txAmount = parseFloat(tx.amount);
                currentBalance += (tx.type === 'debit' ? txAmount : -txAmount);
                return [formatDate(tx.date), tx.description, tx.type === 'debit' ? formatCurrency(tx.amount) : '-', tx.type === 'credit' ? formatCurrency(tx.amount) : '-', renderBalance(currentBalance)];
            });
            
            rows.unshift(['-', getLang('Opening Balance'), '-', '-', renderBalance(openingBalance)]);

            return { title: `${getLang(type === 'customer' ? 'Customer' : 'Supplier')} Ledger: ${entity.name}`,
                period: `From: ${startDate || 'Start'} To: ${endDate || 'Today'}`,
                headers: ['Date', 'Description', 'Debit', 'Credit', 'Balance'], rows: rows,
                summary: `<strong>Closing Balance:</strong> ${renderBalance(entity.balance)}` }
        }

        // --- Settings Logic ---
        async function loadSettings() {
            const settings = await getObject(STORES.SETTINGS, 1); // Assuming one settings record with ID 1
            if (settings) {
                document.getElementById('shop-name').value = settings.shopName || '';
                document.getElementById('shop-phone').value = settings.shopPhone || '';
                document.getElementById('shop-address').value = settings.shopAddress || '';
            } else {
                // Initialize settings with defaults if no record exists
                await addObject(STORES.SETTINGS, { id: 1, shopName: 'Your Shop', shopPhone: '', shopAddress: '' });
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            const settings = {
                id: 1,
                shopName: document.getElementById('shop-name').value.trim(),
                shopPhone: document.getElementById('shop-phone').value.trim(),
                shopAddress: document.getElementById('shop-address').value.trim()
            };
            await updateObject(STORES.SETTINGS, settings);
            customAlert(getLang("Settings saved successfully."), getLang("Success"));
            updateDashboard(); // In case shop name affects dashboard elements (e.g. reminder template)
        }

        // --- Data Export for specific stores ---
        async function exportDataToCSV(storeName) {
            try {
                const data = await getAllObjects(storeName);
                if (data.length === 0) {
                    customAlert(`No data found in ${storeName} to export.`, "Info");
                    return;
                }

                let csvContent = '\uFEFF'; // BOM
                const headers = Object.keys(data[0]); // Use keys of first object as headers
                csvContent += headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\r\n';

                data.forEach(rowObj => {
                    const row = headers.map(header => {
                        let value = rowObj[header];
                        if (typeof value === 'object' && value !== null) value = JSON.stringify(value); // Handle nested objects
                        return `"${String(value || '').replace(/"/g, '""')}"`;
                    });
                    csvContent += row.join(',') + '\r\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${storeName}_export_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                customAlert(`${storeName} data exported successfully.`, "Success");

            } catch (error) {
                customAlert(`Error exporting ${storeName} data: ${error.message}`, "Error");
            }
        }

        // --- Print Bill/Invoice ---
        async function printCurrentBillInvoice() {
            const type = detailModalTransactionType; // 'sale' or 'purchase'
            const id = parseInt(document.getElementById('transaction-details-title').textContent.match(/#(\d+)/)?.[1] || window._currentBillId); // Get ID from modal title or temp storage

            const storeName = type === 'sale' ? STORES.SALES : STORES.PURCHASES;
            const itemStoreName = type === 'sale' ? STORES.SALE_ITEMS : STORES.PURCHASE_ITEMS;
            const transactionData = await getObject(storeName, id);
            if (!transactionData) { customAlert(`${type} not found.`, "Error"); return; }

            const entityStoreName = type === 'sale' ? STORES.CUSTOMERS : STORES.SUPPLIERS;
            const entityIdField = type === 'sale' ? 'customerId' : 'supplierId';
            const entity = transactionData[entityIdField] ? await getObject(entityStoreName, transactionData[entityIdField]) : null;
            const items = await getAllObjects(itemStoreName, type === 'sale' ? 'saleId' : 'purchaseId', id);
            const products = (await getAllObjects(STORES.PRODUCTS)).reduce((map, p) => (map[p.id] = p, map), {});
            const settings = await getObject(STORES.SETTINGS, 1) || {};

            // Populate shop info
            document.getElementById('print-shop-name').textContent = settings.shopName || 'Your Shop Name';
            document.getElementById('print-shop-phone').textContent = `${getLang('Phone')}: ${settings.shopPhone || 'N/A'}`;
            document.getElementById('print-shop-address').textContent = `${getLang('Address')}: ${settings.shopAddress || 'N/A'}`;

            // Populate bill/invoice type and header info
            document.getElementById('print-bill-type').textContent = getLang(type === 'sale' ? 'Invoice' : 'Bill');
            document.getElementById('print-entity-info').innerHTML = `
                <p><strong>${getLang(type === 'sale' ? 'Customer' : 'Supplier')}:</strong> ${entity ? entity.name : (type === 'sale' ? getLang('Cash Sale') : 'N/A')}</p>
                ${entity?.phone ? `<p><strong>${getLang('Phone')}:</strong> ${entity.phone}</p>` : ''}
            `;
            document.getElementById('print-transaction-info').innerHTML = `
                <p><strong>${getLang('Date')}:</strong> ${formatDate(transactionData.date)}</p>
                <p><strong>${getLang('Bill/Invoice')} ID:</strong> ${id}</p>
            `;

            // Populate item details table
            const printItemsBody = document.getElementById('print-item-details');
            printItemsBody.innerHTML = items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${products[item.productId]?.name || 'Deleted Product'}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.quantity * item.unitPrice)}</td>
                </tr>
            `).join('');

            // Populate totals
            document.getElementById('print-grand-total').textContent = formatCurrency(transactionData.totalAmount);
            if (transactionData.paymentStatus === 'partially_paid') {
                document.getElementById('print-amount-paid-line').style.display = 'block';
                document.getElementById('print-amount-paid').textContent = formatCurrency(transactionData.amountPaid);
                const balanceDue = transactionData.totalAmount - transactionData.amountPaid;
                document.getElementById('print-balance-due-line').style.display = 'block';
                document.getElementById('print-balance-due').textContent = formatCurrency(balanceDue);
            } else {
                document.getElementById('print-amount-paid-line').style.display = 'none';
                document.getElementById('print-balance-due-line').style.display = 'none';
            }
            
            // Hide main app, show printable bill area
            const mainAppContainer = document.querySelector('.container');
            mainAppContainer.style.display = 'none';
            document.getElementById('printable-bill-invoice').style.display = 'block';
            window.print();
            mainAppContainer.style.display = 'flex';
            document.getElementById('printable-bill-invoice').style.display = 'none';
        }


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                setupEventListeners();
                setLanguage(currentLanguage); // This also loads initial data
                switchPage('dashboard-page');
                console.log("Application initialized successfully.");
            } catch (error) {
                console.error("CRITICAL: Initialization failed:", error);
                 document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;"><h1>Initialization Failed</h1><p>Could not start the application. Please ensure your browser supports IndexedDB and is not in private mode.</p><p><i>Error: ${error.message}</i></p></div>`;
            }
        });
    </script>
</body>
</html>